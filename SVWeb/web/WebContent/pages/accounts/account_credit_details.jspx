<?xml version="1.0" encoding="UTF-8"?>
<html	xmlns="http://www.w3.org/1999/xhtml"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:a4j="http://richfaces.org/a4j"
		xmlns:rich="http://richfaces.org/rich"
		xmlns:bm="http://www.bpc.ru/jsf/misc"
		xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext"
		xmlns:fmt="http://www.bpc.ru/el/formatter">
<ui:composition>
	<f:loadBundle var="lblAcc" basename="ru.bpc.sv2.ui.bundles.Acc"/>
	<f:loadBundle var="lblPrd" basename="ru.bpc.sv2.ui.bundles.Prd"/>

	<script type="text/javascript">
	//<!--
		function checkCalcInterestDates(){
			var checked = true;
			checked = checkField("accountCreditCalcInterestData:startDateInputDate");
			checked = checkField("accountCreditCalcInterestData:endDateInputDate");
			return checked;
		}
	//-->
	</script>

	<a4j:loadScript src="/js/calendarUtils.js" />
	<rich:calendar id="accountCreditTableCalendar"
				   buttonIcon="/images/calendar.gif"
				   datePattern="#{usession.datePattern}"
				   onchanged="#{rich:component('calendar')}.customInput.value=event.rich.component.getSelectedDateString();"
				   zindex="1000"
				   inputClass="hidden"
				   buttonClass="hidden" />

	<h:form id="accountCreditForm">
		<h:panelGroup id="accountCreditTableWrapper" layout="block" style="padding:0px;margin:0px;">
			<rich:extendedDataTable id="mainTable"
									headerClass="res-table-header table-header-ext"
									selectedClass="res-table-selected"
									styleClass="res-table"
									rowClasses=",odd"
									var="item"
									value="#{MbCreditAccountDetails.records}"
									selection="#{MbCreditAccountDetails.itemSelection}"
									rows="0"
									height="220px"
									selectionMode="single"
									enableContextMenu="true"
									tableState="#{MbCreditAccountDetails.tableState}"
									noDataLabel="#{lblCommon['no_records_found']}"
									onRowMouseDown="handleMouseClick(event)">
				<rich:column id="name" label="#{lblCommon.name}" title="Name"  width="42%" >
					<f:facet name="header">
						<h:panelGroup>
							<script>updateHeight();</script>
							<h:outputText value="#{lblCommon.name}" title="#{lblCommon.name}" />
						</h:panelGroup>
					</f:facet>
					<h:outputText value="#{item.name}" title="#{item.name}" />
				</rich:column>

				<rich:column id="value" label="#{lblCommon.value}" title="Value"  width="55%">
					<f:facet name="header">
						<h:outputText value="#{lblCommon.value}" title="#{lblCommon.value}" />
					</f:facet>
					<h:outputText value="#{item.value}" title="#{item.value}" />
				</rich:column>

				<f:facet name="footer" />
			</rich:extendedDataTable>
		</h:panelGroup>

		<h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
			<h:panelGroup layout="block" styleClass="bottom_search_result_left_buttons">
				<h:panelGrid styleClass="fw buttons_block" columns="2" columnClasses=", table_tools_state">
					<h:panelGroup styleClass="stdButton">
						<bre:taggedCommandButton id="accountCreditPayOffBtn"
												 value="#{lblAcc.credit_pay_off}"
												 disabled="#{MbCreditAccountDetails.noData}"
												 action="#{MbCreditAccountDetails.recalculatePayOff}"
												 rendered="#{usession.inRole['PERFORM_RECALC_PAY_OFF']}"
												 reRender="accountCreditPayOffData:payOffDataTable, accountCreditPayOffData:payOffButton"
												 oncomplete="#{rich:component('accountCreditPayOffModal')}.show()"/>
						<bre:taggedCommandButton id="restructureBtn"
												 value="#{lblAcc.restructure}"
												 disabled="#{MbCreditAccountDetails.noData}"
												 rendered="#{usession.inRole['PERFORM_DEBT_RESTRUCTING']}"
												 action="#{MbCreditAccountDetails.restructureDebt}"
												 reRender="restructureDebtwizardWindow"
												 oncomplete="if (#{usession.noErrorResponse}){Richfaces.showModalPanel('restructureDebtwizardWindow');}"/>
						<bre:taggedCommandButton id="calculateInterestBtn"
												 value="#{lblAcc.calculate_interest}"
												 disabled="#{MbCreditAccountDetails.noData}"
												 reRender="accountCreditCalcInterestData:calcInterestDataTable, accountCreditCalcInterestData:calcInterestBtn"
												 oncomplete="#{rich:component('accountCreditCalcInterestModal')}.show()"/>
					</h:panelGroup>
				</h:panelGrid>
			</h:panelGroup>
		</h:panelGroup>
	</h:form>

	<rich:modalPanel id="accountCreditPayOffModal" autosized="true" minWidth="450" minHeight="50">
		<f:facet name="header">
			<h:panelGroup>
				<h:outputText value="#{lblAcc.credit_pay_off}" />
			</h:panelGroup>
		</f:facet>
		<f:facet name="controls" />
		<h:form id="accountCreditPayOffData">
			<rich:extendedDataTable id="payOffDataTable"
									headerClass="res-table-header table-header-ext"
									selectedClass="res-table-selected"
									styleClass="res-table"
									rowClasses=",odd"
									var="payOffItem"
									value="#{MbCreditAccountDetails.payOffRecords}"
									rows="0"
									height="270px"
									width="300"
									selectionMode="single"
									enableContextMenu="true"
									noDataLabel="#{lblCommon['no_records_found']}">
				<rich:column id="name" label="#{lblCommon.name}" title="Name"  width="67%" >
					<f:facet name="header">
						<h:panelGroup>
							<script>updateHeight();</script>
							<h:outputText value="#{lblCommon.name}" title="#{lblCommon.name}" />
						</h:panelGroup>
					</f:facet>
					<h:outputText value="#{payOffItem.name}" title="#{payOffItem.name}" />
				</rich:column>

				<rich:column id="value" label="#{lblCommon.value}" title="Value"  width="33%">
					<f:facet name="header">
						<h:outputText value="#{lblCommon.value}" title="#{lblCommon.value}" />
					</f:facet>
					<h:outputText value="#{payOffItem.value}" title="#{payOffItem.value}" />
				</rich:column>
			</rich:extendedDataTable>

			<h:panelGrid width="100%" columns="3"
						 style="padding-bottom: 20px; padding-top: 5px;">
				<h:outputLabel for="calculateDate"
							   title="#{lblAcc.calculate_date}" value="#{lblAcc.calculate_date}:"/>
				<h:panelGroup layout="block">
					<h:inputText id="calculateDate"
								 style="vertical-align: middle;"
								 value="#{MbCreditAccountDetails.filter.payOffDate}"
								 reRender="calculateDate, appStatusWarningForm:appCreditPayOffWarningDate"
								 onclick="#{rich:component('accountCreditTableCalendar')}.customExpand(event,
								          #{rich:element('calculateDate')},
								          #{rich:element('calculateDateBtn')});">
						<f:convertDateTime pattern="#{usession.fullDatePattern}" timeZone="#{CommonUtils.timeZone}"/>
						<a4j:support event="onchange" ajaxSingle="true" limitToList="true" />
					</h:inputText>
					<h:graphicImage id="calculateDateBtn"
									value="/images/calendar.gif"
									onclick="#{rich:component('calendar')}.customExpand(event,
									         #{rich:element('calculateDate')},
									         #{rich:element('calculateDateBtn')});"
									style="vertical-align: middle;"/>
				</h:panelGroup>

				<bre:taggedCommandButton id="recalculateDate"
										 value="#{lblAcc.recalculate}"
										 action="#{MbCreditAccountDetails.recalculatePayOff}"
										 reRender="payOffDataTable"/>
			</h:panelGrid>

			<h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
				<h:panelGrid width="100%" columns="2" columnClasses="width400px,firstCol">
					<bre:taggedCommandButton
							id="payOffButton"
							value="#{lblAcc.pay_off}"
							type="submit"
							reRender="appStatusWarningForm:appCreditPayOffWarningDate"
							disabled="#{not MbCreditAccountDetails.payOffEnabled}"
							oncomplete="#{rich:component('accountCreditPayOffWarningWindow')}.show()"/>
					<bre:taggedCommandButton
							value="#{lblForm.close}"
							action="#{MbCreditAccountDetails.cancel}"
							immediate="true"
							limitToList="true"
							oncomplete="#{rich:component('accountCreditPayOffModal')}.hide()" />
				</h:panelGrid>
			</h:panelGroup>
		</h:form>
	</rich:modalPanel>

	<rich:modalPanel id="accountCreditPayOffWarningWindow" autosized="true" minWidth="240" minHeight="50">
		<f:facet name="header">
			<h:outputText value="#{lblCommon.warning_label}"/>
		</f:facet>
		<f:facet name="controls"/>
		<h:form id="appStatusWarningForm">
			<h:panelGroup id="appCreditPayOffWarningPanel" style="padding:0px;" layout="block">
				<h:panelGroup style="padding:10px 10px; text-align: center;" layout="block">
					<h:outputText id="appCreditPayOffWarningMessage"
								  value="#{lblAcc.warning_pay_off}"
								  style="padding:10px 10px; text-align: center;" />
					<h:outputText id="appCreditPayOffWarningDate"
								  value="#{MbCreditAccountDetails.filter.payOffDate}"
								  style="padding:10px 10px;text-align: center;">
						<f:convertDateTime pattern="#{usession.fullDatePattern}" timeZone="#{CommonUtils.timeZone}"/>
					</h:outputText>
				</h:panelGroup>

				<h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
					<h:panelGrid columns="2" columnClasses="width99P,">
						<bre:taggedCommandButton value="#{lblForm.yes}"
												 action="#{MbCreditAccountDetails.payOff}"
												 reRender="payOffDataTable"
												 oncomplete="#{rich:component('accountCreditPayOffWarningWindow')}.hide()"/>
						<bre:taggedCommandButton value="#{lblForm.no}"
												 immediate="true"
												 oncomplete="#{rich:component('accountCreditPayOffWarningWindow')}.hide()"/>
					</h:panelGrid>
				</h:panelGroup>
			</h:panelGroup>
		</h:form>
	</rich:modalPanel>

	<rich:modalPanel id="accountCreditCalcInterestModal" autosized="true" minWidth="500" minHeight="50">
		<f:facet name="header">
			<h:panelGroup>
				<h:outputText value="#{lblAcc.calculate_interest}" />
			</h:panelGroup>
		</f:facet>
		<f:facet name="controls"/>

		<h:form id="accountCreditCalcInterestData">
			<h:panelGrid width="100%" columns="3" style="padding-bottom: 20px; padding-top: 5px;">
				<h:outputLabel for="startDate"
							   title="#{lblCommon.start_date}" value="#{lblCommon.start_date}* :"
							   style="font-weight: bold;"/>
				<h:outputLabel for="endDate"
							   title="#{lblCommon.end_date}" value="#{lblCommon.end_date}* :"
							   style="font-weight: bold;"/>
				<h:outputText/>

				<rich:calendar id="startDate"
							   value="#{MbCreditAccountDetails.filter.startDate}"
							   datePattern="#{usession.datePattern}"
							   timeZone="#{CommonUtils.timeZone}"
							   inputStyle="max-width: 170px;"
							   onchanged="hideErrorField(this);"/>
				<rich:calendar id="endDate"
							   value="#{MbCreditAccountDetails.filter.endDate}"
							   datePattern="#{usession.datePattern}"
							   timeZone="#{CommonUtils.timeZone}"
							   inputStyle="max-width: 170px;"
							   onchanged="hideErrorField(this);"/>
				<bre:taggedCommandButton id="recalculateInterest"
										 value="#{lblAcc.recalculate}"
										 onclick="if (!checkCalcInterestDates()) {return false;}"
										 action="#{MbCreditAccountDetails.calculateInterest}"
										 reRender="calcInterestDataTable"/>

				<h:outputFormat id="startDateInputDateError"
								value="#{lblMsg.value_request}"
								styleClass="errorMarker"
								style="display:none;">
					<f:param name="fieldName" value="#{lblCommon.start_date}"/>
				</h:outputFormat>
				<h:outputFormat id="endDateInputDateError"
								value="#{lblMsg.value_request}"
								styleClass="errorMarker"
								style="display:none;">
					<f:param name="fieldName" value="#{lblCommon.end_date}"/>
				</h:outputFormat>
				<h:outputText/>
			</h:panelGrid>

			<rich:extendedDataTable id="calcInterestDataTable"
									headerClass="res-table-header table-header-ext"
									selectedClass="res-table-selected"
									styleClass="res-table"
									rowClasses=",odd"
									var="calculateInterestItem"
									value="#{MbCreditAccountDetails.interestRecords}"
									rows="0"
									height="270px"
									width="300"
									selectionMode="single"
									enableContextMenu="true"
									noDataLabel="#{lblCommon['no_records_found']}">
				<rich:column id="name" label="#{lblCommon.name}" title="Name"  width="67%" >
					<f:facet name="header">
						<h:panelGroup>
							<script>updateHeight();</script>
							<h:outputText value="#{lblCommon.name}" title="#{lblCommon.name}" />
						</h:panelGroup>
					</f:facet>
					<h:outputText value="#{calculateInterestItem.name}" title="#{calculateInterestItem.name}" />
				</rich:column>

				<rich:column id="value" label="#{lblCommon.value}" title="Value"  width="33%">
					<f:facet name="header">
						<h:outputText value="#{lblCommon.value}" title="#{lblCommon.value}" />
					</f:facet>
					<h:outputText value="#{calculateInterestItem.value}" title="#{calculateInterestItem.value}" />
				</rich:column>
			</rich:extendedDataTable>

			<h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
				<h:panelGrid width="100%" columns="2" columnClasses="width400px,firstCol">
					<h:outputText/>
					<bre:taggedCommandButton
							value="#{lblForm.close}"
							action="#{MbCreditAccountDetails.cancel}"
							immediate="true"
							limitToList="true"
							oncomplete="#{rich:component('accountCreditCalcInterestModal')}.hide()" />
				</h:panelGrid>
			</h:panelGroup>
		</h:form>
	</rich:modalPanel>

	<ui:include src="/pages/common/wizard/commonWizard.jspx">
		<ui:param name="bean" value="MbCreditAccountDetails" />
		<ui:param name="action" value="restructureDebt" />
		<ui:param name="reRender" value="accountCreditForm" />
		<ui:param name="viewId" value="restructureDebt" />
	</ui:include>
</ui:composition>
</html>
