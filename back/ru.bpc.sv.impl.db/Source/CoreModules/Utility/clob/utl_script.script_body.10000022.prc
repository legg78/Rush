begin merge into crd_debt_interest i using ( select i.id, i.debt_id, i.balance_type, nvl(max(e.posting_order),0) entry_posting_order, row_number() over (partition by i.debt_id order by i.debt_id, i.id desc) rn from crd_debt_interest i, crd_debt d, acc_entry e where i.debt_id = d.id and d.status  = 'DBTSACTV' and e.macros_id = i.debt_id and e.account_id = d.account_id and e.balance_type = i.balance_type group by i.id, i.debt_id, i.balance_type) p on (i.id = p.id) when matched then update set i.posting_order = ((p.entry_posting_order + 1) - p.rn); end;
