<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:bpct="http://www.bpc.ru/jsf/tiles"
      xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext"
      xmlns:rich="http://richfaces.org/rich"
      xmlns:a4j="http://richfaces.org/a4j">
    <ui:composition template="./productAppTemplate.jspx">
        <ui:define name="stepContent">
            <script type="text/javascript">
                function enableUnblockButtons() {
                    if (document.getElementById("stepPageInclude:attrsTreeForm:btn_unblock") != null) {
                        document.getElementById("stepPageInclude:attrsTreeForm:btn_unblock").disabled = false;
                    }
                }
            </script>

            <h:form id="productAppServiceTermsForm">
                <ui:include src="/pages/common/wizard/commonWizardActions.jspx">
                    <ui:param name="bean" value="#{bean}"/>
                    <ui:param name="action" value="#{action}"/>
                    <ui:param name="viewId" value="#{viewId}" />
                </ui:include>

                <h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
                    <h:panelGrid columns="2" style="width:100%" cellpadding="0" cellspacing="0" columnClasses="top width50, top width50">
                        <h:form id="attrsTreeForm" >
                            <h:panelGroup id="attrsTreeTableWrapper" layout="block"
                                          style="position: relative; zoom: 1; padding:0px;margin:0px;">
                                <o:treeTable id="attrsTreeTable" var="prodAttr"
                                             expansionState="allExpanded"
                                             sortColumnId="nodeName"
                                             headerHorizSeparator="1px solid #D7DAC2"
                                             headerVertSeparator="1px solid #D7DAC2"
                                             headerSectionClass="res-tree-table-header"
                                             commonHeaderRowClass="res-tree-table-header"
                                             sortableHeaderClass="res-tree-table-header"
                                             sortedColumnHeaderClass="res-tree-table-header"
                                             sortableHeaderRolloverClass="res-tree-table-header"
                                             styleClass="extdt-table-layout res-tree-table"
                                             bodyOddRowClass="res-tree-table-row odd-tree-table"
                                             bodyRowClass="res-tree-table-row" headerRowClass="res-tree-table-header"
                                             verticalGridLines="1px solid #D7DAC2"
                                             cellpadding="0" cellspacing="0"
                                             preloadedNodes="all"
                                             style="width:100%;height:100%;">
                                    <o:scrolling/>
                                    <o:columnResizing minColWidth="55px"/>
                                    <f:facet name="noDataMessage">
                                        <h:panelGroup>
                                            <h:outputText value="#{lblCommon['no_records_found']}"/>
                                        </h:panelGroup>
                                    </f:facet>

                                    <o:dynamicTreeStructure
                                            nodeChildren="#{MbProductAppServiceTermsDS.attributes.nodeChildren}"
                                            nodeHasChildren="#{MbProductAppServiceTermsDS.attributes.nodeHasChildren}"
                                            nodeKey="#{prodAttr.modelId}"/>

                                    <o:singleNodeSelection nodePath="#{MbProductAppServiceTermsDS.attributes.nodePath}"
                                                           nodeData="#{MbProductAppServiceTermsDS.attributes.node}"
                                                           keyboardSupport="false"
                                                           styleClass="treetable_selection">
                                        <a4j:support event="onchange"
                                                     reRender="attrValues, btnPanel, err_ajax"
                                                     limitToList="true"
                                                     oncomplete="enableUnblockButtons()"/>
                                    </o:singleNodeSelection>

                                    <o:column width="10%" style="padding:0;text-align: center">
                                        <h:graphicImage value="/images/warning_16.png"
                                                        rendered="#{prodAttr.defLevel != null and
										((MbProductAppServiceTermsDS.attributes.product and not prodAttr.defLevelProduct)
										or (MbProductAppServiceTermsDS.attributes.service and not prodAttr.defLevelService)
										or (MbProductAppServiceTermsDS.attributes.contract and not MbProductAppServiceTermsDS.attributes.currentNodeContract)
										or (MbProductAppServiceTermsDS.attributes.object and not prodAttr.defLevelObject and not prodAttr.defLevelProduct))}"
                                                        title="#{MbProductAppServiceTermsDS.attributes.attrLevelMsg}">
                                        </h:graphicImage>
                                    </o:column>

                                    <o:treeColumn id="nodeName" width="55%">
                                        <f:facet name="header">
                                            <h:panelGroup>
                                                <script>updateHeight();</script>
                                                <h:outputText value="#{lblCommonQ.name}"/>
                                            </h:panelGroup>
                                        </f:facet>
                                        <f:facet name="subHeader">
                                            <o:inputTextFilter autoFilterDelay="1000" autocomplete="true" />
                                        </f:facet>
                                        <h:outputText value="#{prodAttr.attributeName}" styleClass="treeTableText"
                                                      title="#{prodAttr.attributeName}"
                                                      rendered="#{prodAttr.systemName != null}"/>
                                        <h:outputText value="#{prodAttr.attributeName}" styleClass="treeTableText"
                                                      title="#{prodAttr.attributeName}"
                                                      rendered="#{prodAttr.systemName == null and not (MbProductAppServiceTermsDS.attributes.object or MbProductAppServiceTermsDS.attributes.contract)}" style="font-weight: bold"/>
                                        <h:outputText value="#{prodAttr.attributeName} (#{DictUtils.articles[prodAttr.serviceStatus]})" styleClass="treeTableText"
                                                      title="#{prodAttr.attributeName} (#{DictUtils.articles[prodAttr.serviceStatus]})"
                                                      rendered="#{prodAttr.systemName == null and (MbProductAppServiceTermsDS.attributes.object or MbProductAppServiceTermsDS.attributes.contract)}" style="font-weight: bold"/>
                                    </o:treeColumn>

                                    <o:column id="scale" width="15%">
                                        <f:facet name="header">
                                            <h:outputText value="#{lblAcqQ.scale}"/>
                                        </f:facet>
                                        <h:outputText value="#{prodAttr.scaleName}" title="#{prodAttr.scaleName}"  styleClass="res-tree-table-cell"/>
                                    </o:column>
                                    <o:column width="10%" style="padding:0;text-align: center" rendered="#{show_buttom_change_visibility}">
                                        <f:facet name="header">
                                            <h:outputText value="#{lblPrd.visible}" title="#{lblPrd.visible}"/>
                                        </f:facet>
                                        <h:selectBooleanCheckbox value="#{prodAttr.visible}" disabled="true"/>
                                    </o:column>

                                    <o:column width="15%" id="current_value">
                                        <f:facet name="header">
                                            <h:outputText value="#{lblCommon.current_value}" title="#{lblCommon.current_value}"/>
                                        </f:facet>
                                        <h:outputText value="#{prodAttr.value}" title="#{prodAttr.value}" styleClass="res-tree-table-cell" rendered="#{prodAttr.value != null}" />
                                        <h:outputText value="&#160;" title="&#160;" styleClass="res-tree-table-cell" rendered="#{prodAttr.value == null and prodAttr.attrEntityType != null}" />
                                        <h:panelGroup rendered="#{prodAttr.value == null and prodAttr.attrEntityType == null}}">
                                            <h:outputText value="#{prodAttr.valueV}" title="#{prodAttr.valueV}" rendered="#{prodAttr.dataType == 'DTTPCHAR'}" styleClass="res-tree-table-cell" />
                                            <h:outputText value="#{prodAttr.valueN}" title="#{prodAttr.valueN}" rendered="#{prodAttr.dataType == 'DTTPNMBR'}" styleClass="res-tree-table-cell" >
                                                <bm:convertNumberNew minFractionDigits="0"/>
                                            </h:outputText>
                                            <h:outputText value="#{prodAttr.valueD}" title="#{prodAttr.valueD}" rendered="#{prodAttr.dataType == 'DTTPDATE'}" styleClass="res-tree-table-cell" >
                                                <f:convertDateTime pattern="#{usession.datePattern}" timeZone="#{CommonUtils.timeZone}"/>
                                            </h:outputText>
                                        </h:panelGroup>
                                    </o:column>
                                </o:treeTable>
                            </h:panelGroup>
                            <h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
                                <h:panelGroup layout="block" styleClass="bottom_search_result_left_buttons" rendered="#{attributesBean==null}">
                                    <h:panelGrid id="btnPanel" columns="5" style="vertical-align: top;" cellpadding="0" cellspacing="0">
                                        <h:panelGroup styleClass="midButton"  rendered="#{show_buttom_change_visibility}">
                                            <bre:taggedCommandButton id="btn_unblock"
                                                                     value="#{lblPrd.change_visibility}" >
                                                <a4j:support event="onclick" reRender="attrsTreeTable"
                                                             ajaxSingle="true" limitToList="true"
                                                             action="#{MbProductAppServiceTermsDS.attributes.setServiceAttribute}"/>
                                            </bre:taggedCommandButton>
                                        </h:panelGroup>
                                    </h:panelGrid>
                                </h:panelGroup>
                            </h:panelGroup>

                            <script type="text/javascript">//<!--
                            // select first row which for some reason doesn't want to do it automatically
                            var nodeKey = "#{MbProductAppServiceTermsDS.attributes.node.modelId}";
                            if (document.getElementById("attrsTreeForm:attrsTreeTable").getSelectedNodeKey() == null
                                && nodeKey != null) {
                                document.getElementById("attrsTreeForm:attrsTreeTable").setSelectedNodeKey(nodeKey);
                            }
                            // -->
                            </script>
                        </h:form>

                        <h:panelGroup id="attrValues" layout="block">
                            <ui:include src="/pages/products/attributes/list_attr_values.jspx">
                                <ui:param name="disableEditing" value="#{disableEditing}" />
                                <ui:param name="fullViewIdColon" value="#{fullViewIdColon}"/>
                            </ui:include>
                        </h:panelGroup>
                    </h:panelGrid>
                </h:panelGroup>
            </h:form>
        </ui:define>
    </ui:composition>
</html>