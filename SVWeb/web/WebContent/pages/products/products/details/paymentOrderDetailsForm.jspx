<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j" xmlns:rich="http://richfaces.org/rich"
	xmlns:bm="http://www.bpc.ru/jsf/misc" xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext"
	xmlns:bpct="http://www.bpc.ru/jsf/tiles" xmlns:fmt="http://www.bpc.ru/el/formatter">
	<ui:composition>

		<f:loadBundle var="lblRpt" basename="ru.bpc.sv2.ui.bundles.Rpt" />
		<f:loadBundle var="lblPmo" basename="ru.bpc.sv2.ui.bundles.Pmo" />
		<f:loadBundle var="lblFcl" basename="ru.bpc.sv2.ui.bundles.Fcl" />

		<h:form id="#{viewId}initForm">
			<a4j:jsFunction action="#{MbPaymentOrderDetails.initializeModalPanel}"
				name="initializeDetailsPanel#{viewId}" reRender="#{viewIdColon}#{viewId}detailsForm:refreshMe"
				limitToList="true">
			</a4j:jsFunction>
		</h:form>

		<rich:modalPanel id="paymentOrderDetailsModalPanel"
			autosized="true" minWidth="500" minHeight="50"
			onbeforeshow="initializeDetailsPanel#{viewId}()">
			<f:facet name="header">
				<h:outputText value="#{lblPmo.payment_order} - #{lblCommon.details}" />
			</f:facet>

			<h:form id="#{viewId}detailsForm">
				<script>
					paymentOrderDetailsForm = new Object();
					paymentOrderDetailsForm.showCyclesButtons = function(){
						document.getElementById("contextMenuModalPanel:#{viewId}detailsForm:editBtn").style.display = "inline";
					}
					paymentOrderDetailsForm.hideCyclesButtons = function(){
						document.getElementById("contextMenuModalPanel:#{viewId}detailsForm:editBtn").style.display = "none";
					}
					paymentOrderDetailsForm.hideCyclesButtons();
				</script>
			
				<a4j:outputPanel id="refreshMe">

					<rich:tabPanel switchType="client" id="details" selectedTab="General" value="General" 
						tabClass="tab-cell" activeTabClass="active-tab-cell" headerClass="tabs"
						headerSpacing="0px" contentClass="tab-content" style="height:100%;">

						<rich:tab label="General" name="General" style="height:100%;">
							<f:facet name="label">
								<h:panelGroup styleClass="first tab-label" layout="block">
									<h:outputText value="#{lblPrd.general_data}"
										title="#{lblPrd.general_data}" />
								</h:panelGroup>
							</f:facet>
							<h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
								<h:panelGrid columns="2" styleClass="cardholderdata"
									columnClasses="firstCol, width250">

									<h:outputLabel for="lang" value="#{lblCommon.lang_selector}: "
										title="#{lblCommon.lang_selector}" />
									<h:selectOneMenu value="#{MbPaymentOrderDetails.language}">
										<a4j:support event="onchange" reRender="#{viewId}detailsForm"
											limitToList="true" action="#{MbPaymentOrderDetails.reset}" />
										<f:selectItems value="#{MbPaymentOrderDetails.languages}" />
									</h:selectOneMenu>

									<h:outputText />
									<rich:separator height="2" lineType="dotted"
										styleClass="separator" />

									<h:outputLabel value="#{lblCommon.id}: " title="#{lblCommon.id}" />
									<h:inputText value="#{MbPaymentOrderDetails.paymentOrder.id}"
										title="#{MbPaymentOrderDetails.paymentOrder.id}" readonly="true" />

									<h:outputLabel value="#{lblPmo.purpose}: " title="#{lblPmo.purpose}" />
									<h:inputText
										value="#{MbPaymentOrderDetails.paymentOrder.purposeId} - #{MbPaymentOrderDetails.paymentOrder.purposeName}"
										title="#{MbPaymentOrderDetails.paymentOrder.purposeId} - #{MbPaymentOrderDetails.paymentOrder.purposeName}"
										rendered="#{MbPaymentOrderDetails.paymentOrder != null}"
										readonly="true" />
									<h:inputText value=""
										rendered="#{MbPaymentOrderDetails.paymentOrder == null}"
										readonly="true" />

									<h:outputLabel value="#{lblPmo.amount}: " title="#{lblPmo.amount}" />
									<h:inputText id="amount"
										value="#{fmt:formatMoney(MbPaymentOrderDetails.paymentOrder.amount, CurrencyUtils.currencyObjectsMap[MbPaymentOrderDetails.paymentOrder.currency].exponent)}"
										title="#{fmt:formatMoney(MbPaymentOrderDetails.paymentOrder.amount, CurrencyUtils.currencyObjectsMap[MbPaymentOrderDetails.paymentOrder.currency].exponent)}"
										rendered="#{MbPaymentOrderDetails.paymentOrder != null}"
										readonly="true" />
									<h:inputText value=""
										rendered="#{MbPaymentOrderDetails.paymentOrder == null}"
										readonly="true" />

									<h:outputLabel value="#{lblPmo.currency}: "
										title="#{lblPmo.currency}" />
									<h:panelGroup layout="block" class="pseudo-input-with-flag"
										style="border:1px solid #999999; width:251px;">
										<div
											class="#{EntityIcons.objectsMapS['ENTT0046'][MbPaymentOrderDetails.paymentOrder.currency]}" />
										<h:inputText readonly="true"
											value="#{MbPaymentOrderDetails.paymentOrder.currency} - #{CurrencyUtils.currencyObjectsMap[MbPaymentOrderDetails.paymentOrder.currency].currencyName}"
											title="#{MbPaymentOrderDetails.paymentOrder.currency} - #{CurrencyUtils.currencyMap[MbPaymentOrderDetails.paymentOrder.currency]}"
											rendered="#{MbPaymentOrderDetails.paymentOrder != null}" />
										<h:inputText readonly="true" value=""
											rendered="#{MbPaymentOrderDetails.paymentOrder == null}" />
									</h:panelGroup>

									<h:outputLabel value="#{lblPmo.event_date}: "
										title="#{lblPmo.event_date}" />
									<h:inputText id="eventDate"
										value="#{fmt:formatDate(MbPaymentOrderDetails.paymentOrder.eventDate, usession.datePattern, CommonUtils.timeZoneId)}"
										title="#{fmt:formatDate(MbPaymentOrderDetails.paymentOrder.eventDate, usession.datePattern, CommonUtils.timeZoneId)}"
										readonly="true" />

									<h:outputLabel value="#{lblPmo.status}: " title="#{lblPmo.status}" />
									<h:inputText id="status"
										value="#{DictUtils.articles[MbPaymentOrderDetails.paymentOrder.status]}"
										title="#{DictUtils.articles[MbPaymentOrderDetails.paymentOrder.status]}"
										readonly="true" />

									<h:outputLabel value="#{lblPmo.object}: " title="#{lblPmo.object}" />
									<h:inputText
										value="#{DictUtils.articles[MbPaymentOrderDetails.paymentOrder.entityType]} - #{MbPaymentOrderDetails.paymentOrder.objectId}"
										title="#{DictUtils.articles[MbPaymentOrderDetails.paymentOrder.entityType]} - #{MbPaymentOrderDetails.paymentOrder.objectId}"
										rendered="#{MbPaymentOrderDetails.paymentOrder != null}"
										readonly="true" />
									<h:inputText value=""
										rendered="#{MbPaymentOrderDetails.paymentOrder == null}"
										readonly="true" />

									<h:outputLabel value="#{lblCommon.institution}: "
										title="#{lblCommon.institution}" />
									<h:inputText
										value="#{MbPaymentOrderDetails.paymentOrder.instId} - #{MbPaymentOrderDetails.paymentOrder.instName}"
										title="#{MbPaymentOrderDetails.paymentOrder.instId} - #{MbPaymentOrderDetails.paymentOrder.instName}"
										readonly="true" />

									<h:outputLabel value="#{lblPmo.attempt_count}: "
										title="#{lblPmo.attempt_count}" />
									<h:inputText
										value="#{MbPaymentOrderDetails.paymentOrder.attemptCount}"
										title="#{MbPaymentOrderDetails.paymentOrder.attemptCount}"
										readonly="true" />

								</h:panelGrid>
							</h:panelGroup>

						</rich:tab>

						<rich:tab label="Cycles" name="Cycles" style="height:100%;" ontabenter="paymentOrderDetailsForm.showCyclesButtons();" ontableave="paymentOrderDetailsForm.hideCyclesButtons();">
							<f:facet name="label">
								<h:panelGroup styleClass="first tab-label" layout="block">
									<h:outputText value="#{lblFcl.cycle_counters}"
										title="#{lblFcl.cycle_counters}" />
								</h:panelGroup>
							</f:facet>
							<rich:extendedDataTable id="cycles" var="item"
								value="#{MbPaymentOrderDetails.cycleCounters}" selection="#{MbPaymentOrderDetails.cycleItemSelection}"
								rows="0" 
								selectionMode="single" 
								rowClasses=",odd" 
								headerClass="res-table-header"
								selectedClass="res-table-selected" 
								styleClass="res-table"
								height="250px" enableContextMenu="false"
								noDataLabel="#{lblCommon['no_records_found']}" reRender="cyclesBtn">

								<a4j:support event="onselectionchange" reRender="cyclesBtn" ajaxOnly="true" limitToList="true"/>

								<rich:column title="Cycle type" width="60%"
									sortBy="#{'cycleType'}">
									<f:facet name="header">
										<h:outputText value="#{lblFcl.cycle_type}" title="#{lblFcl.cycle_type}" />
									</f:facet>
									<h:outputText value="#{DictUtils.articles[item.cycleType]}"
										title="#{DictUtils.articles[item.cycleType]}" rendered="#{item.cycleType != null}" />
									<h:outputText value="" title=""
										rendered="#{item.cycleType == null}" />
								</rich:column>

								<rich:column title="Next date" width="40%" sortBy="#{'nextDate'}">
									<f:facet name="header">
										<h:outputText value="#{lblFcl.next_date}" title="#{lblFcl.next_date}" />
									</f:facet>
									<h:outputText value="#{item.nextDate}">
										<f:convertDateTime pattern="#{usession.datePattern} HH:mm"
											timeZone="#{CommonUtils.timeZone}" />
									</h:outputText>
								</rich:column>
							</rich:extendedDataTable>
						</rich:tab>

						<ui:remove>
							<rich:tab label="Template" name="Template" style="height:100%;">
								<f:facet name="label">
									<h:panelGroup styleClass="first tab-label" layout="block">
										<h:outputText value="#{lblRpt.template}" title="#{lblRpt.template}" />
									</h:panelGroup>
								</f:facet>
								<h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
									<h:panelGrid columns="2" styleClass="cardholderdata"
										columnClasses="firstCol, width250">

										<h:outputLabel for="lang"
											value="#{lblCommon.lang_selector}: " title="#{lblCommon.lang_selector}" />
										<h:selectOneMenu value="#{MbPaymentOrderDetails.language}">
											<a4j:support event="onchange" reRender="#{viewId}detailsForm"
												limitToList="true" action="#{MbPaymentOrderDetails.reset}" />
											<f:selectItems value="#{MbPaymentOrderDetails.languages}" />
										</h:selectOneMenu>

										<h:outputText />
										<rich:separator height="2" lineType="dotted"
											styleClass="separator" />

										<h:outputLabel value="#{lblCommon.name}" title="#{lblCommon.name}" />
										<h:inputText value="#{MbPaymentOrderDetails.template.label}"
											readonly="true" />


										<h:outputLabel value="#{lblPmo.status}" title="#{lblPmo.status}" />
										<h:inputText
											value="#{DictUtils.articles[MbPaymentOrderDetails.template.status]}"
											title="#{DictUtils.articles[MbPaymentOrderDetails.template.status]}"
											readonly="true" />

										<h:outputLabel value="#{lblPmo.provider}" title="#{lblPmo.provider}" />
										<h:inputText value="#{MbPaymentOrderDetails.template.providerName}"
											readonly="true" />

										<h:outputLabel value="#{lblPmo.service}" title="#{lblPmo.service}" />
										<h:inputText value="#{MbPaymentOrderDetails.template.serviceName}"
											readonly="true" title="#{MbPaymentOrderDetails.template.serviceName}" />

										<h:outputLabel value="#{lblPmo.is_prepared_order}"
											title="#{lblPmo.is_prepared_order}" />
										<h:inputText value="#{lblCommon.yes}" title="#{lblCommon.yes}"
											rendered="#{MbPaymentOrderDetails.template.isPreparedOrder}"
											readonly="true" />
										<h:inputText value="#{lblCommon.no}" title="#{lblCommon.no}"
											rendered="#{!MbPaymentOrderDetails.template.isPreparedOrder}"
											readonly="true" />

										<h:outputLabel value="#{lblCommon.event_type}"
											title="#{lblCommon.event_type}" />
										<h:inputText
											value="#{DictUtils.articles[MbPaymentOrderDetails.template.schedule.eventType]}"
											title="#{DictUtils.articles[MbPaymentOrderDetails.template.schedule.eventType]}"
											rendered="#{MbPaymentOrderDetails.template.schedule != null}"
											readonly="true" />
										<h:inputText value=""
											rendered="#{MbPaymentOrderDetails.template.schedule == null}"
											readonly="true" />

										<h:outputLabel value="#{lblPmo.amount_algorithm}"
											title="#{lblPmo.amount_algorithm}" />
										<h:inputText
											value="#{DictUtils.articles[MbPaymentOrderDetails.template.schedule.amountAlgorithm]}"
											title="#{DictUtils.articles[MbPaymentOrderDetails.template.schedule.amountAlgorithm]}"
											rendered="#{MbPaymentOrderDetails.template.schedule != null}"
											readonly="true" />
										<h:inputText value=""
											rendered="#{MbPaymentOrderDetails.template.schedule == null}"
											readonly="true" />

									</h:panelGrid>
								</h:panelGroup>
							</rich:tab>

							<rich:tab label="Parameters" name="Parameters" style="height:100%;">
								<f:facet name="label">
									<h:panelGroup styleClass="first tab-label" layout="block">
										<h:outputText value="#{lblCommon.parameters}"
											title="#{lblCommon.parameters}" />
									</h:panelGroup>
								</f:facet>
								<rich:extendedDataTable id="templateParametersTable"
									var="item" value="#{MbPaymentOrderDetails.templateParameters}"
									rows="0" height="220px" selectionMode="single" rowClasses=",odd"
									headerClass="res-table-header" selectedClass="res-table-selected"
									styleClass="res-table" enableContextMenu="false"
									noDataLabel="#{lblCommon.no_records_found}">

									<rich:column sortBy="#{'paramLabel'}" width="45%">
										<f:facet name="header">
											<h:outputText value="#{lblCommon.label}" title="#{lblCommon.label}" />
										</f:facet>
										<h:outputText value="#{item.name}" />
										<h:outputText value="*" rendered="#{item.fixed}" />
									</rich:column>

									<rich:column sortBy="#{'paramValue'}" width="45%">
										<f:facet name="header">
											<h:outputText value="#{lblCommon.value}" title="#{lblCommon.value}" />
										</f:facet>
										<h:outputText value="#{item.paramValue}" style="width: 90%" />
									</rich:column>

								</rich:extendedDataTable>
							</rich:tab>
						</ui:remove>

					</rich:tabPanel>

				</a4j:outputPanel>

				<h:panelGroup layout="block" id="cyclesBtn"
					styleClass="bottom_search_result_block_buttons">
					<h:panelGroup layout="block"
						styleClass="bottom_search_result_left_buttons">
						<h:panelGrid columns="3" columnClasses="width99P,,paddingR12">

							<h:outputText />

							<bre:taggedCommandButton id="editBtn"
								reRender="cycleCounterEditModalPanel" value="#{lblForm.edit}"
								action="#{MbPaymentOrderDetails.editCycleCounter}" oncomplete="Richfaces.showModalPanel('cycleCounterEditModalPanel')"
								disabled="#{MbPaymentOrderDetails.selectedCycleCounter == null}"
								image="/images/edit.gif" />

							<bre:taggedCommandButton value="#{lblForm.close}"
								onclick="Richfaces.hideModalPanel('paymentOrderDetailsModalPanel'); return false;">

							</bre:taggedCommandButton>
						</h:panelGrid>
					</h:panelGroup>
				</h:panelGroup>
			</h:form>
		</rich:modalPanel>

		<rich:modalPanel id="cycleCounterEditModalPanel"
			autosized="true" minWidth="100" minHeight="10">
			<f:facet name="header">
				<h:outputText value="#{lblFcl.edit_cycle_counter}" />
			</f:facet>
			<f:facet name="controls">
			</f:facet>
			<h:form id="cycleCounterEditModalPanelForm">
				<h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
					<h:panelGrid columns="2" styleClass="cardholderdata"
						columnClasses="firstCol, width250">
						<h:outputLabel for="nextDate" value="#{lblFcl.next_date}:" />
						<h:panelGroup layout="block" style="width:250px">
						<rich:calendar zindex="1000" buttonIcon="/images/calendar.gif" id="nextDate" datePattern="#{usession.datePattern}"
							inputStyle="width:200px"
							value="#{MbPaymentOrderDetails.editingCycleCounter.nextDate}"
							required="true" label="#{lblFcl.next_date}" timeZone="#{CommonUtils.timeZone}">
						</rich:calendar>
						</h:panelGroup>
					</h:panelGrid>
				</h:panelGroup>

				<h:panelGroup layout="block"
					styleClass="bottom_search_result_block_buttons">
					<h:panelGroup layout="block"
						styleClass="bottom_search_result_left_buttons">
						<h:panelGrid columns="3" columnClasses="width99P,,paddingR12">

							<h:outputText />

							<bre:taggedCommandButton value="#{lblForm.save}"
								type="submit" action="#{MbPaymentOrderDetails.saveEditingCycleCounter}"
								onclick="disableModalPanelBtns(this)"
								oncomplete="enableModalPanelBtns(this); if (#{usession.noErrorResponse}) 
			                   			Richfaces.hideModalPanel('cycleCounterEditModalPanel')"
								reRender="#{viewId}detailsForm:cycles" />

							<bre:taggedCommandButton value="#{lblForm.cancel}"
								action="#{MbPaymentOrderDetails.resetEditingCycleCounter}"
								immediate="true" limitToList="true"
								oncomplete="Richfaces.hideModalPanel('cycleCounterEditModalPanel')">
								<f:actionListener type="ru.bpc.jsf.A4JFormReset" />
							</bre:taggedCommandButton>
						</h:panelGrid>
					</h:panelGroup>
				</h:panelGroup>
			</h:form>
		</rich:modalPanel>
	</ui:composition>
</html>
