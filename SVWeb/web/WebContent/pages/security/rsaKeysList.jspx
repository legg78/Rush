<?xml version="1.0" encoding="UTF-8"?>

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext"
	xmlns:bpct="http://www.bpc.ru/jsf/tiles"
	xmlns:bpc="http://www.bpc.ru/jsf/misc">

<ui:composition template="/WEB-INF/templates/navigatable.jspx">
	<ui:define name="navigatableContent">

		<!-- link rel="stylesheet" type="text/css"
			href="#{facesContext.externalContext.requestContextPath}/css/stretch.css" /-->
		<script type="text/javascript"
			src="#{facesContext.externalContext.requestContextPath}/js/stretch.js" />

		<f:loadBundle var="lblSec" basename="ru.bpc.sv2.ui.bundles.Sec" />

		<!-- navigation bar -->
		<bpct:navBar pageName="#{lblSec.rsa_key}" />

		<!-- search panel -->
		<h:form id="rsaKeySearchForm">
			<h:panelGroup layout="block" styleClass="search_block">
				<h:panelGroup layout="block" styleClass="search_block_inner1">
					<h:panelGroup layout="block" styleClass="search_block_inner2">
						<h:panelGroup layout="block" styleClass="search_block_left">
							<h:panelGrid styleClass="fw" columns="2"
								columnClasses=",link-cont">
								<h:panelGrid styleClass="filter-table field-cont twoColumnTable"
									columns="4"
									columnClasses="firstCol,secondCol,firstCol,secondCol">

									<h:outputLabel for="lmkId" value="#{lblSec.lmk_id}:" />
									<h:inputText id="lmkId" value="#{MbRsaKey.filter.lmkId}">
									</h:inputText>

									<h:outputLabel for="expirDate" value="#{lblSec.expir_date}:" />
									<rich:calendar buttonIcon="/images/calendar.gif" id="calendar"
										datePattern="#{usession.datePattern}"
										value="#{MbRsaKey.filter.expirDate}"
                                        inputClass="inputDate" />

								</h:panelGrid>

								<h:panelGrid columns="1">
									<h:panelGroup styleClass="stdButton">
										<bre:taggedCommandButton action="#{MbRsaKey.search}"
											reRender="RsaKeyTable, RsaKeyDataScroller, pagesNum, rsaKeyBtnForm:btnPanel, #{MbRsaKey.tabName}"
											image="/_img/icon_search.png" value="#{lblForm.search }"
											style="width:85px;"
											onclick="disableModalPanelBtns(this);"
											oncomplete="enableModalPanelBtns(this);"
											eventsQueue="queue" />

									</h:panelGroup>

									<h:panelGroup styleClass="link-clear" layout="block">
										<h:graphicImage url="/_img/icon_clear.png" />
										<a4j:commandLink value="#{lblForm.clear_all}"
											action="#{MbRsaKey.clearFilter}"
											reRender="rsaKeyResultForm, rsaKeySearchForm, rsaKeyBtnForm, details">
										</a4j:commandLink>
									</h:panelGroup>
								</h:panelGrid>

							</h:panelGrid>
							<h:graphicImage url="/_img/hd_searchblock.gif"
								styleClass="hd-searchblock" />
							<h:panelGroup styleClass="collapse-vert" layout="block" />
						</h:panelGroup>
					</h:panelGroup>
				</h:panelGroup>
			</h:panelGroup>
		</h:form>

		<!-- Result panel -->
		<h:form id="rsaKeyResultForm">
			<h:panelGroup styleClass="search_result_block" layout="block">
				<h:panelGroup styleClass="search_result_block_left fix-ff"
					layout="block">
					<h:panelGroup id="rsaKeyTableWrapper" layout="block"
						styleClass="search_result_block_inner">
						<rich:extendedDataTable id="RsaKeyTable" styleClass="res-table"
							headerClass="res-table-header" rowClasses=",odd"
							selectedClass="res-table-selected" var="item"
							value="#{MbRsaKey.dataModel}"
							selection="#{MbRsaKey.itemSelection}" rows="#{MbRsaKey.rowsNum}"
							selectionMode="single" enableContextMenu="false"
							height="255px"
							noDataLabel="#{MbRsaKey.searching ? lblCommon.no_records_found : lblCommon.enter_search_criteria_above}"
							reRender="rsaKeyBtnForm:btnPanel, #{MbRsaKey.tabName}">

							<a4j:support event="onselectionchange" eventsQueue="queue"
								reRender="rsaKeyBtnForm:btnPanel, #{MbRsaKey.tabName}" />

							<rich:column title="Key Index" sortBy="#{'keyIndex'}" width="10%">
								<f:facet name="header">
									<h:panelGroup>
										<script>
											updateHeight();
										</script>
										<h:outputText value="#{lblSec.key_index}"
											title="#{lblSec.key_index}" />
									</h:panelGroup>
								</f:facet>
								<h:outputText value="#{item.keyIndex}" title="#{item.keyIndex}" />
							</rich:column>

							<rich:column title="Modulus Length" sortBy="#{'modulusLength'}"
								width="10%">
								<f:facet name="header">
									<h:outputText value="#{lblSec.modulus_length}"
										title="#{lblSec.modulus_length}" />
								</f:facet>
								<h:outputText value="#{item.modulusLength}"
									title="#{item.modulusLength}" />
							</rich:column>

							<rich:column title="Lmk Id" sortBy="#{'lmkId'}" width="10%">
								<f:facet name="header">
									<h:panelGroup>
										<script>
											updateHeight();
										</script>
										<h:outputText value="#{lblSec.lmk_id}"
											title="#{lblSec.lmk_id}" />
									</h:panelGroup>
								</f:facet>
								<h:outputText value="#{item.lmkId}" title="#{item.lmkId}" />
							</rich:column>

							<rich:column title="Expir Date" sortBy="#{'expirDate'}"
								width="16%">
								<f:facet name="header">
									<h:outputText value="#{lblSec.expir_date}"
										title="#{lblSec.expir_date}" />
								</f:facet>
								<h:outputText value="#{item.expirDate}"
									title="#{item.expirDate}">
									<f:convertDateTime pattern="#{usession.datePattern}"
										timeZone="#{CommonUtils.timeZone}" />
								</h:outputText>
							</rich:column>

							<rich:column title="Description" sortBy="#{'description'}"
								width="14%">
								<f:facet name="header">
									<h:outputText value="#{lblSec.description}"
										title="#{lblSec.description}" />
								</f:facet>
								<h:outputText value="#{item.description}"
									title="#{item.description}" />
							</rich:column>

							<rich:column title="Key Index" sortBy="#{'keyIndex'}"
								width="14%">
								<f:facet name="header">
									<h:outputText value="#{lblSec.key_index} (hex)"
										title="#{lblSec.key_index} (hex)" />
								</f:facet>
								<h:outputText value="#{item.keyIndex}"
									title="#{item.keyIndex}" >
									<bpc:hexadecimalConverter />
								</h:outputText>
							</rich:column>
							
							<rich:column title="Authority key Index"
								width="14%">
								<f:facet name="header">
									<h:outputText value="#{lblSec.authority_key_index}"
										title="#{lblSec.authority_key_index}" />
								</f:facet>
								<h:outputText value="#{item.authorityKeyIndex}"
									title="#{item.authorityKeyIndex}" >
								</h:outputText>
							</rich:column>

						</rich:extendedDataTable>
					</h:panelGroup>
					<a4j:outputPanel ajaxRendered="true">
						<h:panelGroup id="show_more_panel" styleClass="show-more-vert show-more-result-tab" layout="block"/>
						<h:graphicImage url="/_img/hd_searchblock.gif"
							styleClass="hd-searchblock" />
						<h:panelGroup styleClass="collapse-vert table-collapse-vert"
							layout="block" />
					</a4j:outputPanel>

				</h:panelGroup>
			</h:panelGroup>
        </h:form>

        <h:form id="rsaKeyBtnForm">
            <h:panelGroup layout="block" styleClass="bottom_search_result_block">
                <h:panelGroup layout="block" styleClass="bottom_search_result_left">
                    <h:panelGroup layout="block" styleClass="table_tools">
                        <h:panelGrid styleClass="fw field-cont" columns="4"
                            columnClasses="per-page-lbl,per-page-sel,nav-cont,pagecount">

                            <h:outputLabel for="rows_num" value="#{lblCommon.rows_per_page}" />

                            <h:selectOneMenu id="rows_num" value="#{MbRsaKey.rowsNum}"
                                styleClass="row_per_page">
                                <a4j:support event="onchange" reRender="RsaKeyTable, RsaKeyDataScroller, pagesNum, rsaKeyBtnForm, #{MbRsaKey.tabName}" />
                                <f:selectItem itemValue="10" itemLabel="10" />
                                <f:selectItem itemValue="20" itemLabel="20" />
                                <f:selectItem itemValue="50" itemLabel="50" />
                            </h:selectOneMenu>

                            <rich:datascroller id="RsaKeyDataScroller" maxPages="10"
                                fastControls="hide" pagesVar="pages"
                                styleClass="res-datascroller" for="RsaKeyTable"
                                reRender="rsaKeyBtnForm:btnPanel, #{MbRsaKey.tabName}">
                                <f:facet name="first">
                                    <h:outputText value="&lt;&lt;" styleClass="prev-next" />
                                </f:facet>
                                <f:facet name="first_disabled">
                                    <h:outputText value="&lt;&lt;" styleClass="prev-next-dis" />
                                </f:facet>
                                <f:facet name="last">
                                    <h:outputText value="&gt;&gt;" styleClass="prev-next" />
                                </f:facet>
                                <f:facet name="last_disabled">
                                    <h:outputText value="&gt;&gt;" styleClass="prev-next-dis" />
                                </f:facet>
                                <f:facet name="previous">
                                    <h:outputText value="#{lblCommon.prev}" styleClass="prev-next" />
                                </f:facet>
                                <f:facet name="previous_disabled">
                                    <h:outputText value="#{lblCommon.prev}"
                                        styleClass="prev-next-dis" />
                                </f:facet>
                                <f:facet name="next">
                                    <h:outputText value="#{lblCommon.next}" styleClass="prev-next" />
                                </f:facet>
                                <f:facet name="next_disabled">
                                    <h:outputText value="#{lblCommon.next}"
                                        styleClass="prev-next-dis" />
                                </f:facet>
                                <f:facet name="pages">
                                </f:facet>
                            </rich:datascroller>

                            <h:panelGroup id="pagesNum">
                                <h:outputText styleClass="strongClass" value="#{pages} " />
                                <h:outputText value=" #{lblCommon.pages}" />
                                <h:outputText value="" style="padding-left: 20px; padding-right: 20px;" />
                                <h:outputText styleClass="strongClass" value="#{MbRsaKey.dataModel.rowCount}"/>
                                <h:outputText value=" #{lblCommon.records}"/>
                                <h:outputText value="" style="padding-left: 20px; padding-right: 20px;" />
                            </h:panelGroup>
                        </h:panelGrid>
                    </h:panelGroup>

                    <h:panelGrid id="btnPanel" columns="4" styleClass="buttons_block">
                        <bre:taggedCommandButton id="addBtn"
                            reRender="rsaKeyEditModalPanel" value="#{lblForm.generate}"
                            oncomplete="#{rich:component('rsaKeyEditModalPanel')}.show()"
                            action="#{MbRsaKey.createNewRsaKey}"
                            image="/images/create_doc.gif"
                            rendered="#{usession.inRole['ADD_RSA_KEYPAIR']}" />
                        <bre:taggedCommandButton id="editBtn"
                            reRender="rsaKeyEditModalPanel" value="#{lblForm.edit}"
                            action="#{MbRsaKey.editActiveRsaKey}"
                            oncomplete="#{rich:component('rsaKeyEditModalPanel')}.show()"
                            disabled="#{MbRsaKey.activeItem == null}"
                            image="/images/edit.gif"
                            rendered="false" />
                        <bre:taggedCommandButton id="deleteBtn"
                            value="#{lblForm.delete}"
                            disabled="#{MbRsaKey.activeItem == null}"
                            image="/images/delete.gif"
                            rendered="#{usession.inRole['REMOVE_RSA_KEYPAIR']}"
                            oncomplete="#{rich:component('deleteRsaKeyView:confirmPanel')}.show()"/>
                        <bre:taggedCommandButton id="setCaIndex"
                             value="#{lblSec.set_ca_index}" reRender="setCaIndexModalPanel"
                            oncomplete="#{rich:component('setCaIndexModalPanel')}.show()"
                            disabled="#{MbRsaKey.activeItem == null or MbRsaKey.activeItem.keyType!='ENKTIRKS'}"
                            image="/images/edit.gif"
                            />
                    </h:panelGrid>
                </h:panelGroup>
            </h:panelGroup>
		</h:form>

        <h:form>
            <a4j:jsFunction name="storeTab" ajaxSingle="true" limitToList="true" reRender="#{MbRsaKey.tabName}">
                <a4j:actionparam name="tabName" assignTo="#{MbRsaKey.tabName}" />
            </a4j:jsFunction>
        </h:form>

		<!-- Working panel -->
		<h:panelGroup styleClass="workplace" id="workplacePanel" layout="block">
			<rich:tabPanel switchType="client" id="details" tabClass="tab-cell"
				activeTabClass="active-tab-cell" headerClass="tabs"
				headerSpacing="0px" contentClass="tab-content">

				<rich:tab ontabenter="storeTab('detailsTab')" label="#{lblCommon.details}" name="detailsTab">
					<f:facet name="label">
						<h:panelGroup styleClass="first tab-label" layout="block">
							<h:outputText value="#{lblCommon.details}"
								title="#{lblCommon.details}" />
						</h:panelGroup>
					</f:facet>

					<h:panelGroup layout="block" id="detailsTab">
						<ui:include src="/pages/security/rsaKeyDetails.jspx"></ui:include>
						<h:panelGroup layout="block"
							styleClass="bottom_search_result_block_buttons"/>
					</h:panelGroup>
				</rich:tab>

				<rich:tab ontabenter="storeTab('rsaCertsTab')" label="#{lblSec.rsa_certificates}" name="rsaCertsTab"
					style="height:100%;"
					rendered="#{usession.inRole['VIEW_RSA_CERTIFICATE']}">
					<f:facet name="label">
						<h:panelGroup styleClass="first tab-label" layout="block">
							<h:outputText value="#{lblSec.rsa_certificates}"
								title="#{lblSec.rsa_keys}" />
						</h:panelGroup>
					</f:facet>

					<h:panelGroup id="rsaCertsTab" layout="block"
						styleClass="carddata-wrapper"
						style="height: 100%; overflow: hidden;position:relative;">
						<ui:include src="/pages/security/rsaKeyCertificatesBottom.jspx"></ui:include>
					</h:panelGroup>
				</rich:tab>

			</rich:tabPanel>
		</h:panelGroup>

		<ui:include src="/pages/security/rsaKeyEditModalPanel.jspx">
			<ui:param name="addBinField" value="true"></ui:param>
			<ui:param name="rerenderList" value="rsaKeyResultForm, RsaKeyTable, RsaKeyDataScroller, pagesNum, btnPanel" />
		</ui:include>
		
		<ui:include src="/pages/security/setCaIndexModalPanel.jspx" />
		
		<ui:include src="/pages/utils/confirmPanel.jspx">
			<ui:param name="backingBean" value="#{MbRsaKey}"/>
			<ui:param name="yesAction" value="deleteActiveRsaKey"/>
			<ui:param name="warningMsg" value="#{lblMsg.confirm_delete}"/> 
			<ui:param name="rerenderList" value="RsaKeyTable, RsaKeyDataScroller, pagesNum, btnPanel, #{MbRsaKey.tabName}"/>
			<ui:param name="confirmQuestion" value=" "/> 
			<ui:param name="subviewId" value="deleteRsaKeyView"/>
			<ui:param name="yes" value="#{lblForm.ok}"/>
			<ui:param name="no" value="#{lblForm.cancel}"/>
		</ui:include>

		<script type="text/javascript">

			function updateHeight() {
                updateGridHeight();
			}

            layout =
                    {
                        SEARCH_FORM_ID:                 'rsaKeySearchForm',
                        SEARCH_RESULT_FORM_ID:          'rsaKeyResultForm',
                        SEARCH_RESULT_FORM_WRAPPER_ID:  'rsaKeyTableWrapper',
                        SEARCH_RESULT_FOOTER_FORM_ID:   'rsaKeyBtnForm',
                        TAB_PANEL_ID:                   'workplacePanel',

                        TAB_DATA:      [{
                            TAB_FORM_ID:            'rsaKeyDetailsForm',
                            TAB_FORM_WRAPPER_ID:    'rsaKeyDetailsWrapper',
                            CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS + Stretch.LANG_SELECTOR
                        }, {
                            TAB_FORM_ID:            'rsaCertificatesForm',
                            TAB_FORM_WRAPPER_ID:    'rsaCertificatesTableWrapper',
                            CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
                        }]
                    };

			updateHeight();
            jQuery(window).resize(updateHeight);
		</script>

	</ui:define>
</ui:composition>
</html>
