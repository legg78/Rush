<?xml version="1.0" encoding="UTF-8"?>

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext"
	xmlns:bm="http://www.bpc.ru/jsf/misc"
	xmlns:bpct="http://www.bpc.ru/jsf/tiles">

<ui:composition template="/WEB-INF/templates/navigatable.jspx">
	<ui:define name="navigatableContent">
	    <f:loadBundle var="lblEvt" basename="ru.bpc.sv2.ui.bundles.Evt"/>
        <link rel="stylesheet" type="text/css"
              href="#{facesContext.externalContext.requestContextPath}/css/stretch.css"/>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/js/stretch.js"/>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/js/main.js"/>
		<h:panelGroup rendered="#{usession.inRole['VIEW_DELIVERY']}">

			<f:loadBundle var="lblCrd" basename="ru.bpc.sv2.ui.bundles.Crd" />

			<a4j:loadScript src="/js/calendarUtils.js"></a4j:loadScript>
			<a4j:queue name="queue" requestDelay="500" ignoreDupResponses="true" size="1" sizeExceededBehavior="dropNew"/>

			<script type="text/javascript">
			//<![CDATA[
			           var colorOk = "#FFFFFF";
					   var colorMandatory = "#FF5555";

					   function setDeliveryRefNumComplete() {
					            #{rich:component('changeDeliveryRefNumModalPanel')}.hide();
                       			document.getElementById('deliveriesSearchForm:searchBtn').click();
                       }

			           function checkFields(){
						   var institution = document.getElementById("deliveriesSearchForm:instId").value;
			        	   var deliveryRefNum = document.getElementById("deliveriesSearchForm:deliveryField").value;
			        	   if (institution != "" && deliveryRefNum != ""){
                               return false;
                           }
                           var agent = document.getElementById("deliveriesSearchForm:agentId").value;
                           var status = document.getElementById("deliveriesSearchForm:status").value;
                           var dateFrom = document.getElementById("deliveriesSearchForm:dateFrom").value;
                           var dateTo = document.getElementById("deliveriesSearchForm:dateTo").value;
                           if (institution != "" && agent != "" && status != "" && dateFrom != "" && dateTo != ""){
                               return false;
                           }
                           else {
                               var arr = []
                               arr.push('#{lblMsg.MANDATORY_COMBINATIONS}');
                               arr.push('1)#{lblCommon.institution} + #{lblCommon.agent} + #{lblIss.DELIVERY_STATUS} + #{lblCommon.date_from} + #{lblCommon.date_to}');
                               arr.push('2)#{lblCommon.institution} + #{lblIss.DELIV_REF_NUM}');
                               app.showWarning(arr.join('<br>'));
                               return true;
                           }
			           }
			           function checkData(){
			        	   var to = document.getElementById("deliveriesSearchForm:dateTo").value;
			        	   var from = document.getElementById("deliveriesSearchForm:dateFrom").value;
			        	   if (to == ""){
								dateTo = new Date();
							}else{
								dateTo = parseDate(to);
							}
							if (from == ""){
								document.getElementById("deliveriesSearchForm:dateFrom").style.backgroundColor = colorMandatory;
								return false;
							}
							var dateFrom = parseDate(from);
							var dif = (dateTo.getTime() - dateFrom.getTime())/ (1000 * 60 * 60 * 24);
							if (dif < 0){
							    alert('Date To should not be earlier than Date From');
								document.getElementById("deliveriesSearchForm:dateTo").style.backgroundColor = colorMandatory;
								document.getElementById("deliveriesSearchForm:dateFrom").style.backgroundColor = colorMandatory;
								return false;
							}
							allOk();
							return true;
			           }

			           function parseDate(val) {
							var preferEuro=!((arguments.length==2)?arguments[1]:false);

							generalFormats=new Array('y-M-d','MMM d, y','MMM d,y','y-MMM-d','d-MMM-y','MMM d', 'y.M.d');
							monthFirst=new Array('M/d/y','M-d-y','M.d.y','MMM-d','M/d','M-d');
							dateFirst =new Array('d/M/y','d-M-y','d.M.y','d-MMM','d/M','d-M');
							var checkList=new Array('generalFormats',preferEuro?'dateFirst':'monthFirst',preferEuro?'monthFirst':'dateFirst');
							var d=null;
							for (var i=0; i<checkList.length; i++) {
								var l=window[checkList[i]];
								for (var j=0; j<l.length; j++) {
									d=getDateFromFormat(val,l[j]);
									if (d!=0) { return new Date(d); }
									}
								}
							return null;
							}

						function getDateFromFormat(val,format) {
							val=val+"";
							format=format+"";
							var i_val=0;
							var i_format=0;
							var c="";
							var token="";
							var token2="";
							var x,y;
							var now=new Date();
							var year=now.getYear();
							var month=now.getMonth()+1;
							var date=1;
							var hh=now.getHours();
							var mm=now.getMinutes();
							var ss=now.getSeconds();
							var ampm="";

							while (i_format < format.length) {
								// Get next token from format string
								c=format.charAt(i_format);
								token="";
								while ((format.charAt(i_format)==c) && (i_format < format.length)) {
									token += format.charAt(i_format++);
									}
								// Extract contents of value based on format token
								if (token=="yyyy" || token=="yy" || token=="y") {
									if (token=="yyyy") { x=4;y=4; }
									if (token=="yy")   { x=2;y=2; }
									if (token=="y")    { x=2;y=4; }
									year=_getInt(val,i_val,x,y);
									if (year==null) { return 0; }
									i_val += year.length;
									if (year.length==2) {
										if (year > 70) { year=1900+(year-0); }
										else { year=2000+(year-0); }
										}
									}
								else if (token=="MMM"||token=="NNN"){
									month=0;
									for (var i=0; i<MONTH_NAMES.length; i++) {
										var month_name=MONTH_NAMES[i];
										if (val.substring(i_val,i_val+month_name.length).toLowerCase()==month_name.toLowerCase()) {
											if (token=="MMM"||(token=="NNN"&&i>11)) {
												month=i+1;
												if (month>12) { month -= 12; }
												i_val += month_name.length;
												break;
												}
											}
										}
									if ((month < 1)||(month>12)){return 0;}
									}
								else if (token=="EE"||token=="E"){
									for (var i=0; i<DAY_NAMES.length; i++) {
										var day_name=DAY_NAMES[i];
										if (val.substring(i_val,i_val+day_name.length).toLowerCase()==day_name.toLowerCase()) {
											i_val += day_name.length;
											break;
											}
										}
									}
								else if (token=="MM"||token=="M") {
									month=_getInt(val,i_val,token.length,2);
									if(month==null||(month<1)||(month>12)){return 0;}
									i_val+=month.length;}
								else if (token=="dd"||token=="d") {
									date=_getInt(val,i_val,token.length,2);
									if(date==null||(date<1)||(date>31)){return 0;}
									i_val+=date.length;}
								else if (token=="hh"||token=="h") {
									hh=_getInt(val,i_val,token.length,2);
									if(hh==null||(hh<1)||(hh>12)){return 0;}
									i_val+=hh.length;}
								else if (token=="HH"||token=="H") {
									hh=_getInt(val,i_val,token.length,2);
									if(hh==null||(hh<0)||(hh>23)){return 0;}
									i_val+=hh.length;}
								else if (token=="KK"||token=="K") {
									hh=_getInt(val,i_val,token.length,2);
									if(hh==null||(hh<0)||(hh>11)){return 0;}
									i_val+=hh.length;}
								else if (token=="kk"||token=="k") {
									hh=_getInt(val,i_val,token.length,2);
									if(hh==null||(hh<1)||(hh>24)){return 0;}
									i_val+=hh.length;hh--;}
								else if (token=="mm"||token=="m") {
									mm=_getInt(val,i_val,token.length,2);
									if(mm==null||(mm<0)||(mm>59)){return 0;}
									i_val+=mm.length;}
								else if (token=="ss"||token=="s") {
									ss=_getInt(val,i_val,token.length,2);
									if(ss==null||(ss<0)||(ss>59)){return 0;}
									i_val+=ss.length;}
								else if (token=="a") {
									if (val.substring(i_val,i_val+2).toLowerCase()=="am") {ampm="AM";}
									else if (val.substring(i_val,i_val+2).toLowerCase()=="pm") {ampm="PM";}
									else {return 0;}
									i_val+=2;}
								else {
									if (val.substring(i_val,i_val+token.length)!=token) {return 0;}
									else {i_val+=token.length;}
									}
								}
							// If there are any trailing characters left in the value, it doesn't match
							if (i_val != val.length) { return 0; }
							// Is date valid for month?
							if (month==2) {
								// Check for leap year
								if ( ( (year%4==0)&&(year%100 != 0) ) || (year%400==0) ) { // leap year
									if (date > 29){ return 0; }
									}
								else { if (date > 28) { return 0; } }
								}
							if ((month==4)||(month==6)||(month==9)||(month==11)) {
								if (date > 30) { return 0; }
								}
							// Correct hours value
							if (hh<12 && ampm=="PM") { hh=hh-0+12; }
							else if (hh>11 && ampm=="AM") { hh-=12; }
							var newdate=new Date(year,month-1,date,hh,mm,ss);
							return newdate.getTime();
							}

						function _isInteger(val) {
							var digits="1234567890";
							for (var i=0; i < val.length; i++) {
								if (digits.indexOf(val.charAt(i))==-1) { return false; }
								}
							return true;
							}
						function _getInt(str,i,minlength,maxlength) {
							for (var x=maxlength; x>=minlength; x--) {
								var token=str.substring(i,i+x);
								if (token.length < minlength) { return null; }
								if (_isInteger(token)) { return token; }
								}
							return null;
							}

						function handleEnter(event) {
							 if (event.keyCode == 13) {
								 document.getElementById('deliveriesSearchForm:searchBtn').click();
								 return false;
							}
							return true;
						 }
			//]]>
			</script>

			<rich:calendar buttonIcon="/images/calendar.gif" id="calendar" datePattern="#{usession.datePattern}"
				onchanged="#{rich:component('calendar')}.customInput.value=event.rich.component.getSelectedDateString();"
				zindex="1000" inputClass="hidden" buttonClass="hidden" />

			<script>
				#{rich:component('calendar')}.customExpand=customExpand;
			</script>

			<!-- navigation bar -->
			<bpct:navBar pageName="#{lblIss.DELIV_REF_NUM}" />

			<!-- search panel -->
			<h:form id="deliveriesSearchForm" onkeypress="handleEnter(event)">

				<h:panelGroup layout="block" styleClass="search_block">
					<h:panelGroup layout="block" styleClass="search_block_inner1">
						<h:panelGroup layout="block" styleClass="search_block_inner2">
							<h:panelGroup layout="block" styleClass="search_block_left">
								<h:panelGrid styleClass="fw" columns="2"
									columnClasses="top ,link-cont">
									<h:panelGrid styleClass="filter-table field-cont twoColumnTable" columns="4"
										columnClasses="firstCol,secondCol,firstCol,secondCol">

										<h:outputLabel for="cardNumber" value="#{lblCrd.card_number}:" title="#{lblCrd.card_number}" />
                                        <h:inputText id="cardNumber"
                                            value="#{MbDeliveries.filter.cardNumber}" />

										<h:outputLabel for="instId" value="#{lblCommon.institution}:" title="#{lblCommon.institution}" />
										<h:selectOneMenu id="instId"
											value="#{MbDeliveries.filter.instId}">
											<a4j:support event="onchange" reRender="agentId"
                                                oncomplete="document.getElementById('deliveriesSearchForm:instId').focus();"
                                                limitToList="true" ajaxSingle="true" />
											<f:selectItems value="#{MbDeliveries.institutions}" />
										</h:selectOneMenu>

										<h:outputLabel for="agentId"
                                            value="#{lblCommon.agent}: " title="#{lblCommon.agent}" />
                                        <h:selectOneMenu id="agentId"
                                            value="#{MbDeliveries.filter.agentId}">
                                            <f:selectItem itemValue="" />
                                            <f:selectItems value="#{MbDeliveries.agents}" />
                                        </h:selectOneMenu>

										<h:outputText value="#{lblCommon.date_from }:" title="#{lblCommon.date_from}" />
										<h:panelGroup>
											<h:inputText id="dateFrom" style="max-width:225px"
												value="#{MbDeliveries.filter.dateFrom}"
												onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('dateFrom')}, #{rich:element('dateFromBtn')});">
												<f:convertDateTime pattern="#{usession.datePattern}" timeZone="#{CommonUtils.timeZone}"/>
											</h:inputText>
											<h:graphicImage
												value="/images/calendar.gif"
												onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('dateFrom')}, #{rich:element('dateFromBtn')});"
												id="dateFromBtn" />
										</h:panelGroup>

										<h:outputLabel for="status" title="#{lblIss.DELIVERY_STATUS}: "
											value="#{lblIss.DELIVERY_STATUS}:" />
										<h:selectOneMenu id="status"
                                            value="#{MbDeliveries.filter.deliveryStatus}">
                                            <f:selectItem itemValue="" />
                                            <f:selectItems value="#{MbDeliveries.deliveryStatuses}" />
                                        </h:selectOneMenu>


										<h:outputText value="#{lblCommon.date_to}:" title="#{lblCommon.date_to}" />
										<h:panelGroup>
											<h:inputText id="dateTo" style="max-width:225px"
												value="#{MbDeliveries.filter.dateTo}"
												onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('dateTo')}, #{rich:element('dateToBtn')});">
												<f:convertDateTime pattern="#{usession.datePattern}" timeZone="#{CommonUtils.timeZone}"/>
											</h:inputText>
											<h:graphicImage
												value="/images/calendar.gif"
												onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('dateTo')}, #{rich:element('dateToBtn')});"
												id="dateToBtn" />
										</h:panelGroup>

										<h:outputLabel for="deliveryField" value="#{lblIss.DELIV_REF_NUM}:" title="#{lblIss.DELIV_REF_NUM}" />
                                        <h:inputText id="deliveryField"
                                            value="#{MbDeliveries.filter.deliveryRefNum}" />

                                        <h:outputLabel for="cardType" title="#{lblIss.card_type}: "
                                            value="#{lblIss.card_type}:" />
                                        <h:selectOneMenu id="cardType"
                                            value="#{MbDeliveries.filter.cardTypeId}">
                                            <f:selectItem itemValue="" />
                                            <f:selectItems value="#{MbDeliveries.cardTypes}" />
                                        </h:selectOneMenu>

									</h:panelGrid>

									<h:panelGrid columns="1">
										<h:panelGroup styleClass="stdButton">
											<bre:taggedCommandButton action="#{MbDeliveries.search}"
												reRender="deliveriesTable, navdeliveries, pagesNum, #{MbDeliveries.tabName}, btnPanel"
												image="/_img/icon_search.png" type="submit" value="#{lblForm.search }"
												id="searchBtn"
												style="width:85px;"
												onclick="if (checkFields()){return false;}disableModalPanelBtns(this);"
												oncomplete="enableModalPanelBtns(this);"
												eventsQueue="queue"/>

										</h:panelGroup>

										<h:panelGroup styleClass="link-clear" layout="block">
											<h:graphicImage url="/_img/icon_clear.png" />
											<a4j:commandLink value="#{lblForm.clear_all}"
												action="#{MbDeliveries.clearFilter}"
												reRender="deliveriesSearchForm, deliveriesForm, deliveriesBtnForm, details">
											</a4j:commandLink>
										</h:panelGroup>
									</h:panelGrid>

								</h:panelGrid>
								<a4j:outputPanel ajaxRendered="true">
									<h:graphicImage url="/_img/hd_searchblock.gif"
										styleClass="hd-searchblock" />
									<h:panelGroup styleClass="collapse-vert" layout="block" />
								</a4j:outputPanel>
							</h:panelGroup>
						</h:panelGroup>
					</h:panelGroup>
				</h:panelGroup>
            </h:form>

            <h:form id="deliveriesForm">
				<!-- result panel -->
				<h:panelGroup styleClass="search_result_block" layout="block" id="resultPanel">
					<h:panelGroup styleClass="search_result_block_left fix-ff"
						layout="block">
						<h:panelGroup id="mainTableWrapper" layout="block"
							styleClass="search_result_block_inner">
						<rich:extendedDataTable id="deliveriesTable" styleClass="res-table"
							tableState="#{MbDeliveries.tableState}"
							headerClass="res-table-header" rowClasses=",odd"
							selectedClass="res-table-selected" var="item"
							value="#{MbDeliveries.deliveries}"
							selection="#{MbDeliveries.itemSelection}"
							rows="#{MbDeliveries.rowsNum}" selectionMode="single"
							width="100%" height="255px" enableContextMenu="true"
							noDataLabel="#{MbDeliveries.searching ? lblCommon.no_records_found : lblCommon.enter_search_criteria_above}"
							reRender="#{MbDeliveries.tabName}">

							<a4j:support event="onselectionchange" eventsQueue="queue"
								limitToList="true" reRender="#{MbDeliveries.tabName}" />

                            <rich:column id="selectRow" label="#{lblForm.select_unselect_all}" title="SelectUnselectAll" sortable="false"
                                    width="12%">
                               <f:facet name="header">
                                    <h:panelGroup>
                                        <h:outputText value="#{lblForm.select_unselect_all}" title="#{lblForm.select_unselect_all}"
                                                      style="margin-right:10px;"/>
                                        <h:selectBooleanCheckbox value="#{MbDeliveries.allSelected}">
                                        <a4j:support event="onchange" reRender="resultPanel, btnPanel"
                                            limitToList="true" ajaxSingle="true" />
                                        </h:selectBooleanCheckbox>
                                    </h:panelGroup>
                               </f:facet>
                               <a4j:region>
                               <h:selectBooleanCheckbox id="select"
                                                        disabled="#{MbDeliveries.allSelected}"
                                                        value="#{item.selected}"
                                                        valueChangeListener="#{MbDeliveries.selectedCounts}">
                               <a4j:support event="onchange" reRender="btnPanel"
                                            limitToList="true" ajaxSingle="true" />
                               <a4j:support event="onchange" reRender="select"/>
                               </h:selectBooleanCheckbox>
                               </a4j:region>
                            </rich:column>

                            <rich:column id="card_mask" label="#{lblCrd.card_mask}" title="CardMask" sortable="false"
                                width="10%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblCrd.card_mask}" title="#{lblCrd.card_mask}" />
                                </f:facet>
                                <h:outputText value="#{item.cardMask}" />
                            </rich:column>

							<rich:column id="cardholder_name" label="#{lblIss.cardholder_name}" title="#{lblIss.cardholder_name}" sortable="false"
										 width="20%">
								<f:facet name="header">
									<h:outputText value="#{lblIss.cardholder_name}" title="#{lblIss.cardholder_name}" />
								</f:facet>
								<h:outputText value="#{item.cardholderName}" />
							</rich:column>

							<rich:column id="product" label="#{lblIss.product}" title="#{lblIss.product}" sortable="false"
										 width="20%">
								<f:facet name="header">
									<h:outputText value="#{lblIss.product}" title="#{lblIss.product}" />
								</f:facet>
								<h:outputText value="#{item.productId} - #{item.productName}" />
							</rich:column>

                            <rich:column id="seqNum" label="#{lblIss.seq_number}" title="SeqNum" sortable="false"
                                width="8%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblIss.seq_number}" title="#{lblIss.seq_number}" />
                                </f:facet>
                                <h:outputText value="#{item.seqNum}" />
                            </rich:column>

                            <rich:column id="issDate" label="#{lblIss.iss_date}" title="IssDate" sortable="false"
                                width="12%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblIss.iss_date}" title="#{lblIss.iss_date}" />
                                </f:facet>
                                <h:outputText value="#{item.issDate}">
                                    <f:convertDateTime pattern="#{usession.datePattern} HH:mm:ss"
                                        timeZone="#{CommonUtils.timeZone}" />
                                </h:outputText>
                            </rich:column>

                            <rich:column id="expDate" label="#{lblCommon.exp_date}" title="ExpDate" sortable="false"
                                width="12%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblCommon.exp_date}" title="#{lblCommon.exp_date}" />
                                </f:facet>
                                <h:outputText value="#{item.expDate}">
                                    <f:convertDateTime pattern="MM.yyyy"
                                        timeZone="#{CommonUtils.timeZone}" />
                                </h:outputText>
                            </rich:column>

                            <rich:column id="status" label="#{lblCommon.status}" title="Status" sortable="false"
                                width="8%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblCommon.status}" title="#{lblCommon.status}" />
                                </f:facet>
                                <h:outputText value="#{DictUtils.articles[item.status]}" title="#{DictUtils.articles[item.status]}"/>
                            </rich:column>

                            <rich:column id="state" label="#{lblIss.state}" title="State" sortable="false"
                                width="8%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblIss.state}" title="#{lblIss.state}" />
                                </f:facet>
                                <h:outputText value="#{DictUtils.articles[item.state]}" title="#{DictUtils.articles[item.state]}"/>
                            </rich:column>

                            <rich:column id="deliveryStatus" label="#{lblIss.DELIVERY_STATUS}" title="DeliveryStatus" sortable="false"
                                width="8%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblIss.DELIVERY_STATUS}" title="#{lblIss.DELIVERY_STATUS}" />
                                </f:facet>
                                <h:outputText value="#{DictUtils.articles[item.deliveryStatus]}" title="#{DictUtils.articles[item.deliveryStatus]}"/>
                            </rich:column>

                            <rich:column id="deliveryRefNum" label="#{lblIss.DELIV_REF_NUM}" title="DeliveryRefNum" sortable="false"
                                width="20%">
                                <f:facet name="header">
                                    <h:outputText value="#{lblIss.DELIV_REF_NUM}" title="#{lblIss.DELIV_REF_NUM}" />
                                </f:facet>
                                <h:outputText value="#{item.deliveryRefNum}" />
                            </rich:column>

						</rich:extendedDataTable>
						</h:panelGroup>
						<a4j:outputPanel ajaxRendered="true">
							<h:panelGroup id="show_more_panel" styleClass="show-more-vert show-more-result-tab" layout="block"/>
							<h:graphicImage url="/_img/hd_searchblock.gif"
								styleClass="hd-searchblock" />
							<h:panelGroup styleClass="collapse-vert table-collapse-vert"
								layout="block" />
						</a4j:outputPanel>
					</h:panelGroup>
				</h:panelGroup>
			</h:form>

			<!-- navigation -->
			<h:form id="deliveriesBtnForm">
				<h:panelGroup layout="block" styleClass="bottom_search_result_block">
					<h:panelGroup layout="block" styleClass="bottom_search_result_left">
						<h:panelGroup layout="block" styleClass="table_tools">
							<h:panelGrid styleClass="fw field-cont" columns="5"
								columnClasses="per-page-lbl,per-page-sel,nav-cont,pagecount, table_tools_state">
								<h:outputLabel for="rows_num" value="#{lblCommon.rows_per_page}" title="#{lblCommon.rows_per_page}" />
								<h:selectOneMenu id="rows_num" value="#{MbDeliveries.rowsNum}"
									styleClass="row_per_page">
								 <a4j:support event="onchange"
										reRender="deliveriesBtnForm, deliveriesTable, navdeliveries, pagesNum, #{MbDeliveries.tabName}" />
									<f:selectItems value="#{CommonUtils.rowNumsList}"/>
								</h:selectOneMenu>

								<rich:datascroller maxPages="10" fastControls="hide"
									pagesVar="pages" styleClass="res-datascroller" id="navdeliveries"
									for="deliveriesTable"
									reRender="#{MbDeliveries.tabName}"
									pageIndexVar="pageIndex">
									<f:facet name="first">
										<h:outputText value="&lt;&lt;" styleClass="prev-next" />
									</f:facet>
									<f:facet name="first_disabled">
										<h:outputText value="&lt;&lt;" styleClass="prev-next-dis" />
									</f:facet>
									<f:facet name="last">
										<h:outputText value="&gt;&gt;" styleClass="prev-next" />
									</f:facet>
									<f:facet name="last_disabled">
										<h:outputText value="&gt;&gt;" styleClass="prev-next-dis" />
									</f:facet>
									<f:facet name="previous">
										<h:outputText value="#{lblCommon.prev}" styleClass="prev-next" />
									</f:facet>
									<f:facet name="previous_disabled">
										<h:outputText value="#{lblCommon.prev}" styleClass="prev-next-dis" />
									</f:facet>
									<f:facet name="next">
										<h:outputText value="#{lblCommon.next}" styleClass="prev-next" />
									</f:facet>
									<f:facet name="next_disabled">
										<h:outputText value="#{lblCommon.next}" styleClass="prev-next-dis" />
									</f:facet>
									<f:facet name="pages">
									</f:facet>
								</rich:datascroller>

								<h:panelGroup id="pagesNum">
									<h:outputText styleClass="strongClass" value="#{pages} " />
									<h:outputText value=" #{lblCommon.pages}" />
                                    <h:outputText value="" style="padding-left: 20px; padding-right: 20px;" />
                                    <h:outputText styleClass="strongClass" value="#{MbDeliveries.deliveries.rowCount}"/>
                                    <h:outputText value=" #{lblCommon.records}"/>
                                    <h:outputText value="" style="padding-left: 20px; padding-right: 20px;" />
								</h:panelGroup>

								<h:panelGroup>
									<h:graphicImage url="/images/green-tick.png" title="#{lblCommon.save_table_state}" styleClass="action_icon"
										onclick="saveTableState();"/>
									<h:graphicImage url="/images/red-cross.png" title="#{lblCommon.delete_table_state}" styleClass="action_icon"
										onclick="deleteTableState();"/>
									<a4j:queue name="tablestatequeue"/>
									<a4j:jsFunction name="saveTableState" action="#{MbDeliveries.saveTableStateDB}" eventsQueue="tablestatequeue"/>
									<a4j:jsFunction name="deleteTableState" action="#{MbDeliveries.deleteTableStateDB}" eventsQueue="tablestatequeue"/>
								</h:panelGroup>
							</h:panelGrid>
						</h:panelGroup>
                    <h:panelGrid id="btnPanel" columns="4" styleClass="buttons_block">
                            <bre:taggedCommandButton id="changeStatusBtn"
                                value="#{lblEvt.change_status}"
                                oncomplete="#{rich:component('changeStatusModalPanel')}.show()"
                                disabled="#{MbDeliveries.selectedCount le 0}"
                                rendered="#{usession.inRole['MODIFY_DELIVERY_STATUS']}"/>
                            <bre:taggedCommandButton id="changeDeliveryRefNumBtn"
                                value="#{lblEvt.SET_DELIVERY_REF_NUM}"
                                oncomplete="#{rich:component('changeDeliveryRefNumModalPanel')}.show()"
                                disabled="#{MbDeliveries.selectedCount le 0}"
                                rendered="#{usession.inRole['MODIFY_DELIVERY_REF_NUM']}"/>
                    </h:panelGrid>
					</h:panelGroup>
				</h:panelGroup>
			</h:form>

			<h:panelGroup id="modalAppPage" >
                <f:subview id="modalAppPageSubView" >
                    <ui:include src="/pages/issuing/delivery/delivery_ref_num_search_modal.jspx" />
                </f:subview>
            </h:panelGroup>

            <h:form>
                <a4j:jsFunction name="storeTab" ajaxSingle="true" limitToList="true" reRender="#{MbDeliveries.rerenderList}">
                    <a4j:actionparam name="tabName" assignTo="#{MbDeliveries.tabName}" />
                </a4j:jsFunction>
            </h:form>

			<h:panelGroup styleClass="workplace" id="workplacePanel" layout="block">
				<rich:tabPanel switchType="client" id="details" tabClass="tab-cell"
					activeTabClass="active-tab-cell" headerClass="tabs"
					headerSpacing="0px" contentClass="tab-content"
					selectedTab="#{MbDeliveries.tabName}">

					<rich:tab ontabenter="storeTab('detailsTab')" label="#{lblCommon.details}" name="detailsTab" rendered="#{usession.inRole['VIEW_DELIVERY_DETAILS']}">
						<f:facet name="label">
							<h:panelGroup styleClass="first tab-label" layout="block">
								<h:outputText value="#{lblCommon.details}" title="#{lblCommon.details}" />
							</h:panelGroup>
						</f:facet>
						<h:panelGroup id="detailsTab" layout="block">
						  	<ui:include src="/pages/issuing/delivery/deliveryDetails.jspx"></ui:include>
							<h:panelGroup layout="block"
								styleClass="bottom_search_result_block_buttons"/>
						</h:panelGroup>
					</rich:tab>

					<rich:tab ontabenter="storeTab('statusLogsTab')" label="#{lblEvt.status_logs}" name="statusLogsTab"
					                      style="height:100%;" rendered="#{usession.inRole['VIEW_DELIVERY_STATUS_LOGS']}">
						<f:facet name="label">
							<h:panelGroup styleClass="tab-label" layout="block">
								<h:outputText value="#{lblEvt.status_logs}" title="#{lblEvt.status_logs}" />
							</h:panelGroup>
						</f:facet>
						<h:panelGroup id="statusLogsTab" layout="block" styleClass="carddata-wrapper"
                                      style="height: 100%; overflow: hidden;position:relative;">
                            <a4j:form id="logsSearchForm">
                            	<h:panelGrid styleClass="fw" columns="2" columnClasses="top ,link-cont">
                            		<a4j:outputPanel id="personPanel">
                                          	<h:panelGrid styleClass="filter-table field-cont twoColumnTable" columns="4" columnClasses="firstCol,secondCol,firstCol,secondCol">
                                      			<h:outputLabel for="dateLogsFrom" value="#{lblCommon.date_from}: " title="#{lblCommon.date_from}" />
                                      			<h:panelGroup>
                                         				<h:inputText id="dateLogsFrom" style="max-width:225px"
                                         						value="#{MbStatusLogs.filter.dateFrom}"
                            							onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('logsSearchForm:dateLogsFrom')}, #{rich:element('logsSearchForm:dateLogsFromBtn')});">
                            						<f:convertDateTime pattern="#{usession.datePattern}" timeZone="#{CommonUtils.timeZone}"/>
                            					</h:inputText>
                            					<h:graphicImage
                            							value="/images/calendar.gif"
                            							onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('logsSearchForm:dateLogsFrom')}, #{rich:element('logsSearchForm:dateLogsFromBtn')});"
                            							id="dateLogsFromBtn" />
                                         		</h:panelGroup>

                                      			<h:outputLabel for="dateLogsTo" value="#{lblCommon.date_to}: " title="#{lblCommon.date_to}" />
                                      			<h:panelGroup>
                                         				<h:inputText id="dateLogsTo" style="max-width:225px"
                                         						value="#{MbStatusLogs.filter.dateTo}"
                            							onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('logsSearchForm:dateLogsTo')}, #{rich:element('logsSearchForm:dateLogsToBtn')});">
                            						<f:convertDateTime pattern="#{usession.datePattern}" timeZone="#{CommonUtils.timeZone}"/>
                            					</h:inputText>
                            					<h:graphicImage
                            							value="/images/calendar.gif"
                            							onclick="#{rich:component('calendar')}.customExpand(event, #{rich:element('logsSearchForm:dateLogsTo')}, #{rich:element('logsSearchForm:dateLogsToBtn')});"
                            							id="dateLogsToBtn" />
                                         			</h:panelGroup>
                                       		</h:panelGrid>
                               		</a4j:outputPanel>
                               		<h:panelGrid columns="1">
                               			<bre:taggedCommandButton eventsQueue="queue"
                                				action="#{MbStatusLogs.search}" oncomplete="enableModalPanelBtns(this)"
                                				disabled="#{!MbStatusLogs.searching}"
                                				onclick="disableModalPanelBtns(this);"
                            					reRender="statusLogsForm"
                              						image="/_img/icon_search.png" type="submit"
                               					value="#{lblForm.refresh}" style="width:85px;"
                               					/>
                               		</h:panelGrid>
                            	</h:panelGrid>
                            </a4j:form>
                            <ui:include
                                    src="#{MbDeliveries.tabName=='statusLogsTab' ? '/pages/events/statusLogsList.jspx' : null}">
                                <ui:param name="renderColumnEventType" value="true"></ui:param>
                                <ui:param name="renderColumnSessionId" value="true"></ui:param>
                                <ui:param name="renderColumnUserName" value="true"></ui:param>

                            </ui:include>
                        </h:panelGroup>
					</rich:tab>

				    <rich:tab ontabenter="storeTab('statisticTab')" label="#{lblCommon.statistics}" name="statisticTab" style="height:100%;" rendered="#{usession.inRole['VIEW_DELIVERY_STATISTICS']}">
                        <f:facet name="label">
                            <h:panelGroup styleClass="tab-label" layout="block">
                                <h:outputText value="#{lblCommon.statistics}" title="#{lblCommon.statistics}"/>
                            </h:panelGroup>
                        </f:facet>

                        <h:panelGroup id="statisticTab" layout="block" styleClass="carddata-wrapper" style="height: 100%; overflow: hidden;position:relative;">
                            <ui:include src="/pages/issuing/delivery/deliveryStatistic.jspx"></ui:include>
                        </h:panelGroup>
                    </rich:tab>

				</rich:tabPanel>
			</h:panelGroup>

			<script type="text/javascript">

				function updateHeight(){
                    updateGridHeight();
				}

                layout =
                        {
                            SEARCH_FORM_ID:                 'deliveriesSearchForm',
                            SEARCH_RESULT_FORM_ID:          'deliveriesForm',
                            SEARCH_RESULT_FORM_WRAPPER_ID:  'mainTableWrapper',
                            SEARCH_RESULT_FOOTER_FORM_ID:   'deliveriesBtnForm',
                            TAB_PANEL_ID:                   'workplacePanel',

                            TAB_DATA:      [{
                                TAB_FORM_ID:            'deliveriesDetailsForm',
                                TAB_FORM_WRAPPER_ID:    'deliveriesDetailsWrapper',
                                CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
                            }, {
                                TAB_FORM_ID:            'statusLogsForm',
                                TAB_FORM_WRAPPER_ID:    'statusLogsTableWrapper',
                                CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
                            }, {
                                TAB_FORM_ID:            'statisticBtmForm',
                                TAB_FORM_WRAPPER_ID:    'statisticTableWrapper',
                                CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
                            }]
                        };

				updateHeight();
                jQuery(window).resize(updateHeight);
			</script>

		</h:panelGroup>

		<h:panelGroup rendered="#{!usession.inRole['VIEW_DELIVERY']}"
			style="text-align: center">
			<h:outputText value="#{lblMsg.insufficient_rights}"
				style="font-size: 5em" />
		</h:panelGroup>

		<rich:modalPanel id="changeStatusModalPanel" autosized="true" minWidth="300" minHeight="50">
            <f:facet name="header">
                <h:panelGroup id="changeStatusModalHeader">
                    <h:outputText value="#{lblEvt.change_status}"/>
                </h:panelGroup>
            </f:facet>
            <f:facet name="controls">
            </f:facet>
            <h:form id="changeStatusModalDiv">
                <h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
                    <h:panelGrid columns="2" styleClass="cardholderdata" columnClasses="firstColModal, width250">

                        <h:outputLabel value="#{lblIss.DELIVERY_STATUS}" title="#{lblIss.DELIVERY_STATUS}"/>
                        <h:selectOneMenu id="changeStatus"
                            value="#{MbDeliveries.deliveryStatus}">
                            <f:selectItems value="#{MbDeliveries.deliveryStatuses}" />
                        </h:selectOneMenu>

                    </h:panelGrid>
                </h:panelGroup>

                <h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
                    <h:panelGroup layout="block" styleClass="bottom_search_result_left_buttons">
                        <h:panelGrid columns="3" columnClasses="width99P,,paddingR12">
                            <h:outputText/>
                            <bre:taggedCommandButton
                                    value="#{lblForm.ok}" type="submit" action="#{MbDeliveries.changeDeliveryStatus}"
                                    oncomplete="enableModalPanelBtns(this); if (#{usession.noErrorResponse}) #{rich:component('changeStatusModalPanel')}.hide();
                                                document.getElementById('deliveriesSearchForm:searchBtn').click();"
                                    />
                            <bre:taggedCommandButton
                                    value="#{lblForm.cancel}"
                                    oncomplete="#{rich:component('changeStatusModalPanel')}.hide()"
                                    >
                                <f:actionListener type="ru.bpc.jsf.A4JFormReset"/>
                            </bre:taggedCommandButton>
                        </h:panelGrid>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </rich:modalPanel>

        <rich:modalPanel id="changeDeliveryRefNumModalPanel" autosized="true" minWidth="300" minHeight="50">
            <f:facet name="header">
                <h:panelGroup id="changeDeliveryRefNumModalHeader">
                    <h:outputText value="#{lblEvt.SET_DELIVERY_REF_NUM}"/>
                </h:panelGroup>
            </f:facet>
            <f:facet name="controls">
            </f:facet>
            <h:form id="changeDeliveryRefNumModalDiv">
                <h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
                    <h:panelGrid columns="2" styleClass="cardholderdata" columnClasses="firstColModal, width250">

                        <h:outputLabel value="#{lblIss.DELIV_REF_NUM}" title="#{lblIss.DELIV_REF_NUM}"/>
                        <h:inputText id="changeDeliveryRefNum"
                                     value="#{MbDeliveries.deliveryRefNum}" />

                    </h:panelGrid>
                </h:panelGroup>

                <h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
                    <h:panelGroup layout="block" styleClass="bottom_search_result_left_buttons">
                        <h:panelGrid columns="3" columnClasses="width99P,,paddingR12">
                            <h:outputText/>
                            <bre:taggedCommandButton
                                    value="#{lblForm.SUBMIT}"
                                    oncomplete="#{rich:component('changeDeliveryRefNumView:confirmPanel')}.show()"/>
                            <bre:taggedCommandButton
                                    value="#{lblForm.cancel}"
                                    oncomplete="#{rich:component('changeDeliveryRefNumModalPanel')}.hide()"
                                    >
                                <f:actionListener type="ru.bpc.jsf.A4JFormReset"/>
                            </bre:taggedCommandButton>
                        </h:panelGrid>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </rich:modalPanel>

        <ui:include src="/pages/utils/confirmPanel.jspx">
            <ui:param name="backingBean" value="#{MbDeliveries}"/>
            <ui:param name="yesAction" value="changeDeliveryRefNum"/>
            <ui:param name="warningMsg" value="Set delivery reference number for selected cards?"/>
            <ui:param name="confirmQuestion" value=" "/>
            <ui:param name="subviewId" value="changeDeliveryRefNumView"/>
            <ui:param name="yes" value="#{lblForm.ok}"/>setDeliveryRefNumComplete()
            <ui:param name="no" value="#{lblForm.cancel}"/>
            <ui:param name="completeScript" value="setDeliveryRefNumComplete()"/>
        </ui:include>

	</ui:define>
</ui:composition>
</html>
