<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="aut">
	
	<!-- Common sql configuration not included in SqlMapConfig -->
	<sql id="limitationOpen">
            SELECT *
            FROM (                
    </sql>
    
    <sql id="limitationOpenCount">
            SELECT count(*)
            FROM (                
    </sql>
    
    <sql id="limitationClose">               
            	) q
            <isNotNull property="limitation" prepend=" WHERE ">$limitation$</isNotNull>
    </sql>
	
	<sql id="paginatedOpen">
		SELECT *
		FROM(
		SELECT a.*, rownum r
		FROM(
		<include refid="limitationOpen"/>
	</sql>

	<sql id="paginatedClose">
		<include refid="limitationClose"/>
		) a
		WHERE rownum <![CDATA[<]]>=
		(#range.end# + 1)
		)
		WHERE r >= (#range.start# + 1)
	</sql>
	
	<resultMap  id="get-resp-codes-mapping"
            class="ru.bpc.sv2.aut.RespCode"  >
	    <result property="id" column="id" />
	    <result property="seqnum" column="seqnum" />
	    <result property="respCode" column="resp_code" />
	    <result property="isReversal" column="is_reversal" />
	    <result property="procType" column="proc_type" />
	    <result property="authStatus" column="auth_status" />
	    <result property="procMode" column="proc_mode" />
	    <result property="statusReason" column="status_reason" />
	    <result property="operType" column="oper_type" />
	    <result property="priority" column="priority" />
	    <result property="msgType" column="msg_type" />
	    <result property="signCompletion" column="is_completed" />
	    <result property="sttlType" column="sttl_type" />
	    <result property="operReason" column="oper_reason" />
	</resultMap>
	
	<select id="get-resp-codes" parameterClass="qparams"
		resultMap="get-resp-codes-mapping">
		<include refid="paginatedOpen" />
		SELECT
			  rc.id
			, rc.seqnum
			, rc.resp_code
			, rc.is_reversal
			, rc.proc_type
			, rc.auth_status
			, rc.proc_mode
			, rc.status_reason
			, rc.oper_type
			, rc.priority
			, rc.msg_type
			, rc.is_completed
			, rc.sttl_type
			, rc.oper_reason
		FROM
			aut_ui_resp_code_vw rc
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">rc.id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="respCode">rc.resp_code = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procType">rc.proc_type = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="authStatus">rc.auth_status = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procMode">rc.proc_mode = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="statusReason">rc.status_reason = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="operType">#filters[].value# like rc.oper_type</isEqual>
			<isEqual property="filters[].element" compareValue="sttlType">rc.sttl_type like #filters[].value#</isEqual>
		</iterate>
		<iterate prepend="ORDER BY" conjunction=", " property="sorting">
			<isNotEqual property="sorting[].direction" compareValue="AUTO">
				<isEqual property="sorting[].property" compareValue="id">rc.id $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="seqnum">rc.seqnum $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="respCode">rc.resp_code $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="isReversal">rc.is_reversal $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="procType">rc.proc_type $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="authStatus">rc.auth_status $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="procMode">rc.proc_mode $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="statusReason">rc.status_reason $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="operType">rc.oper_type $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="priority">rc.priority $sorting[].direction$</isEqual>		
				<isEqual property="sorting[].property" compareValue="sttlType">rc.sttl_type $sorting[].direction$</isEqual>		
			</isNotEqual>
		</iterate>
		<include refid="paginatedClose" />
	</select>
	
	<select id="get-resp-codes-count" parameterClass="qparams"
		resultClass="int">
		<include refid="limitationOpenCount"/>
		SELECT
			rc.id
		FROM
			aut_ui_resp_code_vw rc
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">rc.id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="respCode">rc.resp_code = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procType">rc.proc_type = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="authStatus">rc.auth_status = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procMode">rc.proc_mode = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="statusReason">rc.status_reason = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="operType">#filters[].value# like rc.oper_type</isEqual>
			<isEqual property="filters[].element" compareValue="sttlType">rc.sttl_type like #filters[].value#</isEqual>
		</iterate>
		<include refid="limitationClose"/>
	</select>	
	
	<procedure id="add-resp-code"
		parameterClass="ru.bpc.sv2.aut.RespCode">
		{call AUT_UI_RESP_CODE_PKG.add_resp_code(
			  o_id            => #id,mode=OUT,jdbcType=NUMERIC#
			, o_seqnum        => #seqnum,mode=OUT,jdbcType=NUMERIC#
			, i_resp_code     => #respCode#
			, i_is_reversal   => #isReversal#
			, i_proc_type     => #procType#
			, i_auth_status   => #authStatus#
			, i_proc_mode     => #procMode#
			, i_status_reason => #statusReason#
			, i_oper_type     => #operType#
			, i_oper_reason	  => #operReason#
			, i_msg_type      => #msgType#
			, i_priority      => #priority#
			, i_is_completed  => #signCompletion#
			, i_sttl_type     => #sttlType#
		)}
	</procedure>
	
	<procedure id="modify-resp-code"
		parameterClass="ru.bpc.sv2.aut.RespCode">
		{call AUT_UI_RESP_CODE_PKG.modify_resp_code(
			  i_id            => #id#
			, io_seqnum       => #seqnum,mode=INOUT,jdbcType=NUMERIC#
			, i_resp_code     => #respCode#
			, i_is_reversal   => #isReversal#
			, i_proc_type     => #procType#
			, i_auth_status   => #authStatus#
			, i_proc_mode     => #procMode#
			, i_status_reason => #statusReason#
			, i_oper_type     => #operType#
			, i_oper_reason	  => #operReason#
			, i_msg_type      => #msgType#
			, i_priority      => #priority#
			, i_is_completed  => #signCompletion#
			, i_sttl_type     => #sttlType#
		)}
	</procedure>
	
	<procedure id="remove-resp-code"
			parameterClass="ru.bpc.sv2.aut.RespCode">
		{call AUT_UI_RESP_CODE_PKG.remove_resp_code(
			  i_id			=> #id#
			, i_seqnum		=> #seqnum#
		)}
	</procedure>

	<resultMap  id="authorization-map"
            class="ru.bpc.sv2.aut.Authorization">
	    <result property="id" column="id"/>
	    <result property="respCode" column="resp_code"/>
	    <result property="procType" column="proc_type"/>
	    <result property="procMode" column="proc_mode"/>
	    <result property="isAdvice" column="is_advice" javaType="boolean" jdbcType="NUMBER"/>
	    <result property="isRepeat" column="is_repeat" javaType="boolean" jdbcType="NUMBER"/>
	    <result property="isCompleted" column="is_completed" javaType="java.lang.String" jdbcType="VARCHAR"/>
	    <result property="binAmount" column="bin_amount"/>
	    <result property="binCurrency" column="bin_currency"/>
	    <result property="binCnvtRate" column="bin_cnvt_rate"/>
	    <result property="networkAmount" column="network_amount"/>
	    <result property="networkCurrency" column="network_currency"/>
	    <result property="networkCnvtDate" column="network_cnvt_date" javaType="java.util.Date" jdbcType="DATE"/>
	    <result property="networkCnvtRate" column="network_cnvt_rate"/>
	    <result property="accountCnvtRate" column="account_cnvt_rate"/>
	    <result property="parentId" column="parent_id"/>
	    <result property="addrVerifResult" column="addr_verif_result"/>
	    <result property="issNetworkDeviceId" column="iss_network_device_id"/>
	    <result property="acqDeviceId" column="acq_device_id"/>
	    <result property="acqRespCode" column="acq_resp_code"/>
	    <result property="acqDeviceProcResult" column="acq_device_proc_result"/>
	    <result property="catLevel" column="cat_level"/>
	    <result property="cardDataInputCap" column="card_data_input_cap"/>
	    <result property="crdhAuthCap" column="crdh_auth_cap"/>
	    <result property="cardCaptureCap" column="card_capture_cap"/>
	    <result property="terminalOperatingEnv" column="terminal_operating_env"/>
	    <result property="crdhPresence" column="crdh_presence"/>
	    <result property="cardPresence" column="card_presence"/>
	    <result property="cardDataInputMode" column="card_data_input_mode"/>
	    <result property="crdhAuthMethod" column="crdh_auth_method"/>
	    <result property="crdhAuthEntity" column="crdh_auth_entity"/>
	    <result property="cardDataOutputCap" column="card_data_output_cap"/>
	    <result property="terminalOutputCap" column="terminal_output_cap"/>
	    <result property="pinCaptureCap" column="pin_capture_cap"/>
	    <result property="pinPresence" column="pin_presence"/>
	    <result property="cvv2Presence" column="cvv2_presence"/>
	    <result property="cvcIndicator" column="cvc_indicator"/>
	    <result property="posEntryMode" column="pos_entry_mode"/>
	    <result property="posCondCode" column="pos_cond_code"/>
	    <result property="emvData" column="emv_data"/>
	    <result property="atc" column="atc"/>
	    <result property="tvr" column="tvr"/>
	    <result property="cvr" column="cvr"/>
	    <result property="addlData" column="addl_data"/>
	    <result property="serviceCode" column="service_code"/>
	    <result property="deviceDate" column="device_date" javaType="java.util.Date" jdbcType="DATE"/>
	    <result property="cvv2Result" column="cvv2_result"/>
	    <result property="certificateMethod" column="certificate_method"/>
	    <result property="certificateType" column="certificate_type"/>
	    <result property="merchantCertif" column="merchant_certif"/>
	    <result property="cardholderCertif" column="cardholder_certif"/>
	    <result property="ucafIndicator" column="ucaf_indicator"/>
	    <result property="isEarlyEmv" column="is_early_emv" javaType="boolean" jdbcType="NUMBER"/>
	    <result property="issDeviceName" column="iss_device_name"/>
	    <result property="acqDeviceName" column="acq_device_name"/>
		<result property="externalAuthId" column="external_auth_id"/>
		<result property="externalOrigId" column="external_orig_id"/>
		<result property="authPurposeId" column="auth_purpose_id"/>
	</resultMap>

	<select id="get-authorizations" 
	        parameterClass="qparams"
	        resultMap="authorization-map">
	    <include refid="limitationOpen"/>
		SELECT
				  a.id
				, a.resp_code
				, a.proc_type
				, a.proc_mode
				, a.is_advice
				, a.is_repeat
				, a.is_completed
				, a.bin_amount
				, a.bin_currency
				, a.bin_cnvt_rate
				, a.network_amount
				, a.network_currency
				, a.network_cnvt_date
				, a.network_cnvt_rate
				, a.account_cnvt_rate
				, a.parent_id
				, a.addr_verif_result
				, a.iss_network_device_id
				, a.acq_device_id
				, a.acq_resp_code
				, a.acq_device_proc_result
				, a.cat_level
				, a.card_data_input_cap
				, a.crdh_auth_cap
				, a.card_capture_cap
				, a.terminal_operating_env
				, a.crdh_presence
				, a.card_presence
				, a.card_data_input_mode
				, a.crdh_auth_method
				, a.crdh_auth_entity
				, a.card_data_output_cap
				, a.terminal_output_cap
				, a.pin_capture_cap
				, a.pin_presence
				, a.cvv2_presence
				, a.cvc_indicator
				, a.pos_entry_mode
				, a.pos_cond_code
				, a.emv_data
				, a.atc
				, a.tvr
				, a.cvr
				, a.addl_data
				, a.service_code
				, a.device_date
				, a.cvv2_result
				, a.certificate_method
				, a.certificate_type
				, a.merchant_certif
				, a.cardholder_certif
				, a.ucaf_indicator
				, a.is_early_emv
				, d1.caption AS iss_device_name
				, d2.caption AS acq_device_name
				, a.external_auth_id
				, a.external_orig_id
				, a.auth_purpose_id
		FROM aut_ui_auth_vw a, cmn_ui_device_vw d1, cmn_ui_device_vw d2
		WHERE a.iss_network_device_id = d1.id(+)
				AND a.acq_device_id = d2.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">a.id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">
				d1.lang(+) = #filters[].value# AND d2.lang(+) = #filters[].value#
			</isEqual>
			<isEqual property="filters[].element" compareValue="respCode">a.resp_code = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procType">a.proc_type = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procMode">a.proc_mode = #filters[].value#</isEqual>
		</iterate>
		<include refid="limitationClose"/>
	</select>
	
	<select id="get-authorizations-count" 
	        parameterClass="qparams"
	        resultClass="int">
		<include refid="limitationOpenCount"/>
		SELECT a.id
		FROM aut_ui_auth_vw a
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">a.id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="respCode">a.resp_code = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procType">a.proc_type = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="procMode">a.proc_mode = #filters[].value#</isEqual>
		</iterate>
		<include refid="limitationClose"/>
	</select>	
</sqlMap>