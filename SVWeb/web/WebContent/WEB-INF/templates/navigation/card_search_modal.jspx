<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:a4j="http://richfaces.org/a4j"
      xmlns:rich="http://richfaces.org/rich"
      xmlns:bm="http://www.bpc.ru/jsf/misc"
      xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext">
<ui:composition>
    <f:loadBundle var="lblApp" basename="ru.bpc.sv2.ui.bundles.App"/>
    <f:loadBundle var="lblCrd" basename="ru.bpc.sv2.ui.bundles.Crd"/>
    <f:loadBundle var="lblPrd" basename="ru.bpc.sv2.ui.bundles.Prd"/>
    <f:loadBundle var="lblCommon" basename="ru.bpc.sv2.ui.bundles.Common"/>
    <f:loadBundle var="lblOst" basename="ru.bpc.sv2.ui.bundles.Ost"/>

    <a4j:loadScript src="/js/calendarUtils.js"/>

    <rich:modalPanel id="#{viewIdColon}cardSearchModalPanel" autosized="true" minWidth="900" minHeight="200">
        <f:facet name="header">
            <h:outputText value="#{lblCrd.card}" />
        </f:facet>
        <f:facet name="controls"/>
        <h:form id="#{viewIdColon}cardsSearchModalForm">
            <a4j:region>
                <a4j:status id="ajaxStatus1" />
                <a4j:jsFunction name="setSearchTabName" reRender="err_ajax"
                                limitToList="true" ajaxSingle="true" status="ajaxStatus1">
                    <a4j:actionparam name="tabName" assignTo="#{MbCardSearchModal.searchTabName}" />
                </a4j:jsFunction>
            </a4j:region>

            <a4j:queue name="queue" requestDelay="500" ignoreDupResponses="true" size="1" sizeExceededBehavior="dropNew"/>
        </h:form>

        <!-- search panel -->
        <h:panelGroup layout="block" styleClass="search_block_tabs">
            <h:panelGroup layout="block" styleClass="search_block_tab">
                <h:panelGroup layout="block" styleClass="search_block search_block_inner search_block_inner-hidden"
                              style="height: 76px;">
                    <h:form id="#{viewIdColon}cardFindForm">
                        <h:panelGrid styleClass="fw" columns="2" columnClasses="top ,link-cont">
                            <a4j:outputPanel id="cardsPanel">
                                <h:panelGrid styleClass="filter-table field-cont twoColumnTable"
                                             columns="6" columnClasses="firstCol,secondCol,firstCol,secondCol,firstCol,secondCol">
                                    <h:outputLabel for="instId" value="#{lblCommon.institution}: " title="#{lblCommon.institution}"
                                                   style="width: 100px;"/>
                                    <h:selectOneMenu id="instId" value="#{MbCardSearchModal.filter.instId}"
                                                     style="width: 150px;">
                                        <f:selectItem itemValue=""/>
                                        <f:selectItems value="#{MbCardSearchModal.institutions}"/>
                                        <a4j:support event="onchange"
                                                     reRender="#{viewIdColon}cardFindForm:agentId"
                                                     limitToList="true" ajaxSingle="true"/>
                                    </h:selectOneMenu>

                                    <h:outputLabel for="agentId" value="#{lblOst.agent_id}:"
                                                   style="width: 100px;"/>
                                    <h:selectOneMenu id="agentId" value="#{MbCardSearchModal.filter.agentId}"
                                                     style="width: 150px;">
                                        <f:selectItem itemValue=""/>
                                        <f:selectItems value="#{MbCardSearchModal.agents}"/>
                                        <a4j:support event="onchange" limitToList="true" ajaxSingle="true"/>
                                    </h:selectOneMenu>

                                    <h:outputLabel for="cardTypeFilter" value="#{lblIss.card_type}: " title="#{lblIss.card_type}"
                                                   style="width: 100px;"/>
                                    <h:selectOneMenu id="cardTypeFilter" value="#{MbCardSearchModal.filter.cardTypeId}"
                                                     style="width: 150px;">
                                        <f:selectItem itemValue=""/>
                                        <f:selectItems value="#{MbCardSearchModal.cardTypes}"/>
                                    </h:selectOneMenu>

                                    <h:outputLabel for="numberFilter" value="#{lblIss.card_number}: " title="#{lblIss.card_number}"
                                                   style="width: 100px;"/>
                                    <h:inputText id="numberFilter" value="#{MbCardSearchModal.filter.cardNumber}"
                                                 style="width: 145px;"/>

                                    <h:outputText value="#{lblCommon.exp_date}:"
                                                  style="width: 100px;"/>
                                    <h:panelGroup>
                                        <h:inputText id="expDate" style="max-width:175px; width: 117px;"
                                                     value="#{MbCardSearchModal.filter.expDate}"
                                                     onclick="#{rich:component('calendar')}.customExpand(event,
                                                                                                         #{rich:element('cardFindForm:expDate')},
                                                                                                         #{rich:element('cardFindForm:expDateBtn')});">
                                            <f:convertDateTime pattern="#{usession.datePattern}"/>
                                            <a4j:support event="onchange" reRender="#{viewIdColon}cardFindForm:expDate"
                                                         limitToList="true" ajaxSingle="true"/>
                                        </h:inputText>
                                        <h:graphicImage value="/images/calendar.gif"
                                                        onclick="#{rich:component('calendar')}.customExpand(event,
                                                                                                            #{rich:element('cardFindForm:expDate')},
                                                                                                            #{rich:element('cardFindForm:expDateBtn')});"
                                                        id="expDateBtn">
                                            <a4j:support event="onchange" reRender="#{viewIdColon}cardFindForm:expDate"
                                                         limitToList="true" ajaxSingle="true"/>
                                        </h:graphicImage>
                                    </h:panelGroup>

                                    <h:outputText value="#{lblPrd.customer_number}:"
                                                  style="width: 100px;"/>
                                    <h:panelGroup>
                                        <h:inputText id="customerNumber" value="#{MbCardSearchModal.filter.customerNumber}"
                                                     style="width: 145px;"/>
                                    </h:panelGroup>

                                    <h:outputText value="#{lblIss.cardholder_number}:"/>
                                    <h:panelGroup>
                                        <h:inputText id="cardholderNumber" value="#{MbCardSearchModal.filter.cardholderNumber}"
                                                     style="width: 145px;"/>
                                    </h:panelGroup>

                                    <h:outputText value="#{lblPrd.contract_type}:"
                                                  style="width: 100px;"/>
                                    <h:panelGroup>
                                        <h:inputText id="contractType1" readonly="true" style="width: 145px;"
                                                     value="#{DictUtils.articlesByLang[MbCardSearchModal.curLang][MbCardSearchModal.filter.contractType]}"
                                                     rendered="#{MbCardSearchModal.filter.contractType != null}"/>
                                        <h:selectOneMenu id="contractType2" value="#{MbCardSearchModal.contractType}"
                                                         style="width: 150px;" rendered="#{MbCardSearchModal.filter.contractType == null}">
                                            <f:selectItem itemValue=""/>
                                            <f:selectItems value="#{MbCardSearchModal.contractTypes}"/>
                                        </h:selectOneMenu>
                                    </h:panelGroup>

                                    <h:outputText value="#{lblCommon.product_number}:"
                                                  style="width: 100px;"/>
                                    <h:panelGroup>
                                        <h:inputText id="productNumber" value="#{MbCardSearchModal.filter.productNumber}"
                                                     style="width: 145px;"/>
                                    </h:panelGroup>
                                </h:panelGrid>
                            </a4j:outputPanel>
                            <h:panelGrid columns="1">
                                <bre:taggedCommandButton
                                        action="#{MbCardSearchModal.search}" eventsQueue="queue"
                                        onclick="flushTabs();"
                                        reRender="#{viewIdColon}cardResultModalForm"
                                        image="/_img/icon_search.png" type="submit"
                                        value="#{lblForm.search}" style="width:85px;">
                                </bre:taggedCommandButton>
                                <h:panelGrid columns="1">
                                    <h:panelGroup styleClass="link-clear" layout="block">
                                        <h:graphicImage url="/_img/icon_clear.png"/>
                                        <a4j:commandLink value="#{lblForm.clear_all}"
                                                         reRender="#{viewIdColon}cardsSearchModalForm,
                                                                   #{viewIdColon}cardFindForm,
                                                                   #{viewIdColon}cardResultModalForm"
                                                         action="#{MbCardSearchModal.clearFilter}"/>
                                    </h:panelGroup>
                                </h:panelGrid>
                            </h:panelGrid>
                        </h:panelGrid>
                    </h:form>
                </h:panelGroup>
            </h:panelGroup>
        </h:panelGroup>

        <h:form id="#{viewIdColon}cardResultModalForm">
            <rich:extendedDataTable id="cardsTable"
                                    tableState="#{MbCardSearchModal.tableState}"
                                    styleClass="res-table" headerClass="res-table-header"
                                    rowClasses=",odd" selectedClass="res-table-selected" var="item"
                                    value="#{MbCardSearchModal.cards}"
                                    selection="#{MbCardSearchModal.itemSelection}"
                                    height="255px" selectionMode="single" width="100%"
                                    enableContextMenu="true"
                                    noDataLabel="#{MbCardSearchModal.searching ? lblCommon['no_records_found'] : lblCommon['enter_search_criteria_above']}">
                <rich:column id="card_uid" label="#{lblCrd.card_uid}" title="Card uid" sortBy="#{'card_uid'}" width="20%">
                    <f:facet name="header">
                        <h:outputText value="#{lblCrd.card_uid}" title="#{lblCrd.card_uid}"/>
                    </f:facet>
                    <h:outputText value="#{item.cardUid}" title="#{item.cardUid}"/>
                </rich:column>

                <rich:column id="card_mask" label="#{lblCrd.card_mask}" title="Card mask" sortBy="#{'card_mask'}" width="20%">
                    <f:facet name="header">
                        <h:outputText value="#{lblCrd.card_mask}" title="#{lblCrd.card_mask}"/>
                    </f:facet>
                    <h:outputText value="#{item.mask}" title="#{item.mask}"/>
                </rich:column>

                <rich:column id="cardholder" label="#{lblIss.cardholder}" title="Customer type" width="60%">
                    <f:facet name="header">
                        <h:outputText value="#{lblIss.cardholder}" title="#{lblIss.cardholder}"/>
                    </f:facet>
                    <h:outputText value="#{item.cardholderNumber} - #{item.cardholderName}"
                                  title="#{item.cardholderNumber} - #{item.cardholderName}"/>
                </rich:column>
            </rich:extendedDataTable>

            <h:panelGroup layout="block"
                          styleClass="bottom_search_result_block_buttons">
                <h:panelGroup layout="block"
                              styleClass="bottom_search_result_left_buttons">
                    <h:panelGrid columns="3" columnClasses="width99P,,paddingR12">
                        <h:outputText />
                        <bre:taggedCommandButton id="selectBtn" value="#{lblApp.select}"
                                                 action="#{viewScope[MbCardSearchModal.beanName][MbCardSearchModal.methodName]}"
                                                 reRender="${MbCardSearchModal.renderList}"
                                                 oncomplete="if (#{usession.noErrorResponse}) Richfaces.hideModalPanel('#{extraIdColon}#{viewIdColon}cardSearchModalPanel');" />
                        <bre:taggedCommandButton value="#{lblForm.cancel}"
                                                 immediate="true" limitToList="true"
                                                 oncomplete="Richfaces.hideModalPanel('#{extraIdColon}#{viewIdColon}cardSearchModalPanel')" />

                    </h:panelGrid>
                </h:panelGroup>
            </h:panelGroup>
        </h:form>
    </rich:modalPanel>
</ui:composition>
</html>
