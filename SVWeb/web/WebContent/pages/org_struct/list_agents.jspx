<?xml version="1.0" encoding="UTF-8"?>
<html	xmlns="http://www.w3.org/1999/xhtml"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:a4j="http://richfaces.org/a4j"
		xmlns:rich="http://richfaces.org/rich"
		xmlns:bm="http://www.bpc.ru/jsf/misc"
		xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext"
		xmlns:my="http://mycompany.org/inputDate"
		xmlns:o="http://openfaces.org/"
		xmlns:bpct="http://www.bpc.ru/jsf/tiles">
<ui:composition	template="/WEB-INF/templates/navigatable.jspx">
	<ui:define name="helpContent">
		<a class="helplink" style="font-size:12px"
				target="_blank" id="help_btn"
				href="#{request.contextPath}/pages/help/index.html?managing_agents.htm"						
				>			
			<h:outputText value="#{lblCommon.help}"/>
		</a>		
	</ui:define>
	
    <ui:define name="navigatableContent">
    
    	<script type="text/javascript">
//<!--
			function checkInst() {
				var instIdEl = document.getElementById("agentsSearchForm:instId");
				if (instIdEl.value == null || instIdEl.value == "") {
					instIdEl.style.backgroundColor = "#FF9999";
					instIdEl.focus();
					return false;
				} else {
					instIdEl.style.backgroundColor = "#FFFFFF";
				}
				return true;
	    	}
    	//-->
    	</script>
		<f:loadBundle var="lblOst" basename="ru.bpc.sv2.ui.bundles.Ost"/>
		<f:loadBundle var="lblPrd" basename="ru.bpc.sv2.ui.bundles.Prd"/>
		<f:loadBundle var="lblNote" basename="ru.bpc.sv2.ui.bundles.Ntb"/>
		<a4j:loadScript src="/js/stretch.js" />
		
		<h:panelGroup rendered="#{usession.inRole['VIEW_AGENT']}">
			<!-- navigation bar -->
	        <bpct:navBar pageName="#{lblOst.agents}"/>
		</h:panelGroup>
		<a4j:queue name="queue" requestDelay="500" ignoreDupResponses="true" size="1" sizeExceededBehavior="dropNew"/>
		<script type="text/javascript">
		//<![CDATA[
		function handleEnter(event) {
			 if (event.keyCode == 13) {
				 document.getElementById('agentsSearchForm:searchBtn').click(); 
				 return false; 
			} 
			return true;
		 }	
		//]]>
		</script>
		<h:form id="agentsSearchForm" rendered="#{usession.inRole['VIEW_AGENT']}" onkeypress="handleEnter(event)">
		
			<!-- search panel -->
			<h:panelGroup styleClass="search_block" layout="block">
				<h:panelGroup layout="block" styleClass="search_block_inner1">
					<h:panelGroup layout="block" styleClass="search_block_inner2">
		                <h:panelGroup styleClass="search_block_left" layout="block">
		                	<h:panelGrid styleClass="fw" columns="2" columnClasses="top ,link-cont">
			                	<h:panelGrid styleClass="filter-table field-cont twoColumnTable" columns="4" columnClasses="firstCol,secondCol,firstCol,secondCol">

		                			<h:outputLabel value="#{lblOst.institution}:" title="#{lblOst.institution}" />
					      			<h:selectOneMenu id="instId"
					      						value="#{MbAgent.filter.instId}">
					      				<a4j:support event="onchange" limitToList="true"
					      					oncomplete="document.getElementById('agentsSearchForm:instId').focus();"
											reRender="parentId" />
					      				<f:selectItem itemValue=""/>
					      				<f:selectItems value="#{MbAgent.institutions}"/>
					      			</h:selectOneMenu>

		                			<h:outputLabel value="#{lblCommon.name}:" title="#{lblCommon.name}" />
		                			<h:inputText value="#{MbAgent.filter.name}"/>

		                			<h:outputLabel value="#{lblCommon.type}:" title="#{lblCommon.type}" />
		                			<h:selectOneMenu value="#{MbAgent.filter.type}">
		                				<f:selectItems value="#{MbAgent.agentTypes}"/>
		                			</h:selectOneMenu>

			            			<h:outputLabel value="#{lblOst.external_number}:" title="#{lblOst.external_number}" />
		                			<h:inputText value="#{MbAgent.filter.externalNumber}"/>
		                			
		                			<h:outputLabel value="#{lblCommon.parent}: " title="#{lblCommon.parent}"/>
									<h:selectOneMenu id="parentId" value="#{MbAgent.parentId}">
										<f:selectItem itemValue=""/>
										<f:selectItems value="#{MbAgent.parentAgentsFilter}"/>
									</h:selectOneMenu>
			                	</h:panelGrid>
			                	<h:panelGrid columns="1" >
			                		<bre:taggedCommandButton image="/_img/icon_search.png" type="submit"
			                				value="#{lblForm.search}" style="width:85px;"
			                				action="#{MbAgent.searchAgents}"
			                				id="searchBtn"
			                				onclick="if (!checkInst()) return false; disableModalPanelBtns(this);"
			                				oncomplete="enableModalPanelBtns(this);"
			                				reRender="agentsForm:agentsTreeTable, agentsBtnForm:btnPanel, agentsSearchForm:instId, #{MbAgent.tabName}"
			                				eventsQueue="queue"/>
	
			                		<h:panelGroup styleClass="link-clear" layout="block"  >
			                			<h:graphicImage url="/_img/icon_clear.png"/>
			                			<a4j:commandLink value="#{lblForm.clear_all}"
			                					action="#{MbAgent.clearFilter}"
			                					reRender="agentsSearchForm, agentsForm, agentsBtnForm, details">
			                			</a4j:commandLink>
			                		</h:panelGroup>
			                	</h:panelGrid>
		                	</h:panelGrid>
		                	<a4j:outputPanel ajaxRendered="true">
			                	<h:graphicImage url="/_img/hd_searchblock.gif"  styleClass="hd-searchblock"/>
			                	<h:panelGroup styleClass="collapse-vert" layout="block"/>
		                	</a4j:outputPanel>
		                </h:panelGroup>
	                </h:panelGroup>
				</h:panelGroup>
			</h:panelGroup>
		</h:form>
		
		<h:form id="agentsForm" rendered="#{usession.inRole['VIEW_AGENT']}">
        	<h:panelGroup styleClass="search_result_block" layout="block">
    			<h:panelGroup styleClass="search_result_block_left fix-ff" layout="block">
    				<h:panelGroup id="mainTableWrapper" layout="block"
						styleClass="search_result_block_tree_inner">
		            <o:treeTable id="agentsTreeTable" var="agent"
			               headerHorizSeparator="1px solid #D7DAC2"
			               headerVertSeparator="1px solid #D7DAC2"
			               headerSectionClass="res-tree-table-header"
			               commonHeaderRowClass="res-tree-table-header"
			               sortableHeaderClass="res-tree-table-header"
			               sortedColumnHeaderClass="res-tree-table-header"
			               sortableHeaderRolloverClass="res-tree-table-header"
			               styleClass="res-tree-table"
			               bodyOddRowClass="res-tree-table-row odd-tree-table"
			               bodyRowClass="res-tree-table-row"
			               verticalGridLines="1px solid #D7DAC2"
			               cellpadding="0" cellspacing="0"
			               preloadedNodes="all" style="height: 100%"
			               expansionState="#{MbAgent.expandLevel}" onmousedown="handleMouseClick(event)">
						<o:scrolling/>
						<o:columnResizing minColWidth="70px" />
						
						<f:facet name="noDataMessage">
						  	<h:panelGroup>
						       <h:outputText value="#{lblCommon['no_records_found']}" rendered="#{MbAgent.searching}"/>
						       <h:outputText value="#{lblCommon['enter_search_criteria_above']}" rendered="#{!MbAgent.searching}"/>
							</h:panelGroup>
						</f:facet>
						
			       		<o:dynamicTreeStructure nodeChildren="#{MbAgent.nodeChildren}" 
			       				nodeHasChildren="#{MbAgent.nodeHasChildren}" 
			       				nodeKey="#{agent.id}"/>

					    <o:singleNodeSelection nodePath="#{MbAgent.nodePath}"
					          	nodeData="#{MbAgent.node}"
		          				keyboardSupport="false"
		          				styleClass="treetable_selection"
		          				>
							<a4j:support event="onchange" eventsQueue="queue"
		                    		reRender="agentsBtnForm:btnPanel, #{MbAgent.tabName}"/>
		          		</o:singleNodeSelection>

					    <o:treeColumn id="agentName" sortingExpression="#{agent.name}" width="30%">
					    	<f:facet name="header">
								<a4j:outputPanel layout="none">
									<script>updateHeight();</script>
									<h:outputText value="#{lblCommonQ.name}"/>
								</a4j:outputPanel>
					      	</f:facet>
					      	<bm:entityDisplay   value="#{agent.name}" styleClass="treeTableText" 
					      		bean="MbAgent" contextType="ENTTAGNT"
					      		/>
					      	<h:outputText value=" 	&#160;" rendered="#{agent.name == null}" escape="true"/>
					    </o:treeColumn>

					    <o:column id="type" sortingExpression="#{agent.type}" styleClass="res-tree-table-cell">
					      	<f:facet name="header">
					        	<h:outputText value="#{lblCommonQ.type}"/>
					      	</f:facet>
					      	<bm:entityDisplay   value="#{DictUtils.articles[agent.type]}" styleClass="treeTableText" 
					      		bean="MbAgent" contextType="ENTTAGNT"
					      		/>
					    </o:column>
					    
					    <o:column id="agentId" sortingExpression="#{agent.id}" styleClass="res-tree-table-cell">
					      	<f:facet name="header">
					        	<h:outputText value="#{lblCommonQ.id}"/>
					      	</f:facet>
					      	<bm:entityDisplay  value="#{agent.id}" bean="MbAgent" contextType="ENTTAGNT"
								description="#{agent.id}"
								styleClass="treeTableText"/>
					    </o:column>
					    
					    <o:column id="externalNumber" sortingExpression="#{agent.externalNumber}" styleClass="res-tree-table-cell" minResizingWidth="110px">
					      	<f:facet name="header">
					        	<h:outputText value="#{lblOst.external_number}"/>
					      	</f:facet>
					      	<bm:entityDisplay  value="#{agent.externalNumber}" bean="MbAgent" contextType="ENTTAGNT"
								description="#{agent.externalNumber}"
								styleClass="treeTableText"/>
					    </o:column>
				
					</o:treeTable>

					<a4j:outputPanel ajaxRendered="true">
						<h:panelGroup id="show_more_panel" styleClass="show-more-vert show-more-result-tree-tab" layout="block"/>
			            <h:graphicImage url="/_img/hd_searchblock.gif" styleClass="hd-searchblock"/>
					    <h:panelGroup styleClass="collapse-vert" layout="block"/>
				    </a4j:outputPanel>
					</h:panelGroup>
				</h:panelGroup>
			</h:panelGroup>
		</h:form>
		<h:form id="agentsBtnForm">
			 <h:panelGroup layout="block" styleClass="bottom_search_result_block-tree">
				<h:panelGroup layout="block" styleClass="bottom_search_result_left-tree">
					<h:panelGrid styleClass="buttons_block" columns="5" id="btnPanel">
						<bre:taggedCommandButton id="backBtn" value="#{lblForm.back}"
								action="#{MbAgent.back}" rendered="#{MbAgent.showBackBtn}"/>
						<rich:spacer width="20px" rendered="#{MbAgent.showBackBtn}"/>
						
						
	                	<bre:taggedCommandButton id="addBtn"
	                    		value="#{lblForm.add}" immediate="true"
	                    		reRender="agentEditForm, agentModalHeader"
	                    		limitToList="true"
	                    		action="#{MbAgent.addAgent}"
								oncomplete="#{rich:component('agentModalPanel')}.show()"
								image="/images/create_doc.gif"
								disabled="#{MbAgent.filter.instId == null}"
								rendered="#{usession.inRole['ADD_AGENT']}"
	           					/>
	                   	<bre:taggedCommandButton id="editBtn"
								value="#{lblForm.edit}"
								reRender="agentEditForm, agentModalHeader"
								action="#{MbAgent.editAgent}"
								image="/images/edit.gif"
	                    		disabled="#{MbAgent.node.id == null}"
	                    		rendered="#{usession.inRole['MODIFY_AGENT']}"
								oncomplete="#{rich:component('agentModalPanel')}.show()"													
								/>
						<bre:taggedCommandButton id="deleteBtn"
	                    		value="#{lblForm.delete}" 
	                    		image="/images/delete.gif"
	                    		disabled="#{MbAgent.node.id == null}"
	                    		rendered="#{usession.inRole['REMOVE_AGENT']}"
								oncomplete="#{rich:component('deleteAgentView:confirmPanel')}.show()"/>
					</h:panelGrid>
                </h:panelGroup>
			</h:panelGroup>
		</h:form>

        <h:form>
            <a4j:jsFunction name="storeTab" ajaxSingle="true" limitToList="true"
                            requestDelay="500" ignoreDupResponses="true" eventsQueue="queue" reRender="#{MbAgent.rerenderList}">
                <a4j:actionparam name="tabName" assignTo="#{MbAgent.tabName}" />
            </a4j:jsFunction>
        </h:form>

		<h:panelGroup styleClass="workplace"
			rendered="#{usession.inRole['VIEW_AGENT']}" layout="block"
			id="workplacePanel">
			<rich:tabPanel switchType="client" id="details" tabClass="tab-cell"
				activeTabClass="active-tab-cell" headerClass="tabs"
				headerSpacing="0px" contentClass="tab-content"
				selectedTab="#{MbAgent.tabName}">
				<rich:tab ontabenter="storeTab('detailsTab')" label="#{lblCommon.details}" name="detailsTab">
					<f:facet name="label">
						<h:panelGroup styleClass="tab-label" layout="block">
							<h:outputText value="#{lblCommon.details}"
								title="#{lblCommon.details}" />
						</h:panelGroup>
					</f:facet>

					<h:panelGroup id="detailsTab" layout="block">
						<ui:include src="/pages/org_struct/agentDetails.jspx" />
						<h:panelGroup layout="block"
							styleClass="bottom_search_result_block_buttons"/>
					</h:panelGroup>
				</rich:tab>

				<rich:tab ontabenter="storeTab('flexFieldsTab')" label="Additional" name="flexFieldsTab" rendered="false"
					style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="tab-label" layout="block">
							<h:outputText value="#{lblCommon.additional}"
								title="#{lblCommon.additional}" />
						</h:panelGroup>
					</f:facet>

					<h:panelGroup id="flexFieldsTab" layout="block"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/common/flexible/flexFieldsTableBottom.jspx">
							<ui:param name="parentPriv" value="#{usession.inRole['ADD_AGENT'] or usession.inRole['MODIFY_AGENT']}"/>
							
						</ui:include>
					</h:panelGroup>
				</rich:tab>


				<rich:tab ontabenter="storeTab('accountsTab')" label="Accounts" name="accountsTab" style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="first tab-label" layout="block">
							<h:outputText value="#{lblCommon.accounts}"
								title="#{lblCommon.accounts}" />
						</h:panelGroup>
					</f:facet>
					<h:panelGroup id="accountsTab" layout="block"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/accounts/list_gl_accounts_bottom.jspx"></ui:include>
					</h:panelGroup>
				</rich:tab>

				<rich:tab ontabenter="storeTab('addressesTab')" label="Addresses" name="addressesTab" style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="tab-label" layout="block">
							<h:outputText value="#{lblCommon.addresses}"
								title="#{lblCommon.addresses}" />
						</h:panelGroup>
					</f:facet>
					<h:panelGroup layout="block" id="addressesTab"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/common/address/list_addresses.jspx">
							<ui:param name="parentPriv" value="#{usession.inRole['ADD_AGENT'] or usession.inRole['MODIFY_AGENT']}"/>
						</ui:include>
					</h:panelGroup>
				</rich:tab>

				<rich:tab ontabenter="storeTab('contactsTab')" label="Contacts" name="contactsTab" style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="first tab-label" layout="block">
							<h:outputText value="#{lblCommon.contacts}"
								title="#{lblCommon.contacts}" />
						</h:panelGroup>
					</f:facet>

					<h:panelGroup layout="block" id="contactsTab"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/contacts/contactsTableBottom.jspx">
							<ui:param name="parentPriv" value="#{usession.inRole['ADD_AGENT'] or usession.inRole['MODIFY_AGENT']}"/>
						</ui:include>
					</h:panelGroup>

				</rich:tab>

				<rich:tab ontabenter="storeTab('settingParamsTab')" label="Settings" name="settingParamsTab"
					rendered="#{usession.inRole['VIEW_AGENT_PARAMETER']}"
					style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="first tab-label" layout="block">
							<h:outputText value="#{lblCommon.settings}"
								title="#{lblCommon.settings}" />
						</h:panelGroup>
					</f:facet>
					<h:panelGroup id="settingParamsTab" layout="block"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/settings/list_settings_bottom.jspx">
							<ui:param name="roleToUnblock" value="MODIFY_AGENT_PARAMETER"></ui:param>
						</ui:include>
					</h:panelGroup>
				</rich:tab>

				<rich:tab ontabenter="storeTab('notesTab')" label="Notes" name="notesTab" style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="tab-label" layout="block">
							<h:outputText value="#{lblNote.notes}" title="#{lblNote.notes}" />
						</h:panelGroup>
					</f:facet>
					<h:panelGroup id="notesTab" layout="block"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/notes/list_notes_bottom.jspx"></ui:include>
					</h:panelGroup>
				</rich:tab>

				<rich:tab ontabenter="storeTab('schemesTab')" label="Schemes" name="schemesTab" style="height:100%;">
					<f:facet name="label">
						<h:panelGroup styleClass="tab-label" layout="block">
							<h:outputText value="#{lblAup.schemes}" title="#{lblAup.schemes}" />
						</h:panelGroup>
					</f:facet>
					<h:panelGroup id="schemesTab" layout="block"
						styleClass="carddata-wrapper"
						style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/aup/list_scheme_object.jspx"></ui:include>
					</h:panelGroup>
				</rich:tab>
				
				<rich:tab ontabenter="storeTab('associationTab')" label="Association" name="associationTab" style="height:100%;">
       				<f:facet name="label">
       					<h:panelGroup styleClass="tab-label" layout="block">
       						<h:outputText value="#{lblPrd.association}" title="#{lblPrd.association}"/>
       					</h:panelGroup>
       				</f:facet>
       				<h:panelGroup id="associationTab" layout="block" styleClass="carddata-wrapper" style="height: 100%;overflow:hidden;position:relative;">
						<ui:include src="/pages/products/customersListBottom.jspx">
							<ui:param name="activeItem" value="#{MbAgent.node.id}"></ui:param>
						</ui:include>
       				</h:panelGroup>
       			</rich:tab>

			</rich:tabPanel>
		</h:panelGroup>

		<ui:include src="/pages/org_struct/editAgent.jspx">
			<ui:param name="rerenderList" value="agentsForm:agentsTreeTable, agentsBtnForm:btnPanel, #{MbAgent.tabName}"/>
		</ui:include>
		
		<ui:include src="/pages/utils/confirmPanel.jspx">
			<ui:param name="backingBean" value="#{MbAgent}"/>
			<ui:param name="yesAction" value="removeAgent"/>
			<ui:param name="warningMsg" value="#{lblMsg.confirm_delete}"/> 
			<ui:param name="rerenderList" value="agentsForm:agentsTreeTable, agentsBtnForm:btnPanel, #{MbAgent.tabName}"/>
			<ui:param name="confirmQuestion" value=" "/> 
			<ui:param name="subviewId" value="deleteAgentView"/>
			<ui:param name="yes" value="#{lblForm.ok}"/>
			<ui:param name="no" value="#{lblForm.cancel}"/>
		</ui:include>

		<script type="text/javascript">
			document.getElementById("agentsSearchForm:instId").focus();
		</script>
		
		<script>
			//<![CDATA[	
			function updateHeight(){
            updateGridHeight();
	        }
	
	        layout =
	                {
	                    SEARCH_FORM_ID:                 'agentsSearchForm',
	                    SEARCH_RESULT_FORM_ID:          'agentsForm',
	                    SEARCH_RESULT_FORM_WRAPPER_ID:  'mainTableWrapper',
	                    SEARCH_RESULT_FOOTER_FORM_ID:   'agentsBtnForm',
	                    TAB_PANEL_ID:                   'workplacePanel',
	
	                    TAB_DATA:      [{
	                                    TAB_FORM_ID:            'agentDetailsForm',
	                                    TAB_FORM_WRAPPER_ID:    'agentDetailsWrapper',
	                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS + Stretch.LANG_SELECTOR
	                                    }, {
	                                    TAB_FORM_ID:            'flexDataForm',
	                                    TAB_FORM_WRAPPER_ID:    'flexDataWrapper',
	                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
	                                    }, {
	                                    TAB_FORM_ID:            'glAccBtmForm',
	                                    TAB_FORM_WRAPPER_ID:    'mainTableWrapper',
	                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
	                                    }, {
	                                    TAB_FORM_ID:            'addressesBtmForm',
	                                    TAB_FORM_WRAPPER_ID:    'addressesTableWrapper',
	                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS + Stretch.LANG_SELECTOR
	                                    }, {
		                                    TAB_FORM_ID:            'contactsForm',
		                                    TAB_FORM_WRAPPER_ID:    'bottomContactsTableWrapper',
		                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS  + Stretch.LANG_SELECTOR
		                                    }, {
		                                    TAB_FORM_ID:            'contactDatasForm',
		                                    TAB_FORM_WRAPPER_ID:    'bottomContactDatasTableWrapper',
		                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS  + Stretch.LANG_SELECTOR
		                                    }, {
		                                    TAB_FORM_ID:            'settingsBottomForm',
		                                    TAB_FORM_WRAPPER_ID:    'settingsTreeTableWrapper',
		                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
		                                    }, {
		                                    TAB_FORM_ID:            'notesBtmForm',
		                                    TAB_FORM_WRAPPER_ID:    'notesTableWrapper',
		                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
		                                    }, {
		                                    TAB_FORM_ID:            'schemesForm',
		                                    TAB_FORM_WRAPPER_ID:    'schemesTableWrapper',
		                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
		                                    }, {
		                                    TAB_FORM_ID:            'bottomCustomerForm',
		                                    TAB_FORM_WRAPPER_ID:    'customerTableWrapper',
		                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
		                                    }]
	
	                };
	        jQuery(window).resize(updateHeight);
			
			updateHeight();
			//]]>
		</script>		
    </ui:define>
</ui:composition>
</html>
