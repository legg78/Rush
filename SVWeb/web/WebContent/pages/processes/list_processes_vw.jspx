<?xml version="1.0" encoding="UTF-8"?>
<html	xmlns="http://www.w3.org/1999/xhtml"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:a4j="http://richfaces.org/a4j"
		xmlns:rich="http://richfaces.org/rich"
		xmlns:bm="http://www.bpc.ru/jsf/misc"
		xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext">
<ui:composition>
		<script type="text/javascript">
    	//<![CDATA[
			function selectTab(tabName) {
				if (!submitTab(tabName)) {
					//set only tab name to managed bean (in order to use it in the future)
					setTabName(tabName);
					return false;
				}
				//set tab name and refresh tab
				refreshTab(tabName);
			}
		
		//]]>
		</script>
		
		<a4j:loadScript src="/js/stretch.js" />
	<a4j:queue name="queue" requestDelay="500" ignoreDupResponses="true" size="1" sizeExceededBehavior="dropNew"/>
	
	<script type="text/javascript">
			//<![CDATA[
			function handleEnter(event) {
				 if (event.keyCode == 13) {
					 document.getElementById('processSearchForm:searchBtn').click(); 
					 return false; 
				} 
				return true;
			 }	
			//]]>
			</script>
			
	<h:form id="processSearchForm" onkeypress="handleEnter(event)">
		<h:inputHidden value="#{MbProcessesSearch.tabName}" id="tabNameInput" />
		<script type="text/javascript">
		 	load("processSearchForm:tabNameInput");
		</script>
				
		<a4j:jsFunction name="refreshTab" eventsQueue="queue" limitToList="true" ajaxSingle="true"
			reRender="#{MbProcessesSearch.tabName}, err_ajax" action="#{MbProcessesSearch.loadCurrentTab}">
			<a4j:actionparam name="tabName" assignTo="#{MbProcessesSearch.tabName}"/>
		</a4j:jsFunction>
		
		<a4j:jsFunction name="setTabName" reRender="err_ajax" limitToList="true" ajaxSingle="true">
			<a4j:actionparam name="tabName" assignTo="#{MbProcessesSearch.tabName}"/>
		</a4j:jsFunction>
		
	
		<h:panelGroup styleClass="search_block" layout="block">
			<h:panelGroup layout="block" styleClass="search_block_inner1">
				<h:panelGroup layout="block" styleClass="search_block_inner2">
	                <h:panelGroup styleClass="search_block_left" layout="block">
	                	<h:panelGrid styleClass="fw" columns="2" columnClasses="top ,link-cont">
		                	<h:panelGrid styleClass="filter-table field-cont twoColumnTable" columns="4" columnClasses="firstCol,secondCol,firstCol,secondCol">
								
								<h:outputLabel value="#{lblCommon.institution}:" title="#{lblCommon.institution}" />
								<h:selectOneMenu id="instSelector"
									value="#{MbProcessesSearch.filter.instId}">
									<f:selectItem itemValue="" itemLabel="" />
									<f:selectItems value="#{MbProcessesSearch.institutions}" />
								</h:selectOneMenu>

								<h:outputLabel for="nameFilter" value="#{lblCommon.name}: " title="#{lblCommon.name}" />
		            			<h:inputText id="nameFilter" value="#{MbProcessesSearch.filter.name}"/>
		            			
		            			<h:outputLabel for="procNameFilter" value="#{lblCommon.procedure_name}: " title="#{lblCommon.procedure_name}" />
		            			<h:inputText id="procNameFilter" value="#{MbProcessesSearch.filter.procedureName}"/>
		            			
		            			<h:outputLabel for="descFilter" value="#{lblCommon.description}: " title="#{lblCommon.description}" />
		            			<h:inputText id="descFilter" value="#{MbProcessesSearch.filter.description}"/>
		            			
		                	</h:panelGrid>
	                		<h:panelGrid columns="1" >
		                		<bre:taggedCommandButton value="#{lblForm.search}" style="width:85px;"
		                				onclick="flushTabs(); disableModalPanelBtns(this);"
		                				oncomplete="enableModalPanelBtns(this);"
		                				id="searchBtn"
		                				reRender="mainTable, ds, processBtnForm, userRolesBtns, #{MbProcessesSearch.tabName}"
		                				action="#{MbProcessesSearch.search}"
		                				image="/_img/icon_search.png" type="submit"
		                				eventsQueue="queue"/>
		                		<h:panelGroup styleClass="link-clear" layout="block"  >
		                			<h:graphicImage url="/_img/icon_clear.png"/>
		                			<a4j:commandLink value="#{lblForm.clear_all}"
		                					action="#{MbProcessesSearch.clearFilter}"
		                					reRender="processSearchForm, processesForm, processBtnForm, detailsProcess">
		                			</a4j:commandLink>
		                		</h:panelGroup>
		                	</h:panelGrid>
	                	</h:panelGrid>
	                	<a4j:outputPanel ajaxRendered="true">
		                	<h:graphicImage url="/_img/hd_searchblock.gif"  styleClass="hd-searchblock"/>
		                	<h:panelGroup styleClass="collapse-vert" layout="block"/>
	                	</a4j:outputPanel>
	                </h:panelGroup>
				</h:panelGroup>
			</h:panelGroup>
		</h:panelGroup>
	</h:form>
	
	<h:form id="processesForm">
		<a4j:jsFunction name="changeSelection" eventsQueue="queue"
					reRender="processBtnForm, #{MbProcessesSearch.tabName}">
					<a4j:actionparam name="tabName" assignTo="#{MbProcessesSearch.tabName}"/>
		</a4j:jsFunction>
		
        <h:panelGroup styleClass="search_result_block" layout="block">
        	<h:panelGroup styleClass="search_result_block_left fix-ff" layout="block">
        		<h:panelGroup id="mainTableWrapper" layout="block"
						styleClass="search_result_block_inner">
				<rich:extendedDataTable enableContextMenu="false"
						id="mainTable"
						styleClass="res-table"
						headerClass="res-table-header"
						rowClasses=",odd"
						selectedClass="res-table-selected"
						var="item" reRender="processBtnForm, #{MbProcessesSearch.tabName}"
						value="#{MbProcessesSearch.processes}"
						selection="#{MbProcessesSearch.itemSelection}"
						rows="#{MbProcessesSearch.rowsNum}"
						height="255px" 
						selectionMode="#{MbProcessesSearch.selectMode == true ? 'multi':'single'}"
						onselectionchange="flushTabs();changeSelection(currentTab);"
						noDataLabel="#{MbProcessesSearch.searching?lblCommon['no_records_found'] : lblCommon['enter_search_criteria_above']}">

	                <rich:column title="Id" id="id" sortBy="#{'id'}" width="10%" >
                        <f:facet name="header" >
                        	<a4j:outputPanel layout="none">
                        		<script>updateHeight();</script>
                        		<h:outputText value="#{lblCommon.id}" title="#{lblCommon.id}"/>
                        	</a4j:outputPanel>
                        </f:facet>
                        <h:outputText value="#{item.id}" />
                    </rich:column>
                    
			        <rich:column title="#{lblCommon.name}" sortBy="#{'name'}" width="25%">
			           <f:facet name="header" >
		                    <h:outputText value="#{lblCommon.name}" title="#{lblCommon.name}" />
		                </f:facet>
		                <h:outputText value="#{item.name}" title="#{item.name}" />
			        </rich:column>
			        
			        <rich:column title="Container" width="10%" sortBy="#{'container'}">
			           <f:facet name="header">
		                    <h:outputText value="#{lblPrc.container}" title="#{lblPrc.container}"/>
		                </f:facet>
		                <h:selectBooleanCheckbox value="#{item.container}" title="#{item.container}" disabled="true"/>
			        </rich:column>
			   
			        <rich:column title="Parallel" width="10%" sortBy="#{'parallel'}">
			           <f:facet name="header">
		                    <h:outputText value="#{lblPrc.parallel}" title="#{lblPrc.parallel}"/>
		                </f:facet>
		                <h:selectBooleanCheckbox value="#{item.parallel}" disabled="true"/>
			        </rich:column>
			        
			        <rich:column title="Ext" width="10%" sortBy="#{'external'}">
			           <f:facet name="header">
		                    <h:outputText value="#{lblPrc.external}" title="#{lblPrc.external}"/>
		                </f:facet>
		                <h:selectBooleanCheckbox value="#{item.external}" disabled="true"/>
			        </rich:column>
			        
			        <rich:column title="Instution" width="20%">
			           <f:facet name="header">
		                    <h:outputText value="#{lblCommon.institution}" title="#{lblCommon.institution}" />
		                </f:facet>
		                <bm:entityDisplay  entityId="#{item.instId}"
									value="#{item.instName}"/>
			        </rich:column>
			    </rich:extendedDataTable>
			    </h:panelGroup>
			    <a4j:outputPanel ajaxRendered="true">
			    	<h:panelGroup id="show_more_panel" styleClass="show-more-vert show-more-result-tab" layout="block"/>
				    <h:graphicImage url="/_img/hd_searchblock.gif" styleClass="hd-searchblock"/>
				    <h:panelGroup styleClass="collapse-vert table-collapse-vert" layout="block"/>
			    </a4j:outputPanel>
		    </h:panelGroup>
		</h:panelGroup>
	</h:form>
	<h:form id="processBtnForm">
		<h:panelGroup layout="block" styleClass="bottom_search_result_block">
			<h:panelGroup layout="block" styleClass="bottom_search_result_left">
	        	<h:panelGroup layout="block" styleClass="table_tools">
		        	<h:panelGrid styleClass="fw field-cont" columns="4"
		        			columnClasses="per-page-lbl,per-page-sel,nav-cont,pagecount">
			        	<h:outputLabel for="rows_num" value="#{lblCommon.rows_per_page}" title="#{lblCommon.rows_per_page}"/>
						<h:selectOneMenu id="rows_num" value="#{MbProcessesSearch.rowsNum}" styleClass="row_per_page">
							<a4j:support event="onchange" reRender="mainTable, ds, pagesNum, processBtnForm, #{MbProcessesSearch.tabName}"/>
							<f:selectItem itemValue="5" itemLabel="5"/>
							<f:selectItems value="#{CommonUtils.rowNumsList}"/>
						</h:selectOneMenu>
	
	                    <rich:datascroller maxPages="10" fastControls="hide"
			                    pagesVar="pages" styleClass="res-datascroller"
			                    id="ds" for="mainTable" page="#{MbProcessesSearch.pageNumber}"
			                    reRender="processBtnForm, #{MbProcessesSearch.tabName}">
		                    <f:facet name="first">
		                        <h:outputText value="&lt;&lt;" styleClass="prev-next" />
		                    </f:facet>
		                    <f:facet name="first_disabled">
		                        <h:outputText value="&lt;&lt;" styleClass="prev-next-dis" />
		                    </f:facet>
		                    <f:facet name="last">
		                        <h:outputText  value="&gt;&gt;" styleClass="prev-next" />
		                    </f:facet>
		                    <f:facet name="last_disabled">
		                        <h:outputText value="&gt;&gt;" styleClass="prev-next-dis" />
		                    </f:facet>
		                    <f:facet name="previous">
		                        <h:outputText value="#{lblCommon.prev}" styleClass="prev-next" />
		                    </f:facet>
		                    <f:facet name="previous_disabled">
		                        <h:outputText value="#{lblCommon.prev}" styleClass="prev-next-dis" />
		                    </f:facet>
		                    <f:facet name="next">
		                        <h:outputText value="#{lblCommon.next}" styleClass="prev-next" />
		                    </f:facet>
		                    <f:facet name="next_disabled">
		                        <h:outputText value="#{lblCommon.next}" styleClass="prev-next-dis" />
		                    </f:facet>
		                    <f:facet name="pages">
		                    </f:facet>
		                </rich:datascroller>
	
                      	<h:panelGroup id="pagesNum">
                       	<h:outputText styleClass="strongClass" value="#{pages} "/>
                       	<h:outputText value=" #{lblCommon.pages}"/>
                            <h:outputText value="" style="padding-left: 20px; padding-right: 20px;" />
                            <h:outputText styleClass="strongClass" value="#{MbProcessesSearch.processes.rowCount}"/>
                            <h:outputText value=" #{lblCommon.records}"/>
                            <h:outputText value="" style="padding-left: 20px; padding-right: 20px;" />
					</h:panelGroup>
				</h:panelGrid>
			</h:panelGroup>
	
				<h:panelGrid styleClass="buttons_block" columns="7" id="btnPanel">
			        <bre:taggedCommandButton id="btn_select_procs_to_group"
			        		value="Add to group"
							action="#{MbProcessesSearch.addSelectedProcessesToGroup}"
							disabled="#{MbProcessesSearch.activeProcess == null}"
							rendered="#{MbProcessesSearch.selectMode and MbProcessesSearch.addToGroupMode}"
							/>
			        <bre:taggedCommandButton id="btn_select_procs_to_container"
			        		value="Select"
		               		action="#{MbProcessesSearch.selectProcess}"
		               		disabled="#{MbProcessesSearch.activeProcess == null}"
		               		rendered="#{MbProcessesSearch.selectMode}"
		               		/>
			        <bre:taggedCommandButton id="btn_cancel_select_proc"
			        		value="#{lblForm.cancel}"
							action="#{MbProcessesSearch.cancelSelect}"
							rendered="#{MbProcessesSearch.selectMode}"
							/>
		                      
					<rich:spacer style="width:20px" rendered="#{MbProcessesSearch.selectMode}"/>
		                      
					<bre:taggedCommandButton
							action="#{MbProcessesSearch.add}"
							value="#{lblForm.add}"
							oncomplete="#{rich:component('prc_process_modal_panel')}.show()"
							reRender="processEditForm,prc_process_modal_panel" limitToList="true"
							rendered="#{usession.inRole['ADD_PROCESS']}"
							image="/images/create_doc.gif"
							/>
					<bre:taggedCommandButton id="editBtn"
	                  		reRender="processEditForm,prc_process_modal_panel"
	                  		value="#{lblForm.edit}"
	                  		action="#{MbProcessesSearch.edit}"
	               			oncomplete="#{rich:component('prc_process_modal_panel')}.show()"
	                  		disabled="#{MbProcessesSearch.activeProcess == null}"
	                  		rendered="#{usession.inRole['MODIFY_PROCESS']}"
	                  		image="/images/edit.gif"
	                  		/>
					<bre:taggedCommandButton 
							id="btn_delete_process"
							oncomplete="#{rich:component('deleteViewId:confirmPanel')}.show()"
							value="#{lblForm.delete}" 
							disabled="#{MbProcessesSearch.activeProcess == null }"
							rendered="#{usession.inRole['REMOVE_PROCESS']}"
							image="/images/delete.gif"
							/>
				</h:panelGrid>
			</h:panelGroup>
		</h:panelGroup>
	</h:form>

	<h:panelGroup styleClass="workplace" layout="block" id="workplacePanel">
		<rich:tabPanel switchType="client" id="detailsProcess"  tabClass="tab-cell"
		    		activeTabClass="active-tab-cell" headerClass="tabs" headerSpacing="0px"
		    		contentClass="tab-content" selectedTab="#{MbProcessesSearch.tabName}">

			<rich:tab label="Details" name="detailsTab" ontabenter="selectTab('detailsTab')">				
				<f:facet name="label">
					<h:panelGroup styleClass="first tab-label" layout="block">
						<h:outputText value="#{lblCommon.details}" title="#{lblCommon.details}"/>
					</h:panelGroup>
				</f:facet>
				<h:panelGroup id="detailsTab" >
      					<ui:include src="/pages/processes/process_details.jspx"></ui:include>
      						<h:panelGroup layout="block"
								styleClass="bottom_search_result_block_buttons"/>
				</h:panelGroup>
		    </rich:tab>
	    
           	<rich:tab label="Params" name="paramsTab" rendered="#{usession.inRole['VIEW_PARAM_PRC']}"
           			ontabenter="selectTab('paramsTab')" >   	       		
   				<f:facet name="label">
					<h:panelGroup styleClass="tab-label" layout="block">
						<h:outputText value="#{lblCommon.parameters}" title="#{lblCommon.parameters}"/>
					</h:panelGroup>
				</f:facet>
				<h:panelGroup id="paramsTab">					
					<ui:include src="#{MbProcessesSearch.tabName=='paramsTab' ? '/pages/processes/list_process_params_bottom.jspx' : null}"></ui:include>
				</h:panelGroup>
			</rich:tab>

           	<rich:tab label="Files" name="filesTab" rendered="#{usession.inRole['VIEW_FILE']}"
           			ontabenter="selectTab('filesTab')" style="height:100%;">           		
  				<f:facet name="label">
  					<h:panelGroup styleClass="tab-label" layout="block">
  						<h:outputText value="#{lblCommon.files}" title="#{lblCommon.files}"/>
  					</h:panelGroup>
  				</f:facet>
   				<h:panelGroup id="filesTab" layout="block" styleClass="carddata-wrapper" style="height: 100%;overflow:hidden;position:relative;">
   					<ui:include src="#{MbProcessesSearch.tabName=='filesTab' ? '/pages/processes/files/list_process_files_bottom.jspx' : null}"></ui:include>
  				</h:panelGroup>
            </rich:tab>
            
            <rich:tab label="Container" name="containerTab" rendered="#{usession.inRole['VIEW_CONTAINER']}"
           			ontabenter="selectTab('containerTab')" style="height:100%;">           		
  				<f:facet name="label">
  					<h:panelGroup styleClass="tab-label" layout="block">
  						<h:outputText value="#{lblPrc.containers}" title="#{lblPrc.containers}"/>
  					</h:panelGroup>
  				</f:facet>
   				<h:panelGroup id="containerTab" layout="block" styleClass="carddata-wrapper" style="height: 100%;overflow:hidden;position:relative;">
   					<ui:include src="#{MbProcessesSearch.tabName=='containerTab' ? '/pages/processes/list_containers_bottom.jspx' : null}"></ui:include>
  				</h:panelGroup>
            </rich:tab>


			<rich:tab label="Events" name="eventsTab" rendered="#{usession.inRole['VIEW_TAB_EVENTS']}"
					  ontabenter="selectTab('eventsTab')" style="height:100%;">
				<f:facet name="label">
					<h:panelGroup styleClass="tab-label" layout="block">
						<h:outputText value="#{lblCommon.events}" title="#{lblCommon.events}"/>
					</h:panelGroup>
				</f:facet>
				<h:panelGroup id="eventsTab" layout="block" styleClass="carddata-wrapper" style="height: 100%;overflow:hidden;position:relative;">
					<ui:include src="#{MbProcessesSearch.tabName=='eventsTab' ? '/pages/common/events/list_events_bottom.jspx' : null}"></ui:include>
				</h:panelGroup>
			</rich:tab>
   		</rich:tabPanel>
	</h:panelGroup>

	<rich:modalPanel id="prc_process_modal_panel" autosized="true" minWidth="300" minHeight="200" showWhenRendered="#{MbProcessesSearch.showModal}"
		onshow="actualHelp.setModeHelp('#{MbProcessesSearch.newMode}')"
		onhide="actualHelp.setHelp('#{pageHelp}')">
    	<f:facet name="header">
    		<h:panelGroup id="prc_process_modal_header">
        		<h:outputText value="#{lblPrc.new_process}" rendered="#{MbProcessesSearch.newMode}"/>
        		<h:outputText value="#{lblPrc.edit_process}" rendered="#{MbProcessesSearch.editMode}"/>
        	</h:panelGroup>
		</f:facet>
		<f:facet name="controls">
			<h:panelGroup id="prc_process_modal_control" rendered="#{showHelpModal}">
   	        		<h:graphicImage value="/_img/icon_modal_help.png" style="cursor:pointer" 
   	        			onclick="showHelp(actualHelp.getURL())" width="15px"/>
			</h:panelGroup>
		</f:facet>
		
	    <ui:include src="/pages/processes/process_edit.jspx"/>
	</rich:modalPanel>

	<rich:modalPanel onshow="showPanel('prc_container_modal_div:cancel_btn');" onhide="hidePanel();"
          	 id="prc_container_modal_panel" autosized="true" minWidth="300" minHeight="50">
    	<f:facet name="header">
    		<h:panelGroup id="prc_container_modal_header">
        		<h:outputText value="#{lblPrc.new_container}" rendered="#{MbProcessesSearch.newMode}"/>
        		<h:outputText value="#{lblPrc.edit_container}" rendered="#{MbProcessesSearch.editMode}"/>
        	</h:panelGroup>
		</f:facet>
		<f:facet name="controls">
		</f:facet>

		<h:form id="prc_container_modal_div" >
		    <ui:include src="/pages/processes/container_edit.jspx"/>
			<h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
				<h:panelGroup layout="block" styleClass="bottom_search_result_left_buttons">
	     	    	<h:panelGrid columns="3" columnClasses="width99P,,paddingR12">
						<h:outputText/>
						<bre:taggedCommandButton 
			            		value="#{lblForm.save}" type="submit" 
			                	reRender="mainTable, ds, processBtnForm, #{MbProcessesSearch.rerenderString}" 
			                	action="#{MbProcessesSearch.save}"
			                	oncomplete="if (#{usession.noErrorResponse}) #{rich:component('prc_container_modal_panel')}.hide()"
			                	/>               
						<bre:taggedCommandButton id="cancel_btn"
								value="#{lblForm.cancel}"				                        		
								action="#{MbProcessesSearch.close}" immediate="true"
								oncomplete="#{rich:component('prc_container_modal_panel')}.hide()" 
								reRender="prc_container_modal_div">
							<f:actionListener type="ru.bpc.jsf.A4JFormReset" />
						</bre:taggedCommandButton>               
					</h:panelGrid>
				</h:panelGroup>
			</h:panelGroup>					
		</h:form>				
	</rich:modalPanel>   	
	
	<ui:include src="/pages/utils/confirmPanel.jspx">
		<ui:param name="backingBean" value="#{MbProcessesSearch}"/>
		<ui:param name="yesAction" value="delete"/>
		<ui:param name="warningMsg" value="#{lblMsg.confirm_delete}"/> 
		<ui:param name="rerenderList" value="mainTable, ds, processBtnForm, detailsProcess"/>
		<ui:param name="confirmQuestion" value=" "/> 
		<ui:param name="subviewId" value="deleteViewId"/>
		<ui:param name="yes" value="#{lblForm.ok}"/>
		<ui:param name="no" value="#{lblForm.cancel}"/>
	</ui:include>

	<script>
		//<![CDATA[
		
		function updateHeight(){
            updateGridHeight();
        }

        layout =
                {
                    SEARCH_FORM_ID:                 'processSearchForm',
                    SEARCH_RESULT_FORM_ID:          'processesForm',
                    SEARCH_RESULT_FORM_WRAPPER_ID:  'mainTableWrapper',
                    SEARCH_RESULT_FOOTER_FORM_ID:   'processBtnForm',
                    TAB_PANEL_ID:                   'workplacePanel',

                    TAB_DATA:      [{
                                    TAB_FORM_ID:            'processDetailsForm',
                                    TAB_FORM_WRAPPER_ID:    'processDetailsWrapper',
                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS + Stretch.LANG_SELECTOR
                                    }, {
                                    TAB_FORM_ID:            'processParamsForm',
                                    TAB_FORM_WRAPPER_ID:    'processParamsTableBottomWrapper',
                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
                                    }, {
                                    TAB_FORM_ID:            'processFileForm',
                                    TAB_FORM_WRAPPER_ID:    'processFileTableWrapper',
                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS + Stretch.LANG_SELECTOR
                                    }, {
                                    TAB_FORM_ID:            'containersForm',
                                    TAB_FORM_WRAPPER_ID:    'containersTableWrapper',
                                    CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
                                    }, {
									TAB_FORM_ID:            'eventsForm',
									TAB_FORM_WRAPPER_ID:    'eventsTableWrapper',
									CORRECTING_HEIGHT:      Stretch.TABS + Stretch.BUTTONS
									}]

                };
        jQuery(window).resize(updateHeight);
		
		updateHeight();
		//]]>
	</script>

</ui:composition>
</html>