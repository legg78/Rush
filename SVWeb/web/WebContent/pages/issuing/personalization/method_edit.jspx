<?xml version="1.0" encoding="UTF-8"?>
<html	xmlns="http://www.w3.org/1999/xhtml"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:a4j="http://richfaces.org/a4j"
		xmlns:rich="http://richfaces.org/rich"
		xmlns:bm="http://www.bpc.ru/jsf/misc"
		xmlns:bre="http://www.bpc.ru/jsf/richfaces-ext">
<ui:composition>
	<script type="text/javascript">
	//<!--
		function checkMethodField(element) {
			if (document.getElementById(element) != null) {
				if (!document.getElementById(element).disabled && document.getElementById(element).value == "") {
					document.getElementById(element + "Error").style.display = "inline";
					return false;
				}
			}
			return true;
		}

		function checkMethodFields() {
			var checked = true;

			checked = checkField('prsMethodEditForm:name') && checked;
			checked = checkField('prsMethodEditForm:newInst') && checked;
			checked = checkField('prsMethodEditForm:serviceCode') && checked;
			checked = checkField('prsMethodEditForm:newExpDateFormat') && checked;
			checked = checkField('prsMethodEditForm:newpinVerifyMethod') && checked;

			checked = checkMethodField('prsMethodEditForm:newkeySchemaId') && checked;
			checked = checkMethodField('prsMethodEditForm:newDecimTable') && checked;
			checked = checkMethodField('prsMethodEditForm:newpvvStoreMethod') && checked;
			checked = checkMethodField('prsMethodEditForm:newpinStoreMethod') && checked;
			checked = checkMethodField('prsMethodEditForm:pvkIndex') && checked;

			return checked;
		}
	//-->
	</script>

	<h:form id="prs_method_modal_div_hide">
    	<a4j:jsFunction name="hidePrsMethodModal"
						action="#{MbPersoMethodsSearch.close}"
						immediate="true"
						reRender="prsMethodEditForm"
						limitToList="true">
			<f:actionListener type="ru.bpc.jsf.A4JFormReset" />
		</a4j:jsFunction>
	</h:form>

	<rich:modalPanel id="prs_method_modal_panel"
					 autosized="true"
					 minWidth="300"
					 minHeight="100"
					 onhide="hidePrsMethodModal()"
					 onshow="showHideRows()">
		<f:facet name="header">
			<h:panelGroup id="prsMethodModalHeader">
				<h:outputText value="#{lblPrs.new_method}" rendered="#{MbPersoMethodsSearch.newMode}"/>
				<h:outputText value="#{lblPrs.edit_method}" rendered="#{MbPersoMethodsSearch.editMode}"/>
			</h:panelGroup>
		</f:facet>
		<f:facet name="controls"/>

		<h:form id="prsMethodEditForm">
			<a4j:queue size="10" sizeExceededBehavior="dropNext"/>
			<script type="text/javascript">
			//<!--
				oldValue["prsMethodEditForm"] = "#{MbPersoMethodsSearch.newMethod.lang}";
			//-->
			</script>

			<h:panelGroup layout="block" styleClass="cardholderdata-wrapper">
				<h:panelGrid columns="2" styleClass="cardholderdata" width="100%" columnClasses="firstColModal, width250">
					<h:outputLabel value="#{lblCommon.language}: " title="#{lblCommon.language}"/>
					<h:selectOneMenu id="newLang"
									 value="#{MbPersoMethodsSearch.newMethod.lang}"
									 rendered="#{MbPersoMethodsSearch.newMode}">
						<f:selectItems value="#{MbPersoMethodsSearch.languages}"/>
					</h:selectOneMenu>
					<h:selectOneMenu id="editLang"
									 value="#{MbPersoMethodsSearch.newMethod.lang}"
									 rendered="#{MbPersoMethodsSearch.editMode}"
									 onchange="document.getElementById('confirmPanelView:confirmPanelForm:newValue').value = this.value;
									           #{rich:component('confirmPanel')}.show()">
						<f:selectItems value="#{MbPersoMethodsSearch.languages}"/>
					</h:selectOneMenu>

					<h:outputLabel value="* #{lblCommon.name}: " title="#{lblCommon.name}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0">
						<h:inputText id="name"
									 value="#{MbPersoMethodsSearch.newMethod.name}"
									 label="#{lblCommon.name}"
									 maxlength="200"
									 onblur="hideErrorField(this)">
							<f:validateLength minimum="3"/>
							<a4j:support event="onchange" reRender="nameErr" limitToList="true"/>
						</h:inputText>
						<rich:message for="name" id="nameErr" styleClass="errorMarker"/>
						<h:outputFormat id="nameError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblCommon.name}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="* #{lblCommon.institution}: " title="#{lblCommon.institution}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0">
						<a4j:region>
							<h:selectOneMenu id="newInst"
											 value="#{MbPersoMethodsSearch.newMethod.instId}"
											 label="#{lblCommon.institution}"
											 disabled="#{MbPersoMethodsSearch.editMode}"
											 onblur="hideErrorField(this)">
								<f:selectItem itemValue=""/>
								<f:selectItems value="#{MbPersoMethodsSearch.institutions}"/>
								<a4j:support event="onchange" reRender="newkeySchemaId"
										limitToList="true" ajaxSingle="true"/>
							</h:selectOneMenu>
						</a4j:region>
						<h:outputFormat id="newInstError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblCommon.institution}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="* #{lblPrs.service_code}: " title="#{lblPrs.service_code}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0">
						<a4j:region>
							<h:inputText id="serviceCode" value="#{MbPersoMethodsSearch.newMethod.serviceCode}"
										 label="#{lblPrs.service_code}"
										 maxlength="3"
										 onkeypress="if (!numbersOnly(this, event)) return false;"
										 converter="javax.faces.Integer"
										 converterMessage="#{lblMsg.must_be_number}"
										 onblur="hideErrorField(this)">
								<f:validateLength minimum="3" maximum="3"/>
								<a4j:support event="onchange" reRender="serviceCodeErr, pvvLabel, pvvValue,
												pinStoreValue, pinVerifyValue, pvkIndexLabel, pvkIndexValue"
											 limitToList="true" ajaxSingle="true" action="#{MbPersoMethodsSearch.checkPinRequiredOrPVKPresent}"/>
							</h:inputText>
						</a4j:region>
						<rich:message for="serviceCode" id="serviceCodeErr" styleClass="errorMarker"/>
						<h:outputFormat id="serviceCodeError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.service_code}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="* #{lblPrs.pin_verify_method}: " title="#{lblPrs.pin_verify_method}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0" id="pinVerifyValue">
						<a4j:region>
							<h:selectOneMenu id="newpinVerifyMethod"
											 value="#{MbPersoMethodsSearch.newMethod.pinVerifyMethod}"
											 label="#{lblPrs.pin_verify_method}"
											 disabled="#{!MbPersoMethodsSearch.pinRequiredOrPVKPresent}"
											 onblur="hideErrorField(this)">
								<f:selectItem itemValue=""/>
								<f:selectItems value="#{MbPersoMethodsSearch.pinVerifyMethods}"/>
								<a4j:support event="onchange"
											 reRender="decTableLabel, decTableCover"
											 limitToList="true"
											 ajaxSingle="true"
											 oncomplete="showHideRows()"/>
							</h:selectOneMenu>
						</a4j:region>
						<h:outputFormat id="newpinVerifyMethodError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.pin_verify_method}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="#{lblPrs.pin_length}: " title="#{lblPrs.pin_length}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0">
						<h:inputText id="newPinLength"
									 value="#{MbPersoMethodsSearch.newMethod.pinLength}"
									 maxlength="4"
									 onkeypress="if (!numbersOnly(this, event)) return false;"
									 converter="javax.faces.Integer"
									 converterMessage="#{lblMsg.must_be_number}"
									 label="#{lblPrs.pin_length}">
							<f:validateLongRange minimum="4" maximum="12" />
							<a4j:support event="onchange"
										 reRender="newPinLengthErr"
										 limitToList="true"
										 ajaxSingle="true"/>
						</h:inputText>
						<rich:message id="newPinLengthErr" for="newPinLength" styleClass="errorMarker"/>
					</h:panelGrid>

					<h:outputLabel value="* #{lblPrs.cvv2_date_format}: " title="#{lblPrs.cvv2_date_format}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0">
						<h:selectOneMenu id="newExpDateFormat"
										 onclick="hideErrorField(this)"
										 value="#{MbPersoMethodsSearch.newMethod.expDateFormat}">
							<f:selectItem itemValue="" itemLabel="" />
							<f:selectItems value="#{MbPersoMethodsSearch.cvv2DateFormats}" />
						</h:selectOneMenu>
						<h:outputFormat id="newExpDateFormatError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.cvv2_date_format}" />
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="* #{lblPrs.key_schema}: " title="#{lblPrs.key_schema}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<a4j:region>
							<h:selectOneMenu id="newkeySchemaId"
											 value="#{MbPersoMethodsSearch.newMethod.keySchemaId}"
											 label="#{lblPrs.key_schema}"
											 valueChangeListener="#{MbPersoMethodsSearch.changeKeySchema}"
											 onblur="hideErrorField(this)">
								<f:selectItem itemValue=""/>
								<f:selectItems value="#{MbPersoMethodsSearch.keySchemas}"/>
								<a4j:support event="onchange" limitToList="true" ajaxSingle="true"
										reRender="pvvLabel, pvvValue, pinStoreValue, 
												pinVerifyValue, pvkIndexLabel, pvkIndexValue" action="#{MbPersoMethodsSearch.checkPinRequiredOrPVKPresent}"/>
							</h:selectOneMenu>
						</a4j:region>
						<h:outputFormat value="#{lblMsg.value_request}" styleClass="errorMarker"
							id="newkeySchemaIdError" style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.key_schema}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="* #{lblPrs.pvv_store_method}: " title="#{lblPrs.pvv_store_method}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0" id="pvvValue"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<a4j:region>
							<h:selectOneMenu id="newpvvStoreMethod"
											 value="#{MbPersoMethodsSearch.newMethod.pvvStoreMethod}"
											 disabled="#{!MbPersoMethodsSearch.pinRequiredOrPVKPresent}"
											 label="#{lblPrs.pvv_store_method}"
											 onblur="hideErrorField(this)">
								<f:selectItem itemValue=""/>
								<f:selectItems value="#{MbPersoMethodsSearch.pvvStoreMethods}"/>
							</h:selectOneMenu>
						</a4j:region>
						<h:outputFormat id="newpvvStoreMethodError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.pvv_store_method}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="* #{lblPrs.pin_store_method}: " title="#{lblPrs.pin_store_method}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0" id="pinStoreValue"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<a4j:region>
							<h:selectOneMenu id="newpinStoreMethod"
											 value="#{MbPersoMethodsSearch.newMethod.pinStoreMethod}"
											 disabled="#{!MbPersoMethodsSearch.pinRequiredOrPVKPresent}"
											 label="#{lblPrs.pin_store_method}"
											 onblur="hideErrorField(this)">
								<f:selectItem itemValue=""/>
								<f:selectItems value="#{MbPersoMethodsSearch.pinStoreMethods}"/>
							</h:selectOneMenu>
						</a4j:region>
						<h:outputFormat id="newpinStoreMethodError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.pin_store_method}"/>
						</h:outputFormat>
					</h:panelGrid>

					<a4j:outputPanel id="pvkIndexLabel" rendered="#{MbPersoMethodsSearch.advancedMode}">
						<h:outputLabel value="* #{lblPrs.pvk_index}: " title="#{lblPrs.pvk_index}"
									   rendered="#{MbPersoMethodsSearch.pinRequiredOrPVKPresent}"/>
						<h:outputLabel value="* #{lblPrs.pvk_index}: " title="#{lblPrs.pvk_index}"
									   rendered="#{!MbPersoMethodsSearch.pinRequiredOrPVKPresent}"/>
					</a4j:outputPanel>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0" id="pvkIndexValue"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<a4j:region>
							<h:inputText id="pvkIndex"
										 value="#{MbPersoMethodsSearch.newMethod.pvkIndex}"
										 rendered="#{MbPersoMethodsSearch.pinRequiredOrPVKPresent}"
										 label="#{lblPrs.pvk_index}"
										 onkeypress="if (!numbersOnly(this, event)) return false;"
										 maxlength="4"
										 onblur="hideErrorField(this)">
								<f:converter converterId="javax.faces.Integer"/>
								<a4j:support event="onchange" reRender="pvkIndexErr" limitToList="true" />
							</h:inputText>
							<h:inputText id="pvkIndexOpt"
										 value="#{MbPersoMethodsSearch.newMethod.pvkIndex}"
										 rendered="#{!MbPersoMethodsSearch.pinRequiredOrPVKPresent}"
										 disabled="true"
										 onkeypress="if (!numbersOnly(this, event)) return false;"
										 maxlength="4">
							</h:inputText>
						</a4j:region>
						<rich:message for="pvkIndex" id="pvkIndexErr" styleClass="errorMarker"
								rendered="#{MbPersoMethodsSearch.pinRequiredOrPVKPresent}"/>
						<h:outputFormat id="pvkIndexError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.pvk_index}"/>
						</h:outputFormat>
					</h:panelGrid>

					<h:outputLabel value="#{lblPrs.cvv_required}: " title="#{lblPrs.cvv_required_explained}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:selectBooleanCheckbox value="#{MbPersoMethodsSearch.newMethod.cvvRequired}"
											 rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					
					<h:outputLabel value="#{lblPrs.cvv2_required}: " title="#{lblPrs.cvv2_required_explained}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:selectBooleanCheckbox value="#{MbPersoMethodsSearch.newMethod.cvv2Required}"
											 rendered="#{MbPersoMethodsSearch.advancedMode}"/>

					<h:outputLabel value="#{lblPrs.icvv_required}: " title="#{lblPrs.icvv_required}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:selectBooleanCheckbox id="icvvFlag"
											 value="#{MbPersoMethodsSearch.newMethod.icvvRequired}"
											 rendered="#{MbPersoMethodsSearch.advancedMode}"/>

					<h:outputLabel value="#{lblPrs.dda_required}: " title="#{lblPrs.dda_required}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:selectBooleanCheckbox id="newDdaRequired"
											 value="#{MbPersoMethodsSearch.newMethod.ddaRequired}"
											 rendered="#{MbPersoMethodsSearch.advancedMode}"/>

					<h:outputLabel value="#{lblPrs.imk_index}: " title="#{lblPrs.imk_index}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<h:inputText id="newImkIndex"
								value="#{MbPersoMethodsSearch.newMethod.imkIndex}"
								maxlength="4" onkeypress="if (!numbersOnly(this, event)) return false;"
								converter="javax.faces.Integer"
								converterMessage="#{lblMsg.must_be_number}"/>
						<rich:message for="newImkIndex" styleClass="errorMarker"/>
					</h:panelGrid>

					<h:outputLabel value="#{lblPrs.decimalisation_table}: " title="#{lblPrs.decimalisation_table}"
								   styleClass="#{MbPersoMethodsSearch.showDecTable ? 'visibleRow' : 'hiddenRow'}"
								   id="decTableLabel"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid id="decTableCover"
								 columns="1" cellspacing="0" cellpadding="0"
								 styleClass="#{MbPersoMethodsSearch.showDecTable ? 'visibleRow' : 'hiddenRow'}"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<h:inputText id="newDecimTable"
									 value="#{MbPersoMethodsSearch.newMethod.decimalisationTable}"
									 rendered="#{MbPersoMethodsSearch.showDecTable}"
									 required="true"
									 label="#{lblPrs.decimalisation_table}"
									 maxlength="16"
									 onchange="hideErrorField(this)">
							<f:validateLength minimum="16" maximum="16"/>
						</h:inputText>
						<h:outputFormat id="newDecimTableError"
										value="#{lblMsg.value_request}"
										styleClass="errorMarker"
										style="display:none;">
							<f:param name="fieldName" value="#{lblPrs.decimalisation_table}"/>
						</h:outputFormat>
						<rich:message for="newDecimTable" styleClass="errorMarker"/>
					</h:panelGrid>

					<h:outputLabel value="#{lblPrs.max_script}: " title="#{lblPrs.max_script}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<h:inputText id="newMaxScript"
								value="#{MbPersoMethodsSearch.newMethod.maxScript}"
								maxlength="4" onkeypress="if (!numbersOnly(this, event)) return false;"
								converter="javax.faces.Integer"
								converterMessage="#{lblMsg.must_be_number}"/>
						<rich:message for="newMaxScript" styleClass="errorMarker"/>
					</h:panelGrid>

					<h:outputLabel value="#{lblPrs.pvk_component}: " title="#{lblPrs.pvk_component}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:selectOneMenu id="newPvkComponent"
									 value="#{MbPersoMethodsSearch.newMethod.pvkComponent}"
									 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<f:selectItem itemValue="" itemLabel=""/>
						<f:selectItems value="#{MbPersoMethodsSearch.pvkComponents}"/>
					</h:selectOneMenu>

					<h:outputLabel value="#{lblPrs.pvk_format}: " title="#{lblPrs.pvk_format}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:selectOneMenu id="newPvkFormat"
									 value="#{MbPersoMethodsSearch.newMethod.pvkFormat}"
									 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<f:selectItem itemValue="" itemLabel=""/>
						<f:selectItems value="#{MbPersoMethodsSearch.pvkFormats}"/>
					</h:selectOneMenu>

					<h:outputLabel value="#{lblPrs.module_length}: " title="#{lblPrs.module_length}"
								   rendered="#{MbPersoMethodsSearch.advancedMode}"/>
					<h:panelGrid columns="1" cellspacing="0" cellpadding="0"
								 rendered="#{MbPersoMethodsSearch.advancedMode}">
						<h:inputText id="newModuleLength"
									 value="#{MbPersoMethodsSearch.newMethod.moduleLength}"
									 maxlength="4"
									 onkeypress="if (!numbersOnly(this, event)) return false;"
									 validator="#{MbPersoMethodsSearch.validateModuleLength}"/>
						<rich:message for="newModuleLength" styleClass="errorMarker"/>
					</h:panelGrid>
				</h:panelGrid>
			</h:panelGroup>

			<h:panelGroup layout="block" styleClass="bottom_search_result_block_buttons">
				<h:panelGroup layout="block" styleClass="bottom_search_result_left_buttons">
					<h:panelGrid columns="4" columnClasses=",width99P,,,paddingR12">
						<bre:taggedCommandButton value="#{lblCommon.simple_mode}"
												 rendered="#{MbPersoMethodsSearch.advancedMode}"
												 limitToList="true"
												 oncomplete="returnFormFields()"
												 reRender="prsMethodEditForm">
							<a4j:actionparam name="inputMode" value="1" assignTo="#{MbPersoMethodsSearch.modalMode}"/>
						</bre:taggedCommandButton>

						<bre:taggedCommandButton value="#{lblCommon.advanced_mode}"
												 rendered="#{MbPersoMethodsSearch.simpleMode}"
												 limitToList="true"
												 oncomplete="returnFormFields()"
												 reRender="prsMethodEditForm">
							<a4j:actionparam name="inputMode" value="2" assignTo="#{MbPersoMethodsSearch.modalMode}"/>
						</bre:taggedCommandButton>

						<h:outputText/>

						<bre:taggedCommandButton value="#{lblForm.save}"
												 type="submit"
												 action="#{MbPersoMethodsSearch.save}"
												 onclick="if (!checkMethodFields()) {return false;}
												          disableModalPanelBtns(this);"
												 oncomplete="enableModalPanelBtns(this);
												             if (#{usession.noErrorResponse})
												             #{rich:component('prs_method_modal_panel')}.hide()"
												 reRender="#{rerenderList}"/>

						<bre:taggedCommandButton value="#{lblForm.cancel}"
												 onclick="#{rich:component('prs_method_modal_panel')}.hide();
												          return false;"/>
		    		</h:panelGrid>
		    	</h:panelGroup>
		    </h:panelGroup>
		</h:form>
	</rich:modalPanel>

    <ui:include src="/pages/utils/langConfirmPanel.jspx">
    	<ui:param name="backingBean" value="#{MbPersoMethodsSearch}"/>
    	<ui:param name="rerenderList" value="prsMethodEditForm:name"/>
    	<ui:param name="editElem" value="prsMethodEditForm:editLang"/>
    	<ui:param name="newValue" value="#{MbPersoMethodsSearch.newMethod.lang}"/>
    	<ui:param name="formName" value="prsMethodEditForm"/>
    </ui:include>

</ui:composition>
</html>