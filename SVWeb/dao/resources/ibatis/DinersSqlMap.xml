<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
		PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
		"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="diners">

	<sql id="limitationOpen">
		SELECT *
		FROM (
	</sql>

	<sql id="limitationOpenCount">
		SELECT count(*)
		FROM (
	</sql>

	<sql id="limitationClose">
		) q
		<isNotNull property="limitation" prepend=" WHERE ">$limitation$</isNotNull>
	</sql>
	<sql id="paginatedOpen">
		SELECT *
		FROM(
		SELECT a.*, rownum r
		FROM(
		<include refid="limitationOpen"/>
	</sql>

	<sql id="paginatedClose">
		<include refid="limitationClose"/>
		) a
		WHERE rownum <![CDATA[<]]>= (#range.end# + 1)
		)
		WHERE r >= (#range.start# + 1)
	</sql>

	<select id="get-fin-messages" parameterClass="qparams" resultClass="java.util.LinkedHashMap">
		SELECT *
		FROM DIN_UI_FIN_VW
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">lang = #filters[].value#</isEqual>
		</iterate>
	</select>

	<select id="get-fin-messages-count" parameterClass="qparams" resultClass="int">
		SELECT COUNT(1)
		FROM DIN_UI_FIN_VW
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">lang = #filters[].value#</isEqual>
		</iterate>
	</select>

	<insert id="register-file" parameterClass="map">
		INSERT INTO din_file(id, is_incoming, network_id, inst_id, file_date, is_rejected)
		VALUES (#id#, #is_incoming#, #network_id#, #inst_id#, #file_date#, #is_rejected#)
	</insert>

	<resultMap id="map-get-din-fin-messages"
			   class="ru.bpc.sv2.ps.diners.DinersFinMessage">
		<result column="id" property="id" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="status" property="status" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="status_desc" property="statusDesc" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="file_id" property="fileId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="record_number" property="recordNumber" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="is_reversal" property="isReversal" jdbcType="NUMBER" javaType="java.lang.Boolean"/>
		<result column="is_incoming" property="isIncoming" jdbcType="NUMBER" javaType="java.lang.Boolean"/>
		<result column="is_rejected" property="isReturned" jdbcType="NUMBER" javaType="java.lang.Boolean"/>
		<result column="is_invalid" property="isInvalid" jdbcType="NUMBER" javaType="java.lang.Boolean"/>
		<result column="batch_id" property="batchId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="seqno" property="sequenceNumber" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="network_id" property="networkId" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="network_name" property="networkName" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="inst_id" property="instituteId" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="inst_name" property="instituteName" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="sfter" property="sendInstitute" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="dfter" property="recvInstitute" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="dispute_id" property="disputeId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="refno" property="originatorRefnum" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="nrid" property="networkRefnum" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="card_id" property="cardId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="card_mask" property="cardNumber" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="typch" property="typeOfCharge" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="chtyp" property="chargeType" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="datyp" property="dateType" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="chgdt" property="chargeDate" jdbcType="DATE" javaType="java.util.Date"/>
		<result column="scdat" property="sttlDate" jdbcType="DATE" javaType="java.util.Date"/>
		<result column="lcdat" property="hostDate" jdbcType="DATE" javaType="java.util.Date"/>
		<result column="anbr" property="authCode" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="appcd" property="actionCode" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="camtr" property="operAmount" jdbcType="NUMBER" javaType="java.math.BigDecimal"/>
		<result column="curky" property="operCurrency" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="blamt" property="sttlAmount" jdbcType="NUMBER" javaType="java.math.BigDecimal"/>
		<result column="blcur" property="sttlCurrency" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="mcccd" property="mcc" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="senum" property="merchantNumber" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="estab" property="merchantName" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="estst" property="merchantStreet" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="lcity" property="merchantCity" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="estco" property="merchantState" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="geocd" property="merchantCountry" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="estzp" property="merchantPostalCode" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="estpn" property="merchantPhone" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="intes" property="merchantCode" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="atmid" property="terminalNumber" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="drate" property="transAmount" jdbcType="NUMBER" javaType="java.math.BigDecimal"/>
		<result column="acrky" property="alternativeCurrency" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="tax1" property="taxAmount1" jdbcType="NUMBER" javaType="java.math.BigDecimal"/>
		<result column="tax2" property="taxAmount2" jdbcType="NUMBER" javaType="java.math.BigDecimal"/>
		<result column="origd" property="documentNumber" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="lang" property="lang" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="file_name" property="fileName" jdbcType="VARCHAR" javaType="java.lang.String"/>
	</resultMap>

	<select id="get-din-fin-messages"
			parameterClass="qparams"
			resultMap="map-get-din-fin-messages">
		<include refid="paginatedOpen" />
		SELECT
			d.id
			, d.status
			, d.status_desc
			, d.file_id
			, d.record_number
			, d.is_reversal
			, d.is_incoming
			, d.is_rejected
			, d.is_invalid
			, d.batch_id
			, d.seqno
			, d.network_id
			, d.network_name
			, d.inst_id
			, d.inst_name
			, d.sfter
			, d.dfter
			, d.dispute_id
			, d.refno
			, d.nrid
			, d.card_id
			, ic.card_mask
			, d.typch
			, d.chtyp
			, d.datyp
			, d.chgdt
		    , to_date(d.scdat, 'YYMMDD') scdat
 		    , to_date(d.lcdat, 'YYMMDD') lcdat
			, d.anbr
			, d.appcd
			, d.camtr
			, d.curky
			, d.blamt
			, d.blcur
			, d.mcccd
			, d.senum
			, d.estab
			, d.estst
			, d.lcity
			, d.estco
			, d.geocd
			, d.estzp
			, d.estpn
			, d.intes
			, d.atmid
			, d.drate
			, d.acrky
			, d.tax1
			, d.tax2
			, d.origd
			, d.lang
			, d.file_name
		FROM
			din_ui_fin_vw d, iss_card_number c, iss_card ic
		WHERE
			d.card_id = c.card_id(+)
			and c.card_id = ic.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">d.id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">d.lang = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="cardNumber">reverse(c.card_number) like reverse(#filters[].value#)</isEqual>
			<isEqual property="filters[].element" compareValue="networkRefnum">d.nrid = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="fileName">d.file_name = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="hostDate">d.lcdat = #filters[].value#</isEqual>
		</iterate>
		<include refid="paginatedClose" />
	</select>

	<select id="get-din-fin-messages-count"
			parameterClass="qparams"
			resultClass="int">
		SELECT
			count(1)
		FROM
			din_ui_fin_vw d, iss_card_number c, iss_card ic
		WHERE
			d.card_id = c.card_id(+)
			and c.card_id = ic.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">d.id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">d.lang = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="cardNumber">reverse(c.card_number) like reverse(#filters[].value#)</isEqual>
			<isEqual property="filters[].element" compareValue="networkRefnum">d.nrid = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="fileName">d.file_name = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="hostDate">d.lcdat = #filters[].value#</isEqual>
		</iterate>
	</select>

	<resultMap id="map-din-fee"
			   class="ru.bpc.sv2.ps.diners.DinersFee">
		<result column="id" property="id"/>
		<result column="amount" property="amount"/>
		<result column="currency" property="currency"/>
		<result column="destination_currency" property="destinationCurrency"/>
		<result column="percent" property="percent"/>
		<result column="source_amount" property="sourceAmount"/>
		<result column="type" property="type"/>
	</resultMap>

	<select id="get-din-fees"
			parameterClass="qparams"
			resultMap="map-din-fee">
		SELECT
			  id
			, amount
			, currency
			, destination_currency
			, percent
			, source_amount
			, type
		FROM
			din_fee
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="amount">amount = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="currency">currency = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="destinationCurrency">destination_currency = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="percent">percent = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="sourceAmount">source_amount = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="type">type = #filters[].value#</isEqual>
		</iterate>
		<iterate prepend="ORDER BY" conjunction=", " property="sorting">
			<isNotEqual property="sorting[].direction" compareValue="AUTO">
				<isEqual property="sorting[].property" compareValue="id">id $sorting[].direction$</isEqual>
				<isEqual property="sorting[].property" compareValue="type">type $sorting[].direction$</isEqual>
			</isNotEqual>
		</iterate>
	</select>

	<select id="get-din-fees-count"
			parameterClass="qparams"
			resultClass="int">
		SELECT
			count(1)
		FROM
			din_fee
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="id">id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="amount">amount = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="currency">currency = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="destinationCurrency">destination_currency = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="percent">percent = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="sourceAmount">source_amount = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="type">type = #filters[].value#</isEqual>
		</iterate>
	</select>

	<resultMap id="map-get-din-addendums"
			   class="ru.bpc.sv2.ps.diners.DinersAddendum">
		<result column="addendum_id" property="id" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="fin_id" property="finMessageId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="function_code" property="funcCode" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="function_code_desc" property="funcCodeDesc" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="file_id" property="fileId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="record_number" property="recordNumber" jdbcType="NUMBER" javaType="java.lang.Integer"/>
	</resultMap>

	<select id="get-din-addendums"
			parameterClass="qparams"
			resultMap="map-get-din-addendums">
		SELECT
			  addendum_id
			, fin_id
			, function_code
			, function_code_desc
			, file_id
			, record_number
		FROM
			din_ui_addendum_vw
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="finMessageId">fin_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">lang = #filters[].value#</isEqual>
		</iterate>
		ORDER BY
			addendum_id ASC
	</select>

	<select id="get-din-addendums-count"
			parameterClass="qparams"
			resultClass="int">
		SELECT
			count(1)
		FROM
			din_ui_addendum_vw
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="finMessageId">fin_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">lang = #filters[].value#</isEqual>
		</iterate>
	</select>

	<resultMap id="map-get-din-addendum-fields"
			   class="ru.bpc.sv2.ps.diners.DinersAddendumField">
		<result column="field_name" property="name" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="field_desc" property="description" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="field_value" property="value" jdbcType="VARCHAR" javaType="java.lang.String"/>
	</resultMap>

	<select id="get-din-addendum-fields"
			parameterClass="qparams"
			resultMap="map-get-din-addendum-fields">
		SELECT
			  field_name
			, field_desc
			, field_value
		FROM
			din_ui_addendum_value_vw
		<iterate prepend="WHERE" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="addendumId">addendum_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="lang">lang = #filters[].value#</isEqual>
		</iterate>
		ORDER BY
			field_name ASC
	</select>

	<resultMap id="map-get-din-files"
			   class="ru.bpc.sv2.ps.diners.DinersFile">
		<result column="id" property="id" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="session_id" property="sessionId" jdbcType="NUMBER" javaType="java.lang.Long"/>
		<result column="file_name" property="fileName" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="file_date" property="fileDate" jdbcType="DATE" javaType="java.util.Date"/>
		<result column="is_incoming" property="isIncoming" jdbcType="NUMBER" javaType="java.lang.Boolean"/>
		<result column="is_rejected" property="isRejected" jdbcType="NUMBER" javaType="java.lang.Boolean"/>
		<result column="network_id" property="networkId" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="inst_id" property="instId" jdbcType="NUMBER" javaType="java.lang.Integer"/>
		<result column="inst_name" property="instName" jdbcType="VARCHAR" javaType="java.lang.String"/>
		<result column="recap_total" property="recapTotal" jdbcType="NUMBER" javaType="java.lang.Long"/>
	</resultMap>

	<select id="get-din-files"
			parameterClass="qparams"
			resultMap="map-get-din-files">
		<include refid="paginatedOpen"/>
		SELECT
		      d.id
			, f.session_id
			, f.file_name
			, d.file_date
			, d.is_incoming
			, d.is_rejected
			, d.network_id
			, d.inst_id
			, i.name AS inst_name
			, d.recap_total
		FROM
			  din_ui_file_vw d
			, prc_session_file f
			, ost_ui_institution_sys_vw i
		WHERE
			d.id = f.id(+)
		AND
			d.inst_id = i.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="lang">i.lang(+) = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="sessionId">f.session_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="fileName">f.file_name like #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="dateFrom">d.file_date >= TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
			<isEqual property="filters[].element" compareValue="dateTo">d.file_date <![CDATA[<=]]> TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
		</iterate>
		ORDER BY
			  f.session_id DESC
			, d.id DESC
		<include refid="paginatedClose"/>
	</select>

	<select id="get-din-files-count"
			parameterClass="qparams"
			resultClass="int">
		SELECT
			count(1)
		FROM
			  din_ui_file_vw d
			, prc_session_file f
			, ost_ui_institution_sys_vw i
		WHERE
			d.id = f.id(+)
		AND
			d.inst_id = i.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="lang">i.lang(+) = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="sessionId">f.session_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="fileName">f.file_name like #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="dateFrom">d.file_date >= TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
			<isEqual property="filters[].element" compareValue="dateTo">d.file_date <![CDATA[<=]]> TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
		</iterate>
	</select>

	<select id="get-din-file-fin-messages"
			parameterClass="qparams"
			resultMap="map-get-din-fin-messages">
		<include refid="paginatedOpen" />
		SELECT
			  d.id
			, d.status
			, d.status_desc
			, d.file_id
			, d.record_number
			, d.is_reversal
			, d.is_incoming
			, d.is_rejected
			, d.is_invalid
			, d.batch_id
			, d.seqno
			, d.network_id
			, d.network_name
			, d.inst_id
			, d.inst_name
			, d.sfter
			, d.dfter
			, d.dispute_id
			, d.refno
			, d.nrid
			, d.card_id
			, ic.card_mask
			, d.typch
			, d.chtyp
			, d.datyp
			, d.chgdt
			, to_date(d.scdat, 'YYMMDD') scdat
			, to_date(d.lcdat, 'YYMMDD') lcdat
			, d.anbr
			, d.appcd
			, d.camtr
			, d.curky
			, d.blamt
			, d.blcur
			, d.mcccd
			, d.senum
			, d.estab
			, d.estst
			, d.lcity
			, d.estco
			, d.geocd
			, d.estzp
			, d.estpn
			, d.intes
			, d.atmid
			, d.drate
			, d.acrky
			, d.tax1
			, d.tax2
			, d.origd
			, d.lang
			, d.file_name
		FROM
			  din_ui_fin_vw d
			, din_ui_file_vw f
			, iss_card ic
		WHERE
			d.file_id = f.id(+)
			and d.card_id = ic.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="lang">d.lang(+) = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="sessionId">f.session_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="fileName">f.file_name like #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="dateFrom">d.file_date >= TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
			<isEqual property="filters[].element" compareValue="dateTo">d.file_date <![CDATA[<=]]> TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
		</iterate>
		<include refid="paginatedClose" />
	</select>

	<select id="get-din-file-fin-messages-count"
			parameterClass="qparams"
			resultClass="int">
		SELECT
			count(1)
		FROM
			  din_ui_fin_vw d
			, din_ui_file_vw f
			, ost_ui_institution_sys_vw i
		WHERE
			d.file_id = f.id(+)
		<iterate prepend="AND" conjunction="AND" property="filters">
			<isEqual property="filters[].element" compareValue="lang">d.lang(+) = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="sessionId">f.session_id = #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="fileName">f.file_name like #filters[].value#</isEqual>
			<isEqual property="filters[].element" compareValue="dateFrom">d.file_date >= TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
			<isEqual property="filters[].element" compareValue="dateTo">d.file_date <![CDATA[<=]]> TO_DATE(#filters[].value#, 'DD.MM.YYYY')</isEqual>
		</iterate>
	</select>
</sqlMap>