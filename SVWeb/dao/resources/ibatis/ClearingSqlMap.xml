<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="clearing">

	<procedure id="process-operation"
			parameterClass="long">
		{call opr_api_process_pkg.process_operation(
			  i_operation_id	=> #value#
			, i_stage			=> 'PSTGCOMM'
			, i_mask_error		=> 0
	)}
	</procedure>
	
	<parameterMap class="java.util.Map" id="add-participant-map">
		<parameter property="operId" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="msgType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="operType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="participantType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="clientIdType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="clientIdValue" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="cardNumber" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="cardSeqNumber" javaType="java.lang.Integer" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="cardExpirDate" javaType="java.util.Date" jdbcType="DATE" mode="IN"/>
		<parameter property="instId" javaType="java.lang.Integer" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="networkId" javaType="java.lang.Integer" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="authCode" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="accountNumber" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="accountAmount" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN" />
		<parameter property="accountCurrency" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="cardMask" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="cardId" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="cardInstanceId" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="cardCountry" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
	</parameterMap>
	
	<procedure id="add-participant"
			parameterMap="add-participant-map">
		{call opr_api_create_pkg.add_participant(
				  i_oper_id             => ?
				, i_msg_type            => ?
				, i_oper_type           => ?	
				, i_participant_type	=> ?		
				, i_client_id_type  	=> ?
				, i_client_id_value 	=> ?
				, i_card_number		 	=> ?
				, i_card_seq_number		=> ?
				, i_card_expir_date		=> ?
				, i_inst_id		 		=> ?
				, i_network_id		 	=> ?
				, i_auth_code		 	=> ?
				, i_account_number		=> ?
				, i_account_amount		=> ?
				, i_account_currency	=> ?
				, i_card_mask           => ?
				, i_card_id           	=> ?
				, i_card_instance_id    => ?
				, i_card_country        => ?
				)}
	</procedure>
	
	<parameterMap class="java.util.Map" id="add-operation-map">
		<parameter property="operId" javaType="java.lang.Long" jdbcType="NUMERIC" mode="INOUT"/>
		<parameter property="isReversal" javaType="java.lang.Integer" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="operType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="operReason" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="msgType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="status" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="statusReason" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="sttlType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="terminalType" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="acqInstBin" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantNumber" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="terminalNumber" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantName" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantStreet" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantCity" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantRegion" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantCountry" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="merchantPostcode" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="mcc" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="originatorRefnum" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="networkRefnum" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="operCount" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="operRequestAmountAmountValue" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="operAmountAmountValue" javaType="java.lang.Long" jdbcType="NUMERIC" mode="IN"/>
		<parameter property="operAmountCurrency" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="operDate" javaType="java.util.Date" jdbcType="DATE"  mode="IN"  />
		<parameter property="hostDate" javaType="java.util.Date" jdbcType="DATE"  mode="IN" />
		<parameter property="originalId" javaType="java.lang.Long" jdbcType="NUMERIC"  mode="IN" />
		<parameter property="operSurchargeAmount" javaType="java.lang.Long" jdbcType="NUMERIC"  mode="IN" />
		<parameter property="operCashbackAmount" javaType="java.lang.Long" jdbcType="NUMERIC"  mode="IN" />
		<parameter property="sttlAmount" javaType="java.lang.Long" jdbcType="NUMERIC"  mode="IN" />
		<parameter property="sttlCurrency" javaType="java.lang.String" jdbcType="NUMERIC"  mode="IN" />
		<parameter property="interchangeFeeAmount" javaType="java.lang.Long" jdbcType="NUMERIC"  mode="IN" />
		<parameter property="interchangeFeeCurrency" javaType="java.lang.String" jdbcType="VARCHAR"  mode="IN" />
		<parameter property="forwardingInstBin" javaType="java.lang.String" jdbcType="VARCHAR"  mode="IN" />
		<parameter property="sttlDate" javaType="java.util.Date" jdbcType="DATE"  mode="IN" />
		<parameter property="acqSttlDate" javaType="java.util.Date" jdbcType="DATE"  mode="IN" />
		<parameter property="matchStatus" javaType="java.lang.String" jdbcType="VARCHAR"  mode="IN" />

	</parameterMap>
	
	<procedure id="add-operation"
			parameterMap="add-operation-map">
		{call opr_api_create_pkg.create_operation(
				 io_oper_id                    => ?
			    , i_is_reversal                => ?
			    , i_oper_type                  => ?
			    , i_oper_reason                => ?
			    , i_msg_type    			   => ?
			    , i_status  			       => ?
			    , i_status_reason	 		   => ?
			    , i_sttl_type     			   => ?
			    , i_terminal_type              => ?
			    , i_acq_inst_bin               => ?
			    , i_merchant_number            => ?
			    , i_terminal_number            => ?
			    , i_merchant_name              => ?
			    , i_merchant_street            => ?
			    , i_merchant_city              => ?
			    , i_merchant_region            => ?
			    , i_merchant_country           => ?
			    , i_merchant_postcode          => ?
			    , i_mcc                        => ?
			    , i_originator_refnum          => ?
			    , i_network_refnum             => ?
				, i_oper_count 				   => ?
			    , i_oper_request_amount        => ?
			    , i_oper_amount                => ?
			    , i_oper_currency              => ?
			    , i_oper_date                  => ?
			    , i_host_date                  => ?
				, i_original_id                => ?
				, i_oper_surcharge_amount      => ?
				, i_oper_cashback_amount       => ?
				, i_sttl_amount                => ?
				, i_sttl_currency              => ?
				, i_fee_amount     			   => ?
				, i_fee_currency   			   => ?
				, i_forw_inst_bin              => ?
				, i_sttl_date                  => ?
				, i_acq_sttl_date              => ?
				, i_match_status               => ?
				)}
	</procedure>


    <insert id="add-additional-amount" parameterClass="map">
		INSERT INTO opr_additional_amount(oper_id, amount_type, currency, amount)
		VALUES(#oper_id#, #amount_type#, #amount_currency#, #amount#)
	</insert>

	<select id="get-oper-result"
			parameterClass="long"
			resultClass="ru.bpc.sv.svxp.clearing.OperationResult">
		select id               as operId
			 , status           as status
			 , status_reason    as statusReason
		  from opr_operation
		 where id = #value#
	</select>

	<select id="get-oper-results"
			parameterClass="list"
			resultClass="ru.bpc.sv.svxp.clearing.OperationResult">
		select id               as operId
			 , status           as status
			 , status_reason    as statusReason
		  from opr_operation
		 where id in
			<iterate open="(" close=")" conjunction=",">
				#[]#
			</iterate>
	</select>
</sqlMap>    
